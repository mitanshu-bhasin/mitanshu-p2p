<!DOCTYPE html>
<html lang="en">

<head>
    <!-- 
      MITANSHU P2P ENGINE - ENTERPRISE SUITE v14.0 (Chess & Multi-Peer Edition)
      Architect: Mitanshu Bhasin (Cyber Hygiene Practitioner & Python Elite)
      Status: Stable | Multi-Peer | Chess | Voice Chat | High Security
    -->
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#f8fafc">
    <title>MITANSHU P2P | Enterprise</title>

    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link rel="preload" href="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js" as="script">
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="https://p2p-mitanshu.netlify.app/favicon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        media="print" onload="this.media='all'">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/alasql@4" defer></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js" defer></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        corp: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', 600: '#475569', 500: '#64748b', accent: '#2563eb' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'ring': 'ring 2s infinite ease-in-out',
                        'float': 'float 3s ease-in-out infinite',
                        'slide-in': 'slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1)'
                    },
                    keyframes: {
                        ring: {
                            '0%, 100%': { transform: 'rotate(0deg)' },
                            '10%, 30%, 50%, 70%, 90%': { transform: 'rotate(-10deg)' },
                            '20%, 40%, 60%, 80%': { transform: 'rotate(10deg)' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        slideIn: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap');

        body {
            background: #f8fafc;
            color: #1e293b;
            font-family: 'Inter', sans-serif;
            height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        @media (min-width: 768px) {
            .glass-panel {
                background: rgba(255, 255, 255, 0.85);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.05);
            }
        }

        .view-section {
            transition: opacity 0.2s ease-in-out;
            content-visibility: auto;
            contain-intrinsic-size: 1px 5000px;
        }

        .btn-active {
            @apply bg-blue-600 text-white shadow-lg shadow-blue-200;
        }

        .btn-inactive {
            @apply text-slate-400 hover:bg-slate-100;
        }

        /* PERFORMANCE & EASE OF USE */
        html {
            overscroll-behavior-y: contain;
            /* Prevent Pull-to-Refresh */
            scroll-behavior: smooth;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        input,
        textarea,
        [contenteditable="true"] {
            user-select: text;
        }

        video {
            transform: translateZ(0);
            /* Force GPU acceleration */
            backface-visibility: hidden;
        }

        .ttt-cell {
            transition: all 0.2s;
        }

        .ttt-cell:active {
            transform: scale(0.95);
        }

        .chess-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            border: 4px solid #475569;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            background: #cbd5e1;
            aspect-ratio: 1;
        }

        .chess-sq {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.8rem, 5vw, 3rem);
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chess-sq:hover {
            filter: brightness(1.05);
            z-index: 10;
        }

        .chess-sq-light {
            background: #f1f5f9;
        }

        .chess-sq-dark {
            background: #cbd5e1;
        }

        .chess-sq-selected {
            box-shadow: inset 0 0 0 4px #2563eb !important;
            background: #bfdbfe !important;
        }

        .chess-sq-valid::after {
            content: '';
            position: absolute;
            width: 25%;
            height: 25%;
            border-radius: 50%;
            background: rgba(37, 99, 235, 0.3);
            pointer-events: none;
        }

        .chess-sq-capture {
            box-shadow: inset 0 0 0 4px rgba(239, 68, 68, 0.4) !important;
        }

        .chess-sq-check {
            animation: checkPulse 1s infinite;
            background: #fee2e2 !important;
        }

        @keyframes checkPulse {

            0%,
            100% {
                box-shadow: inset 0 0 15px 5px rgba(239, 68, 68, 0.5);
            }

            50% {
                box-shadow: inset 0 0 25px 10px rgba(239, 68, 68, 0.7);
            }
        }

        .chess-piece-w {
            color: #ffffff;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            -webkit-text-stroke: 1px rgba(0, 0, 0, 0.1);
            text-shadow: 0 0 1px rgba(0, 0, 0, 0.5);
            font-weight: 900;
        }

        .chess-piece-b {
            color: #0f172a;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
            font-weight: 900;
        }

        .voice-recording {
            animation: voicePulse 1.2s infinite;
        }

        @keyframes voicePulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }

        .fullscreen-container {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fullscreen-active {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100dvh !important;
            z-index: 9999 !important;
            border-radius: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            max-width: none !important;
        }

        .fullscreen-active .chess-board {
            max-width: min(90vw, 90vh) !important;
            width: min(90vw, 90vh) !important;
        }

        #view-code.fullscreen-active {
            display: flex !important;
            z-index: 9999 !important;
        }

        .secure-badge-voice {
            background: linear-gradient(135deg, #059669, #10b981);
            animation: securePulse 2s infinite;
        }

        @keyframes securePulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.3);
            }

            50% {
                box-shadow: 0 0 0 4px rgba(16, 185, 129, 0);
            }
        }

        .voice-wave {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            height: 16px;
        }

        .voice-wave span {
            display: inline-block;
            width: 3px;
            background: currentColor;
            border-radius: 2px;
            animation: waveBar 0.8s ease-in-out infinite;
        }

        .voice-wave span:nth-child(2) {
            animation-delay: 0.1s;
        }

        .voice-wave span:nth-child(3) {
            animation-delay: 0.2s;
        }

        .voice-wave span:nth-child(4) {
            animation-delay: 0.3s;
        }

        @keyframes waveBar {

            0%,
            100% {
                height: 4px;
            }

            50% {
                height: 16px;
            }
        }
    </style>
</head>

<body class="flex flex-col md:flex-row bg-slate-50 relative">

    <div
        class="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-100/50 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none z-0">
    </div>

    <div class="relative z-10 w-full h-full flex flex-col md:flex-row p-2 md:p-4 gap-3 max-w-[1920px] mx-auto">

        <!-- MOBILE HEADER -->
        <div
            class="md:hidden flex justify-between items-center px-2 py-2 bg-white rounded-2xl shadow-sm border border-slate-200 shrink-0">
            <div class="flex items-center gap-3">
                <button onclick="toggleMobileNav(true)"
                    class="w-10 h-10 rounded-xl bg-slate-50 border border-slate-200 text-slate-700 flex items-center justify-center shadow-sm active:scale-95 transition-transform">
                    <i class="fas fa-bars text-lg"></i>
                </button>
                <div class="flex items-center gap-2">
                    <div
                        class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold shadow-md text-sm">
                        M</div>
                    <span class="font-black text-slate-800 text-sm tracking-tight">MITANSHU <span
                            class="text-blue-600">P2P</span></span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div id="ping-mobile" class="text-[10px] font-mono text-slate-400 font-bold px-2"></div>
                <a href="index.html"
                    class="w-9 h-9 rounded-xl bg-slate-50 border border-slate-200 text-slate-500 hover:text-blue-600 hover:border-blue-300 flex items-center justify-center shadow-sm active:scale-95 transition-all"
                    title="AI Home"><i class="fas fa-home text-sm"></i></a>
                <a href="faq.html"
                    class="w-9 h-9 rounded-xl bg-slate-50 border border-slate-200 text-slate-500 hover:text-blue-600 hover:border-blue-300 flex items-center justify-center shadow-sm active:scale-95 transition-all"
                    title="FAQ & Help"><i class="fas fa-question text-sm"></i></a>
            </div>
        </div>

        <!-- SIDEBAR -->
        <nav
            class="glass-panel hidden md:flex w-20 h-full rounded-2xl flex-col items-center justify-between p-2 z-30 shrink-0 shadow-none overflow-visible">
            <div class="flex flex-col items-center gap-4 mt-2">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-200 hover:scale-105 transition cursor-pointer"
                    onclick="switchTab('dashboard')">
                    <span class="font-black text-white">M</span>
                </div>
            </div>

            <div class="flex flex-col gap-2 w-full justify-center px-0">
                <button onclick="switchTab('dashboard')" id="nav-dashboard"
                    class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-active min-w-[50px]"
                    title="Dashboard"><i class="fas fa-home text-lg"></i></button>
                <button onclick="switchTab('chat')" id="nav-chat"
                    class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-inactive min-w-[50px]"
                    title="Secure Chat"><i class="fas fa-comment-alt text-lg"></i></button>
                <button onclick="switchTab('video')" id="nav-video"
                    class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-inactive min-w-[50px]"
                    title="Video/Screen"><i class="fas fa-video text-lg"></i></button>
                <button onclick="switchTab('map')" id="nav-map"
                    class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-inactive min-w-[50px]"
                    title="Live GPS Map"><i class="fas fa-map-marked-alt text-lg"></i></button>
                <button onclick="switchTab('files')" id="nav-files"
                    class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-inactive min-w-[50px] relative"
                    title="File Transfer Swarm">
                    <i class="fas fa-folder-open text-lg"></i>
                    <span class="absolute top-1 right-1 flex h-2.5 w-2.5">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                        <span
                            class="relative inline-flex rounded-full h-2.5 w-2.5 bg-blue-600 border border-white"></span>
                    </span>
                </button>
                <button onclick="switchTab('code')" id="nav-code"
                    class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-inactive min-w-[50px]"
                    title="Code Studio"><i class="fas fa-code text-lg"></i></button>
                <button onclick="switchTab('games')" id="nav-games"
                    class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-inactive min-w-[50px]"
                    title="Gaming Hub"><i class="fas fa-gamepad text-lg"></i></button>
                <button onclick="switchTab('browse')" id="nav-browse"
                    class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-inactive min-w-[50px]"
                    title="Browse Share"><i class="fas fa-globe text-lg"></i></button>
                <button onclick="switchTab('board')" id="nav-board"
                    class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-inactive min-w-[50px]"
                    title="Whiteboard"><i class="fas fa-paint-brush text-lg"></i></button>
                <button onclick="switchTab('media')" id="nav-media"
                    class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-inactive min-w-[50px]"
                    title="Watch Party"><i class="fas fa-film text-lg"></i></button>
                <button onclick="switchTab('tasks')" id="nav-tasks"
                    class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-inactive min-w-[50px]"
                    title="Tasks"><i class="fas fa-check-square text-lg"></i></button>
            </div>

            <div class="flex flex-col items-center gap-4 mb-2">
                <div id="ping-indicator" class="text-[9px] font-mono text-slate-400 font-bold hidden">0ms</div>
            </div>
        </nav>

        <!-- MOBILE NAV DRAWER -->
        <div id="mobile-nav" class="fixed inset-0 z-[150] hidden">
            <div onclick="toggleMobileNav(false)"
                class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm w-full h-full transition-opacity"></div>
            <div
                class="absolute top-0 left-0 h-full w-[280px] bg-white shadow-2xl border-r border-slate-200 p-5 flex flex-col animate-slide-in">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black shadow-md text-lg">
                            M</div>
                        <div>
                            <div class="text-sm font-black text-slate-800 tracking-tight">MITANSHU P2P</div>
                            <div class="text-[10px] font-mono text-slate-400 uppercase font-bold">Main Menu</div>
                        </div>
                    </div>
                    <button onclick="toggleMobileNav(false)"
                        class="w-9 h-9 rounded-xl bg-slate-50 border border-slate-200 text-slate-700 flex items-center justify-center active:bg-slate-200 transition">
                        <i class="fas fa-xmark"></i>
                    </button>
                </div>

                <div class="flex flex-col gap-3 overflow-y-auto pb-4">
                    <button onclick="switchTab('dashboard')"
                        class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i
                            class="fas fa-home w-6 text-center text-slate-400 text-lg"></i> Dashboard</button>
                    <button onclick="switchTab('chat')"
                        class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i
                            class="fas fa-comment-alt w-6 text-center text-slate-400 text-lg"></i> Secure Chat</button>
                    <button onclick="switchTab('video')"
                        class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i
                            class="fas fa-video w-6 text-center text-slate-400 text-lg"></i> Video & Screen</button>
                    <button onclick="switchTab('map')"
                        class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i
                            class="fas fa-map-marked-alt w-6 text-center text-slate-400 text-lg"></i> Live GPS</button>
                    <button onclick="switchTab('files')"
                        class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i
                            class="fas fa-folder-open w-6 text-center text-slate-400 text-lg"></i> Transfer
                        Files</button>
                    <button onclick="switchTab('code')"
                        class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i
                            class="fas fa-code w-6 text-center text-slate-400 text-lg"></i> Code Studio</button>
                    <button onclick="switchTab('games')"
                        class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i
                            class="fas fa-gamepad w-6 text-center text-slate-400 text-lg"></i> Gaming Hub</button>
                    <button onclick="switchTab('browse')"
                        class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i
                            class="fas fa-globe w-6 text-center text-slate-400 text-lg"></i> Browse Share</button>
                    <button onclick="switchTab('board')"
                        class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i
                            class="fas fa-paint-brush w-6 text-center text-slate-400 text-lg"></i> Whiteboard</button>
                    <button onclick="switchTab('media')"
                        class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i
                            class="fas fa-film w-6 text-center text-slate-400 text-lg"></i> Watch Party</button>
                    <button onclick="switchTab('tasks')"
                        class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i
                            class="fas fa-check-square w-6 text-center text-slate-400 text-lg"></i> Task Board</button>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <main
            class="flex-1 h-full relative overflow-hidden rounded-[2rem] glass-panel flex flex-col shadow-sm md:shadow-xl shrink-1">

            <header
                class="hidden md:flex px-6 py-4 border-b border-slate-100 justify-between items-center bg-white/50 backdrop-blur-sm z-20 relative">
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-800 flex items-center gap-2">
                        MITANSHU <span class="text-blue-600">P2P</span> ENTERPRISE
                        <span
                            class="px-2 py-0.5 rounded text-[10px] bg-blue-100 text-blue-700 border border-blue-200 uppercase font-mono tracking-wide">v13.3
                            P2P</span>
                    </h1>
                    <p class="text-[10px] text-slate-500 font-mono tracking-wider mt-0.5 uppercase">Architect: Mitanshu
                        Bhasin | Status: <span id="sys-status">Ready</span></p>
                </div>
                <div class="flex items-center gap-3">
                    <div id="peer-count-badge"
                        class="hidden flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-blue-50 border border-blue-100 text-blue-600 text-xs font-bold font-mono">
                        <i class="fas fa-users text-[10px]"></i> <span id="peer-count">0</span> Peers
                    </div>
                    <div id="security-badge"
                        class="hidden flex items-center gap-1.5 px-2.5 py-1.5 rounded-full bg-emerald-50 border border-emerald-100 text-emerald-600 text-[10px] font-bold font-mono">
                        <i class="fas fa-shield-halved"></i> E2E
                    </div>
                    <a href="faq.html" title="FAQ & Help"
                        class="w-9 h-9 rounded-full bg-slate-100 border border-slate-200 text-slate-500 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition flex items-center justify-center">
                        <i class="fas fa-question text-sm"></i>
                    </a>
                    <div id="connection-status"
                        class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-50 border border-red-100 text-red-600 text-xs font-bold font-mono transition-all">
                        <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> OFFLINE
                    </div>
                </div>
            </header>

            <!-- DASHBOARD, CHAT, VIDEO, MAP, FILES, CODE remain unchanged structurally -->
            <div id="view-dashboard" class="view-section flex-1 p-4 md:p-8 overflow-y-auto bg-white/60">
                <div class="max-w-5xl mx-auto flex flex-col gap-6 md:gap-8 h-full">
                    <div class="flex flex-col md:flex-row gap-6 md:gap-8 items-center justify-between mt-2 md:mt-4">
                        <div class="space-y-4 md:w-1/2 text-center md:text-left animate-[fadeIn_0.5s]">
                            <h2
                                class="text-4xl md:text-6xl font-black italic text-slate-800 tracking-tighter leading-none">
                                ENGINEERING <br><span class="text-blue-600">EXCELLENCE</span>
                            </h2>
                            <p
                                class="text-slate-500 text-sm md:text-lg font-medium leading-relaxed max-w-sm mx-auto md:mx-0">
                                Direct Peer-to-Peer Encrypted Suite. Multi-Connected Hub Integrated.
                            </p>
                            <div id="auto-connect-msg"
                                class="hidden text-sm text-blue-600 font-bold bg-blue-50 p-2 rounded-lg border border-blue-200 inline-block animate-pulse mt-2">
                                <i class="fas fa-link mr-1"></i> Joining Shared Link...
                            </div>
                        </div>

                        <div
                            class="bg-white border border-slate-200 p-5 md:p-6 rounded-[2rem] shadow-xl shadow-slate-200/50 w-full md:w-1/2 space-y-5 relative overflow-hidden group">
                            <div
                                class="absolute -top-4 -right-4 p-4 opacity-5 group-hover:opacity-10 transition pointer-events-none">
                                <i class="fas fa-network-wired text-9xl text-blue-600"></i>
                            </div>
                            <div class="relative z-10">
                                <label
                                    class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">My
                                    Name (Optional)</label>
                                <input type="text" id="user-name" placeholder="Enter your name..." maxlength="15"
                                    class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm font-bold outline-none focus:border-blue-500 focus:bg-white transition mb-3">

                                <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4 flex flex-col gap-2">
                                    <div class="relative flex items-center justify-center">
                                        <div id="my-id"
                                            class="w-full font-mono text-xs md:text-sm text-blue-700 font-bold select-all truncate text-center bg-white py-3 px-10 rounded-xl border border-blue-100 shadow-inner">
                                            <i class="fas fa-circle-notch fa-spin mr-2 text-slate-400"></i>
                                            Initializing...
                                        </div>
                                        <button id="btn-copy-id" onclick="haptic(30)"
                                            class="absolute right-2 text-blue-400 hover:text-blue-600 p-2 transition active:scale-90"
                                            title="Copy ID">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                    <button onclick="haptic(20); copyMyLink()"
                                        class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold transition flex items-center justify-center gap-2 shadow-lg shadow-blue-200 active:scale-95">
                                        <i class="fas fa-share-square"></i> Share Link
                                    </button>
                                </div>
                            </div>
                            <div class="relative z-10">
                                <div class="flex items-center gap-4 my-2">
                                    <div class="h-px bg-slate-200 flex-1"></div>
                                    <span
                                        class="text-[10px] font-black text-slate-400 uppercase tracking-widest">OR</span>
                                    <div class="h-px bg-slate-200 flex-1"></div>
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" id="remote-id" placeholder="Paste Peer ID Here"
                                        class="flex-1 bg-slate-50 border border-slate-200 rounded-xl p-3 font-mono text-sm outline-none focus:border-blue-500 focus:bg-white transition shadow-inner">
                                    <button onclick="connectToPeer()"
                                        class="px-6 bg-slate-800 text-white rounded-xl font-bold text-sm hover:bg-slate-900 transition shadow-lg active:scale-95">LINK</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 md:gap-4 pb-6 mt-4">
                        <div onclick="switchTab('chat')"
                            class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-blue-400 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col items-center text-center">
                            <div
                                class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center mb-2 shadow-sm">
                                <i class="fas fa-comment-alt text-lg"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 text-xs md:text-sm">Secure Chat</h4>
                        </div>
                        <div onclick="switchTab('video')"
                            class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-purple-400 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col items-center text-center">
                            <div
                                class="w-12 h-12 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center mb-2 shadow-sm">
                                <i class="fas fa-video text-lg"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 text-xs md:text-sm">Video Call</h4>
                        </div>
                        <div onclick="switchTab('map')"
                            class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-emerald-400 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col items-center text-center">
                            <div
                                class="w-12 h-12 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center mb-2 shadow-sm">
                                <i class="fas fa-map-marked-alt text-lg"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 text-xs md:text-sm">Live GPS Map</h4>
                        </div>
                        <div onclick="switchTab('files')"
                            class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-orange-400 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col items-center text-center">
                            <div
                                class="w-12 h-12 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center mb-2 shadow-sm">
                                <i class="fas fa-folder-open text-lg"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 text-xs md:text-sm">File Transfer</h4>
                        </div>
                        <div onclick="switchTab('code')"
                            class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-indigo-400 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col items-center text-center">
                            <div
                                class="w-12 h-12 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center mb-2 shadow-sm">
                                <i class="fas fa-code text-lg"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 text-xs md:text-sm">Code Studio</h4>
                        </div>
                        <div onclick="switchTab('games')"
                            class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-yellow-400 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col items-center text-center">
                            <div
                                class="w-12 h-12 rounded-full bg-yellow-50 text-yellow-600 flex items-center justify-center mb-2 shadow-sm">
                                <i class="fas fa-gamepad text-lg"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 text-xs md:text-sm">P2P Games</h4>
                        </div>
                        <div onclick="switchTab('browse')"
                            class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-cyan-400 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col items-center text-center">
                            <div
                                class="w-12 h-12 rounded-full bg-cyan-50 text-cyan-600 flex items-center justify-center mb-2 shadow-sm">
                                <i class="fas fa-globe text-lg"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 text-xs md:text-sm">Browse Share</h4>
                        </div>
                        <div onclick="switchTab('board')"
                            class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-pink-400 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col items-center text-center">
                            <div
                                class="w-12 h-12 rounded-full bg-pink-50 text-pink-600 flex items-center justify-center mb-2 shadow-sm">
                                <i class="fas fa-paint-brush text-lg"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 text-xs md:text-sm">Whiteboard</h4>
                        </div>
                        <div onclick="switchTab('media')"
                            class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-rose-400 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col items-center text-center">
                            <div
                                class="w-12 h-12 rounded-full bg-rose-50 text-rose-600 flex items-center justify-center mb-2 shadow-sm">
                                <i class="fas fa-film text-lg"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 text-xs md:text-sm">Watch Party</h4>
                        </div>
                        <div onclick="switchTab('tasks')"
                            class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-lime-400 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col items-center text-center">
                            <div
                                class="w-12 h-12 rounded-full bg-lime-50 text-lime-600 flex items-center justify-center mb-2 shadow-sm">
                                <i class="fas fa-check-square text-lg"></i>
                            </div>
                            <h4 class="font-bold text-slate-800 text-xs md:text-sm">Task Board</h4>
                        </div>
                    </div>

                    <!-- MESH HEALTH DASHBOARD -->
                    <div id="peer-network-section" class="mt-8 animate-[fadeIn_0.5s] delay-300">
                        <div class="flex items-center justify-between mb-4">
                            <h3
                                class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-2">
                                <i class="fas fa-network-wired text-blue-400"></i> Mesh Performance Center
                            </h3>
                            <button onclick="startPingLoop()"
                                class="text-[10px] font-black text-blue-600 hover:text-blue-700 transition flex items-center gap-1">
                                <i class="fas fa-sync-alt"></i> REFRESH MESH
                            </button>
                        </div>
                        <div id="peer-mesh-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Me Card -->
                            <div
                                class="bg-white border-2 border-slate-200 p-4 rounded-2xl shadow-sm flex items-center gap-4 group hover:border-blue-400 transition-all">
                                <div
                                    class="w-10 h-10 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center shrink-0 font-black text-lg">
                                    H</div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-xs font-black text-slate-800 truncate uppercase mt-1"
                                        id="mesh-me-name">You (Local)</div>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span
                                            class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_#10b981]"></span>
                                        <span
                                            class="text-[9px] font-bold text-slate-400 font-mono tracking-tighter uppercase">Mesh
                                            Hub Node</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- LEGAL FOOTER -->
                    <div class="mt-auto mb-4 flex flex-col items-center gap-4 pt-12 border-t border-slate-100/50">
                        <div
                            class="flex items-center justify-center gap-6 text-[10px] font-bold uppercase tracking-widest text-slate-400">
                            <a href="privacy.html" class="hover:text-blue-600 transition flex items-center gap-1.5"><i
                                    class="fas fa-fingerprint text-[12px]"></i> Privacy</a>
                            <a href="terms.html" class="hover:text-blue-600 transition flex items-center gap-1.5"><i
                                    class="fas fa-file-invoice text-[12px]"></i> Terms</a>
                            <a href="license.html" class="hover:text-blue-600 transition flex items-center gap-1.5"><i
                                    class="fas fa-home text-[12px]"></i> License</a>
                            <a href="faq.html" class="hover:text-amber-500 transition flex items-center gap-1.5"><i
                                    class="fas fa-book-open text-[12px]"></i> Documentation</a>
                        </div>
                        <div
                            class="inline-flex items-center gap-2 px-4 py-1.5 bg-slate-50 border border-slate-200 rounded-full scale-90 md:scale-100">
                            <span class="text-[9px] font-black text-slate-800 uppercase tracking-tighter">Developed by
                                <span class="text-blue-600">Mitanshu Bhasin</span> ❤️</span>
                        </div>
                        <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest">MITANSHU P2P
                            Enterprise &bull; SECURE BY DESIGN</p>
                    </div>
                </div>
            </div>

            <!-- CHAT VIEW -->
            <div id="view-chat" class="view-section hidden flex-1 flex flex-col h-full bg-white relative">
                <div
                    class="p-4 border-b border-slate-100 flex justify-between items-center bg-white/80 backdrop-blur-md z-10 shrink-0">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center border border-blue-100">
                            <i class="fas fa-lock text-lg"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-800 text-sm">Encrypted Channel</h3>
                            <p class="text-[10px] text-emerald-600 font-bold flex items-center gap-1.5"><span
                                    class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span> End-to-End
                                Secure</p>
                        </div>
                    </div>
                    <button onclick="document.getElementById('chat-container').innerHTML=''"
                        class="w-8 h-8 rounded-full text-slate-400 hover:bg-red-50 hover:text-red-500 transition flex items-center justify-center"><i
                            class="fas fa-trash-alt"></i></button>
                </div>
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/50"></div>
                <div class="p-3 md:p-4 border-t border-slate-200 bg-white shrink-0">
                    <div
                        class="flex gap-2 bg-slate-50 p-1.5 rounded-2xl border border-slate-200 focus-within:border-blue-400 focus-within:shadow-md transition">
                        <input type="text" id="chat-input" placeholder="Type a message or paste a link..."
                            class="flex-1 px-3 py-2 text-sm outline-none bg-transparent"
                            onkeypress="if(event.key==='Enter') sendMsg()">
                        <input type="file" id="chat-file-input" class="hidden" onchange="sendMediaMsg()">
                        <button onclick="document.getElementById('chat-file-input').click()"
                            class="bg-slate-100 text-slate-500 w-10 h-10 rounded-xl hover:bg-slate-200 hover:text-blue-600 active:scale-95 transition flex items-center justify-center"
                            title="Attach Media"><i class="fas fa-plus"></i></button>
                        <button id="voice-btn" onmousedown="startVoiceRec()" onmouseup="stopVoiceRec()"
                            ontouchstart="startVoiceRec()" ontouchend="stopVoiceRec()"
                            class="bg-slate-200 text-slate-600 w-10 h-10 rounded-xl hover:bg-red-100 hover:text-red-500 active:scale-95 transition flex items-center justify-center"
                            title="Hold to Record Voice"><i class="fas fa-microphone"></i></button>
                        <button onclick="sendMsg()"
                            class="bg-blue-600 text-white w-10 h-10 rounded-xl shadow-md hover:bg-blue-700 active:scale-95 transition flex items-center justify-center"><i
                                class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <!-- VIDEO VIEW -->
            <div id="view-video"
                class="view-section hidden flex-1 flex flex-col h-full bg-slate-900 relative overflow-hidden rounded-b-[2rem] md:rounded-bl-none fullscreen-container">
                <div class="absolute inset-0 flex items-center justify-center bg-slate-900 p-2 md:p-4">
                    <!-- Dynamic Video Grid -->
                    <div id="video-grid"
                        class="w-full h-full grid gap-2 md:gap-4 grid-cols-1 grid-rows-1 transition-all duration-500">
                    </div>

                    <div id="call-placeholder"
                        class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none text-slate-500 z-0">
                        <div
                            class="w-24 h-24 md:w-32 md:h-32 rounded-full bg-white/5 border border-white/10 flex items-center justify-center mb-6 animate-pulse">
                            <i class="fas fa-video text-4xl md:text-5xl text-blue-500"></i>
                        </div>
                        <h3 class="text-lg md:text-xl font-bold text-white tracking-tight">Multi-Peer Video Hub</h3>
                        <p class="text-xs text-slate-600 mt-2 flex items-center gap-1.5"><i
                                class="fas fa-shield-halved text-emerald-500"></i> End-to-End Mesh Encrypted</p>
                    </div>
                </div>
                <!-- Security indicator -->
                <div
                    class="absolute top-4 left-4 z-30 flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-500/20 backdrop-blur border border-emerald-500/30 text-emerald-400 text-[10px] font-bold">
                    <i class="fas fa-shield-halved"></i> E2E Secure
                </div>
                <div
                    class="absolute bottom-6 md:bottom-8 left-1/2 -translate-x-1/2 z-30 bg-slate-800/90 backdrop-blur border border-white/10 rounded-full p-2.5 flex gap-3 shadow-2xl">
                    <button onclick="startCall('video')"
                        class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-blue-600 text-white hover:bg-blue-500 active:scale-95 transition flex items-center justify-center shadow-lg"
                        title="Video Call"><i class="fas fa-video text-lg"></i></button>
                    <button onclick="startCall('screen')"
                        class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-purple-600 text-white hover:bg-purple-500 active:scale-95 transition flex items-center justify-center shadow-lg"
                        title="Screen Share"><i class="fas fa-desktop text-lg"></i></button>
                    <button onclick="switchCamera()" id="btn-switch-cam"
                        class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-slate-700 text-white hover:bg-slate-600 active:scale-95 transition flex items-center justify-center"
                        title="Switch Camera"><i class="fas fa-camera-rotate text-lg"></i></button>
                    <button onclick="toggleMic()" id="btn-mic"
                        class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-slate-700 text-white hover:bg-slate-600 active:scale-95 transition flex items-center justify-center"
                        title="Toggle Mic"><i class="fas fa-microphone text-lg"></i></button>
                    <button onclick="toggleFullscreen('view-video')" id="btn-video-fs"
                        class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-slate-700 text-white hover:bg-slate-600 active:scale-95 transition flex items-center justify-center"
                        title="Fullscreen"><i class="fas fa-expand text-lg"></i></button>
                    <button onclick="endCall()"
                        class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-red-600 text-white hover:bg-red-500 active:scale-95 transition flex items-center justify-center shadow-lg"
                        title="End Call"><i class="fas fa-phone-slash text-lg"></i></button>
                </div>
            </div>

            <!-- MAP VIEW -->
            <div id="view-map"
                class="view-section hidden flex-1 flex flex-col h-full relative bg-slate-100 rounded-b-[2rem] md:rounded-bl-none overflow-hidden">
                <div id="map" class="absolute inset-0 z-0"></div>
                <div
                    class="absolute top-4 left-4 z-[1000] bg-white/95 backdrop-blur px-4 py-3 rounded-2xl shadow-xl border border-white flex flex-col gap-2">
                    <button onclick="broadcastLocation()"
                        class="px-5 py-2.5 bg-blue-600 text-white text-xs font-bold rounded-xl hover:bg-blue-700 active:scale-95 transition flex items-center gap-2"><i
                            class="fas fa-location-arrow"></i> Broadcast Live GPS</button>
                </div>
            </div>

            <!-- FILES VIEW -->
            <div id="view-files" class="view-section hidden flex-1 p-4 md:p-6 overflow-y-auto bg-slate-50/50">
                <div class="flex flex-col h-full gap-4 max-w-4xl mx-auto">
                    <div class="grid grid-cols-2 gap-3 shrink-0">
                        <div onclick="document.getElementById('file-input').click()"
                            class="border-2 border-dashed border-blue-300 rounded-[2rem] p-6 md:p-8 flex flex-col items-center justify-center bg-blue-50/50 hover:bg-blue-50 transition cursor-pointer group">
                            <input type="file" id="file-input" multiple class="hidden">
                            <div
                                class="w-14 h-14 bg-blue-600 text-white rounded-2xl flex items-center justify-center mb-3 group-hover:scale-110 group-active:scale-95 transition shadow-lg">
                                <i class="fas fa-file text-xl"></i>
                            </div>
                            <h3 class="font-black text-slate-800 text-sm md:text-base">Select Files</h3>
                            <p class="text-[10px] text-slate-400 font-bold mt-1">Multiple files</p>
                        </div>
                        <div onclick="document.getElementById('folder-input').click()"
                            class="border-2 border-dashed border-emerald-300 rounded-[2rem] p-6 md:p-8 flex flex-col items-center justify-center bg-emerald-50/50 hover:bg-emerald-50 transition cursor-pointer group">
                            <input type="file" id="folder-input" webkitdirectory mozdirectory class="hidden">
                            <div
                                class="w-14 h-14 bg-emerald-600 text-white rounded-2xl flex items-center justify-center mb-3 group-hover:scale-110 group-active:scale-95 transition shadow-lg">
                                <i class="fas fa-folder-open text-xl"></i>
                            </div>
                            <h3 class="font-black text-slate-800 text-sm md:text-base">Select Folder</h3>
                            <p class="text-[10px] text-slate-400 font-bold mt-1">Entire directory</p>
                        </div>
                    </div>
                    <div
                        class="flex-1 bg-white border border-slate-200 rounded-[2rem] p-5 md:p-6 flex flex-col shadow-xl min-h-[300px]">
                        <div class="flex justify-between items-center pb-4 border-b border-slate-100">
                            <span class="text-xs font-black text-slate-400 uppercase tracking-widest">Transfer
                                Activity</span>
                            <div class="flex items-center gap-2">
                                <button onclick="saveAllFiles()" id="btn-save-all"
                                    class="hidden px-3 py-1 bg-emerald-600 text-white text-[9px] font-black rounded-lg hover:bg-emerald-700 transition flex items-center gap-1.5 shadow-sm">
                                    <i class="fas fa-file-download"></i> SAVE ALL
                                </button>
                                <button
                                    onclick="document.getElementById('transfer-list').innerHTML=''; document.getElementById('btn-save-all').classList.add('hidden');"
                                    class="w-7 h-7 rounded-full bg-slate-50 text-slate-400 hover:text-red-500 hover:bg-red-50 transition flex items-center justify-center">
                                    <i class="fas fa-trash text-xs"></i>
                                </button>
                            </div>
                        </div>
                        <div id="transfer-list" class="flex-1 overflow-y-auto space-y-2 py-3"></div>
                        <div class="pt-4 border-t border-slate-100 mt-auto">
                            <div
                                class="flex justify-between text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">
                                <span id="current-file-name" class="truncate max-w-[70%]">System Idle</span><span
                                    id="current-percent" class="text-blue-600">0%</span>
                            </div>
                            <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden shadow-inner">
                                <div id="main-progress"
                                    class="h-full bg-blue-600 w-0 transition-all duration-300 ease-out"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CODE VIEW -->
            <div id="view-code"
                class="view-section hidden flex-1 flex flex-col h-full bg-white rounded-b-[2rem] md:rounded-bl-none overflow-hidden fullscreen-container">
                <div id="code-container" class="flex-1 flex flex-col relative bg-white h-full">
                    <div
                        class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-4 shrink-0 shadow-sm z-10">
                        <div class="flex items-center gap-3">
                            <select id="lang-select" onchange="changeLang()"
                                class="bg-slate-50 text-slate-800 text-sm font-bold border border-slate-200 rounded-xl px-3 py-2 outline-none">
                                <option value="python">Python</option>
                                <option value="html">HTML</option>
                                <option value="sql">SQL</option>
                            </select>
                            <button onclick="toggleFullscreen('view-code')" id="btn-code-fs"
                                class="w-9 h-9 rounded-xl bg-slate-50 border border-slate-200 text-slate-500 hover:text-blue-600 hover:border-blue-300 flex items-center justify-center transition-all"
                                title="Fullscreen"><i class="fas fa-expand"></i></button>
                        </div>
                        <button onclick="runCode()"
                            class="px-5 py-2 bg-slate-800 text-white text-xs font-bold rounded-xl hover:bg-slate-900 active:scale-95 transition shadow-lg flex items-center gap-2"><i
                                class="fas fa-play"></i> RUN</button>
                    </div>
                    <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
                        <div id="editor"
                            class="flex-1 text-sm md:w-3/5 border-b md:border-b-0 md:border-r border-slate-200">
                            print("Hello Mitanshu!")</div>
                        <div class="h-2/5 md:h-full md:w-2/5 bg-slate-900 flex flex-col text-white">
                            <div
                                class="bg-slate-800 px-4 py-2 text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-700 flex justify-between items-center shrink-0">
                                <span>Console</span><button
                                    onclick="document.getElementById('output-text').innerText=''"
                                    class="hover:text-red-400 transition"><i class="fas fa-ban"></i></button>
                            </div>
                            <div class="relative flex-1 overflow-hidden">
                                <div id="output-text"
                                    class="absolute inset-0 p-4 font-mono text-sm text-green-400 overflow-auto whitespace-pre-wrap">
                                </div>
                                <iframe id="html-frame"
                                    class="absolute inset-0 w-full h-full bg-white hidden border-none"></iframe>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 7: MULTI-GAME HUB -->
            <div id="view-games"
                class="view-section hidden flex-1 flex flex-col h-full bg-slate-50 rounded-b-[2rem] md:rounded-bl-none overflow-hidden">

                <!-- Game Tabs (Horizontal Scrollable) -->
                <div class="bg-white border-b border-slate-200 shrink-0">
                    <div class="flex overflow-x-auto gap-2 px-4 py-3 no-scrollbar snap-x items-center">
                        <button onclick="switchGameTab('rt')" id="tab-game-rt"
                            class="snap-start shrink-0 px-4 py-2 rounded-xl text-sm font-black transition-all bg-blue-600 text-white shadow-md">Reaction
                            Duel</button>
                        <button onclick="switchGameTab('ttt')" id="tab-game-ttt"
                            class="snap-start shrink-0 px-4 py-2 rounded-xl text-sm font-black transition-all bg-slate-100 text-slate-500 hover:bg-slate-200">Zero
                            Katta</button>
                        <button onclick="switchGameTab('rps')" id="tab-game-rps"
                            class="snap-start shrink-0 px-4 py-2 rounded-xl text-sm font-black transition-all bg-slate-100 text-slate-500 hover:bg-slate-200">Stone
                            Paper Scissor</button>
                        <button onclick="switchGameTab('tap')" id="tab-game-tap"
                            class="snap-start shrink-0 px-4 py-2 rounded-xl text-sm font-black transition-all bg-slate-100 text-slate-500 hover:bg-slate-200">Tap
                            War</button>
                        <button onclick="switchGameTab('chess')" id="tab-game-chess"
                            class="snap-start shrink-0 px-4 py-2 rounded-xl text-sm font-black transition-all bg-slate-100 text-slate-500 hover:bg-slate-200">♟
                            Chess</button>
                        <button onclick="switchGameTab('space')" id="tab-game-space"
                            class="snap-start shrink-0 px-4 py-2 rounded-xl text-sm font-black transition-all bg-slate-100 text-slate-500 hover:bg-slate-200">Space
                            Battle</button>
                    </div>
                </div>

                <div class="flex-1 p-4 md:p-8 overflow-y-auto">
                    <div class="max-w-xl mx-auto flex flex-col h-full gap-4">

                        <!-- REACTION DUEL -->
                        <div id="g-area-rt" class="game-area flex flex-col gap-6 w-full pb-10">
                            <div class="text-center md:text-left">
                                <h2
                                    class="text-3xl font-black tracking-tight text-slate-800 flex items-center justify-center md:justify-start gap-2">
                                    <i class="fas fa-bolt text-yellow-500"></i> Reaction Duel
                                </h2>
                                <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mt-1">Real-time
                                    Reflex Testing</p>
                            </div>
                            <div
                                class="bg-white border border-slate-200 rounded-[2rem] shadow-xl p-6 flex flex-col items-center w-full">
                                <div id="rt-status"
                                    class="mb-6 inline-block px-4 py-2 bg-slate-100 rounded-full text-xs font-black text-slate-500 uppercase tracking-widest">
                                    Connect to a peer</div>
                                <button id="rt-big" onclick="rtTap()"
                                    class="w-full max-w-[400px] aspect-[4/3] rounded-[3rem] border-4 border-slate-100 bg-slate-50 text-slate-400 font-black text-4xl shadow-inner active:scale-95 transition-all duration-100 flex items-center justify-center select-none outline-none">CONNECT</button>
                                <div class="w-full max-w-[400px] mt-8 grid grid-cols-2 gap-4">
                                    <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100 text-center">
                                        <div
                                            class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">
                                            Your Time</div>
                                        <div id="rt-me" class="text-xl font-black text-blue-600 font-mono">-</div>
                                    </div>
                                    <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100 text-center">
                                        <div
                                            class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">
                                            Peer Time</div>
                                        <div id="rt-peer" class="text-xl font-black text-red-500 font-mono">-</div>
                                    </div>
                                </div>
                                <div class="w-full max-w-[400px] mt-4 bg-slate-800 rounded-2xl p-4 text-center">
                                    <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">
                                        Result</div>
                                    <div id="rt-winner" class="text-lg font-black text-white uppercase">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- ZERO KATTA (Tic Tac Toe) -->
                        <div id="g-area-ttt" class="game-area hidden flex flex-col gap-6 w-full pb-10">
                            <div class="text-center md:text-left flex justify-between items-center">
                                <div>
                                    <h2
                                        class="text-3xl font-black tracking-tight text-slate-800 flex items-center justify-center md:justify-start gap-2">
                                        <i class="fas fa-times text-blue-500"></i> Zero Katta
                                    </h2>
                                    <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mt-1">Classic
                                        Tic Tac Toe</p>
                                </div>
                                <button onclick="tttReset(true)"
                                    class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 active:scale-95 transition flex items-center justify-center"><i
                                        class="fas fa-rotate-right"></i></button>
                            </div>
                            <div
                                class="bg-white border border-slate-200 rounded-[2rem] shadow-xl p-6 flex flex-col items-center w-full">
                                <div class="flex justify-between w-full max-w-[360px] mb-6">
                                    <div class="bg-blue-50 px-4 py-2 rounded-xl text-center">
                                        <div class="text-[10px] font-black text-blue-400 uppercase tracking-widest">You
                                        </div>
                                        <div id="ttt-my-symbol" class="text-xl font-black text-blue-600">-</div>
                                    </div>
                                    <div id="ttt-status"
                                        class="flex-1 mx-2 flex items-center justify-center text-xs font-black text-slate-500 uppercase tracking-widest text-center bg-slate-50 rounded-xl px-2">
                                        Connect to Peer</div>
                                    <div class="bg-red-50 px-4 py-2 rounded-xl text-center">
                                        <div class="text-[10px] font-black text-red-400 uppercase tracking-widest">Peer
                                        </div>
                                        <div id="ttt-peer-symbol" class="text-xl font-black text-red-600">-</div>
                                    </div>
                                </div>
                                <div
                                    class="grid grid-cols-3 gap-3 w-full max-w-[360px] aspect-square bg-slate-200 p-3 rounded-[2rem]">
                                    <button onclick="tttClick(0)" id="ttt-0"
                                        class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                    <button onclick="tttClick(1)" id="ttt-1"
                                        class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                    <button onclick="tttClick(2)" id="ttt-2"
                                        class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                    <button onclick="tttClick(3)" id="ttt-3"
                                        class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                    <button onclick="tttClick(4)" id="ttt-4"
                                        class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                    <button onclick="tttClick(5)" id="ttt-5"
                                        class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                    <button onclick="tttClick(6)" id="ttt-6"
                                        class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                    <button onclick="tttClick(7)" id="ttt-7"
                                        class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                    <button onclick="tttClick(8)" id="ttt-8"
                                        class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                </div>
                            </div>
                        </div>

                        <!-- STONE PAPER SCISSOR (Anti-Cheat) -->
                        <div id="g-area-rps" class="game-area hidden flex flex-col gap-6 w-full pb-10">
                            <div class="text-center md:text-left flex justify-between items-center">
                                <div>
                                    <h2
                                        class="text-3xl font-black tracking-tight text-slate-800 flex items-center justify-center md:justify-start gap-2">
                                        <i class="fas fa-hand-rock text-slate-600"></i> RPS Duel
                                    </h2>
                                    <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mt-1">Blind
                                        Pick Anti-Cheat</p>
                                </div>
                                <button onclick="rpsReset(true)"
                                    class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 active:scale-95 transition flex items-center justify-center"><i
                                        class="fas fa-rotate-right"></i></button>
                            </div>
                            <div
                                class="bg-white border border-slate-200 rounded-[2rem] shadow-xl p-6 flex flex-col items-center w-full">
                                <div id="rps-status"
                                    class="mb-6 inline-block px-4 py-2 bg-slate-100 rounded-full text-xs font-black text-slate-500 uppercase tracking-widest text-center">
                                    Waiting to connect...</div>

                                <div class="flex justify-between w-full max-w-[400px] mb-8 gap-4">
                                    <div class="flex-1 bg-slate-50 border border-slate-100 rounded-2xl p-4 text-center">
                                        <div
                                            class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-2">
                                            You</div>
                                        <div id="rps-me" class="text-4xl"><i class="fas fa-question text-slate-300"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1 bg-slate-50 border border-slate-100 rounded-2xl p-4 text-center">
                                        <div class="text-[10px] font-black text-red-400 uppercase tracking-widest mb-2">
                                            Peer</div>
                                        <div id="rps-peer" class="text-4xl"><i
                                                class="fas fa-question text-slate-300"></i></div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-3 gap-3 w-full max-w-[400px]">
                                    <button onclick="rpsPick('rock')"
                                        class="aspect-square bg-white border-2 border-slate-200 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-slate-50 hover:border-blue-400 active:scale-95 transition group">
                                        <i
                                            class="fas fa-hand-rock text-3xl text-slate-600 group-hover:text-blue-500 transition"></i><span
                                            class="text-xs font-black text-slate-500">STONE</span>
                                    </button>
                                    <button onclick="rpsPick('paper')"
                                        class="aspect-square bg-white border-2 border-slate-200 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-slate-50 hover:border-blue-400 active:scale-95 transition group">
                                        <i
                                            class="fas fa-hand-paper text-3xl text-slate-600 group-hover:text-blue-500 transition"></i><span
                                            class="text-xs font-black text-slate-500">PAPER</span>
                                    </button>
                                    <button onclick="rpsPick('scissors')"
                                        class="aspect-square bg-white border-2 border-slate-200 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-slate-50 hover:border-blue-400 active:scale-95 transition group">
                                        <i
                                            class="fas fa-hand-scissors text-3xl text-slate-600 group-hover:text-blue-500 transition"></i><span
                                            class="text-xs font-black text-slate-500">SCISSOR</span>
                                    </button>
                                </div>
                                <div id="rps-result"
                                    class="mt-6 w-full max-w-[400px] bg-slate-800 rounded-2xl p-4 text-center text-lg font-black text-white uppercase opacity-0 transition-opacity">
                                    WINNER</div>
                            </div>
                        </div>

                        <!-- TAP WAR -->
                        <div id="g-area-tap" class="game-area hidden flex flex-col gap-6 w-full pb-10">
                            <div class="text-center md:text-left flex justify-between items-center">
                                <div>
                                    <h2
                                        class="text-3xl font-black tracking-tight text-slate-800 flex items-center justify-center md:justify-start gap-2">
                                        <i class="fas fa-fire text-orange-500"></i> Tap War
                                    </h2>
                                    <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mt-1">Mash to
                                        Pull The Rope</p>
                                </div>
                                <button onclick="tapReset(true)"
                                    class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 active:scale-95 transition flex items-center justify-center"><i
                                        class="fas fa-rotate-right"></i></button>
                            </div>
                            <div
                                class="bg-white border border-slate-200 rounded-[2rem] shadow-xl p-6 flex flex-col items-center w-full">
                                <div id="tap-status"
                                    class="mb-4 inline-block px-4 py-2 bg-slate-100 rounded-full text-xs font-black text-slate-500 uppercase tracking-widest text-center">
                                    Connect to Play</div>

                                <div
                                    class="w-full max-w-[400px] bg-slate-100 h-12 rounded-full overflow-hidden relative border border-slate-200 shadow-inner my-4">
                                    <div class="absolute inset-y-0 left-1/2 w-1 bg-slate-800 z-10 -translate-x-1/2">
                                    </div>
                                    <div id="tap-bar"
                                        class="h-full bg-gradient-to-r from-blue-500 to-blue-400 transition-all duration-100 ease-out"
                                        style="width: 50%;"></div>
                                </div>

                                <div class="flex justify-between w-full max-w-[400px] mb-8 px-2">
                                    <span class="text-xs font-black text-blue-600 uppercase">You (<span
                                            id="tap-my-score">50</span>%)</span>
                                    <span class="text-xs font-black text-red-500 uppercase">Peer</span>
                                </div>

                                <button onclick="tapClick()" id="tap-btn"
                                    class="w-full max-w-[400px] aspect-[2/1] rounded-[2rem] border-b-[8px] border-blue-700 bg-blue-500 text-white font-black text-4xl shadow-xl active:border-b-0 active:translate-y-[8px] transition-all flex flex-col items-center justify-center select-none outline-none group">
                                    <i
                                        class="fas fa-hand-pointer mb-2 text-blue-200 group-active:scale-90 transition"></i>
                                    MASH TAP!
                                </button>
                            </div>
                        </div>

                        <!-- CHESS -->
                        <div id="g-area-chess"
                            class="game-area hidden flex flex-col gap-6 w-full pb-10 fullscreen-container bg-slate-50">
                            <div class="text-center md:text-left flex justify-between items-center">
                                <div>
                                    <h2
                                        class="text-3xl font-black tracking-tight text-slate-800 flex items-center justify-center md:justify-start gap-2">
                                        ♚ Chess</h2>
                                    <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mt-1">Full
                                        Rules • Checkmate</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="toggleFullscreen('g-area-chess')"
                                        class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 active:scale-95 transition flex items-center justify-center"
                                        title="Fullscreen"><i class="fas fa-expand"></i></button>
                                    <button onclick="chessReset(true)"
                                        class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 active:scale-95 transition flex items-center justify-center"><i
                                            class="fas fa-rotate-right"></i></button>
                                </div>
                            </div>
                            <div
                                class="bg-white border border-slate-200 rounded-[2rem] shadow-xl p-4 md:p-6 flex flex-col items-center w-full">
                                <div class="flex justify-between w-full max-w-[420px] mb-3">
                                    <div class="bg-slate-800 px-3 py-1.5 rounded-xl text-center">
                                        <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                            Black</div>
                                        <div id="chess-captured-w" class="text-sm font-bold text-white min-h-[20px]">
                                        </div>
                                    </div>
                                    <div id="chess-status"
                                        class="flex-1 mx-2 flex items-center justify-center text-xs font-black text-slate-500 uppercase tracking-widest text-center bg-slate-50 rounded-xl px-2">
                                        Connect to Play</div>
                                    <div class="bg-white border border-slate-200 px-3 py-1.5 rounded-xl text-center">
                                        <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                            White</div>
                                        <div id="chess-captured-b"
                                            class="text-sm font-bold text-slate-800 min-h-[20px]"></div>
                                    </div>
                                </div>
                                <div id="chess-board" class="chess-board w-full max-w-[420px]"></div>
                                <div id="chess-promo-modal"
                                    class="hidden fixed inset-0 z-[250] flex items-center justify-center bg-slate-900/80 backdrop-blur-md">
                                    <div class="bg-white p-6 rounded-3xl shadow-2xl flex flex-col items-center gap-4">
                                        <h4 class="text-sm font-black text-slate-800 uppercase tracking-widest">Promote
                                            Pawn</h4>
                                        <div class="flex gap-3" id="chess-promo-choices"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SPACE BATTLE (2D Multiplayer) -->
                        <div id="g-area-space" class="game-area hidden flex flex-col gap-4 w-full h-[600px] pb-10">
                            <div class="text-center md:text-left flex justify-between items-center">
                                <div>
                                    <h2
                                        class="text-3xl font-black tracking-tight text-slate-800 flex items-center gap-2">
                                        <i class="fas fa-rocket text-blue-500"></i> Space Battle
                                    </h2>
                                    <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mt-1">
                                        Multiplayer Mesh Shooter</p>
                                </div>
                                <div class="flex gap-2">
                                    <span id="space-count"
                                        class="px-3 py-1 bg-slate-800 text-white text-[10px] rounded-lg font-black uppercase">LIVE:
                                        1</span>
                                    <button onclick="toggleFullscreen('g-area-space')"
                                        class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 active:scale-95 transition flex items-center justify-center"
                                        title="Fullscreen"><i class="fas fa-expand"></i></button>
                                    <button onclick="spaceInit()"
                                        class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 transition-all flex items-center justify-center"><i
                                            class="fas fa-rotate-right"></i></button>
                                </div>
                            </div>
                            <div
                                class="relative flex-1 bg-slate-900 rounded-[2rem] overflow-hidden border-4 border-slate-200 shadow-2xl group">
                                <canvas id="space-canvas" class="w-full h-full cursor-none"></canvas>
                                <div id="space-overlay"
                                    class="absolute inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm pointer-events-none transition-opacity duration-500">
                                    <div class="text-center">
                                        <div class="text-white font-black text-4xl mb-4 tracking-tighter">READY TO FLY?
                                        </div>
                                        <button onclick="spaceStart()"
                                            class="pointer-events-auto px-10 py-4 bg-blue-600 text-white font-black rounded-2xl shadow-xl hover:bg-blue-700 active:scale-95 transition-all">ENTER
                                            ARENA</button>
                                        <p class="text-blue-300 text-[10px] font-bold uppercase tracking-[0.2em] mt-6">
                                            WASD to Move • Click to Shoot</p>
                                    </div>
                                </div>
                                <div
                                    class="absolute bottom-6 left-6 text-white/30 text-[10px] font-black uppercase tracking-widest pointer-events-none">
                                    Mesh Synced Arena v1.0</div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>


            <div id="view-browse"
                class="view-section hidden flex-1 flex flex-col h-full bg-white rounded-b-[2rem] md:rounded-bl-none overflow-hidden">
                <div
                    class="p-4 border-b border-slate-100 flex justify-between items-center bg-white/80 backdrop-blur-md shrink-0">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full bg-cyan-50 text-cyan-600 flex items-center justify-center border border-cyan-100">
                            <i class="fas fa-globe text-lg"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-800 text-sm">Browse Share</h3>
                            <p id="browse-peer-status" class="text-[10px] text-slate-400 font-bold">Peer: Not Enabled
                            </p>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer gap-2">
                        <input type="checkbox" id="browse-toggle" onchange="browseToggle()" class="sr-only peer">
                        <div
                            class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                        </div>
                        <span class="text-xs font-bold text-slate-500">Enable</span>
                    </label>
                </div>
                <div class="flex-1 overflow-y-auto p-4 md:p-6">
                    <div class="max-w-2xl mx-auto flex flex-col gap-6">
                        <!-- Link Share -->
                        <div class="bg-white border border-slate-200 rounded-[2rem] shadow-xl p-6">
                            <h4
                                class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                <i class="fas fa-external-link-alt text-blue-500"></i> Send Link to Peer
                            </h4>
                            <p class="text-xs text-slate-500 mb-4">Paste a URL and send it to your connected peer.
                                They'll get a confirmation before it opens in a new tab.</p>
                            <div class="flex gap-2">
                                <input type="url" id="browse-link-input" placeholder="https://example.com"
                                    class="flex-1 bg-slate-50 border border-slate-200 rounded-xl p-3 font-mono text-sm outline-none focus:border-blue-500 focus:bg-white transition">
                                <button onclick="browseSendLink()"
                                    class="px-5 bg-blue-600 text-white rounded-xl font-bold text-sm hover:bg-blue-700 active:scale-95 transition shadow-lg flex items-center gap-2"><i
                                        class="fas fa-paper-plane"></i> Send</button>
                            </div>
                        </div>
                        <!-- Shared Preview -->
                        <div class="bg-white border border-slate-200 rounded-[2rem] shadow-xl p-6">
                            <h4
                                class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                <i class="fas fa-eye text-purple-500"></i> Shared Preview
                            </h4>
                            <p class="text-xs text-slate-500 mb-4">Load a public URL and both peers will view it in a
                                live iframe. Great for co-browsing! <span class="text-blue-600 font-bold">(Tip: for
                                    local servers, use ngrok to get a public URL)</span></p>
                            <div class="flex gap-2 mb-4">
                                <input type="url" id="preview-url-input" placeholder="https://your-site.com"
                                    class="flex-1 bg-slate-50 border border-slate-200 rounded-xl p-3 font-mono text-sm outline-none focus:border-purple-500 focus:bg-white transition">
                                <button onclick="previewLoad()"
                                    class="px-5 bg-purple-600 text-white rounded-xl font-bold text-sm hover:bg-purple-700 active:scale-95 transition shadow-lg flex items-center gap-2"><i
                                        class="fas fa-play"></i> Load</button>
                                <button onclick="previewStop()"
                                    class="px-4 bg-slate-200 text-slate-600 rounded-xl font-bold text-sm hover:bg-red-100 hover:text-red-600 active:scale-95 transition flex items-center justify-center"><i
                                        class="fas fa-stop"></i></button>
                            </div>
                            <div id="preview-container"
                                class="bg-slate-100 border border-slate-200 rounded-2xl overflow-hidden hidden"
                                style="height: 450px;">
                                <iframe id="preview-iframe" class="w-full h-full border-none"
                                    sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
                            </div>
                            <div id="preview-placeholder"
                                class="bg-slate-50 border border-slate-200 rounded-2xl p-8 flex flex-col items-center justify-center text-center"
                                style="height: 180px;">
                                <i class="fas fa-desktop text-4xl text-slate-300 mb-3"></i>
                                <p class="text-sm text-slate-400 font-bold">Enter a URL above to start shared preview
                                </p>
                            </div>
                        </div>
                        <!-- Activity Log -->
                        <div class="bg-white border border-slate-200 rounded-[2rem] shadow-xl p-6 mb-6">
                            <h4
                                class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                                <i class="fas fa-history text-slate-500"></i> Link Activity
                            </h4>
                            <div id="browse-log" class="space-y-2 max-h-[200px] overflow-y-auto">
                                <p class="text-xs text-slate-400 text-center py-4">No links shared yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WHITEBOARD VIEW -->
            <div id="view-board"
                class="view-section hidden flex-1 flex flex-col h-full bg-white rounded-b-[2rem] md:rounded-bl-none overflow-hidden">
                <div
                    class="p-4 border-b border-slate-100 flex justify-between items-center bg-white/80 backdrop-blur-md shrink-0">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full bg-pink-50 text-pink-600 flex items-center justify-center border border-pink-100">
                            <i class="fas fa-paint-brush text-lg"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-800 text-sm">Infinite Whiteboard</h3>
                            <p class="text-[10px] text-emerald-600 font-bold">Mesh Synchronized</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="color" id="board-color" value="#2563eb"
                            class="w-8 h-8 rounded cursor-pointer border-none p-0">
                        <button onclick="boardSetTool('pen')" id="btn-board-pen"
                            class="w-9 h-9 rounded-xl bg-blue-100 text-blue-600 hover:bg-blue-200 flex items-center justify-center transition"
                            title="Pen"><i class="fas fa-pen"></i></button>
                        <button onclick="boardSetTool('eraser')" id="btn-board-eraser"
                            class="w-9 h-9 rounded-xl bg-slate-100 text-slate-600 hover:bg-slate-200 flex items-center justify-center transition"
                            title="Eraser"><i class="fas fa-eraser"></i></button>
                        <button onclick="boardClear(true)"
                            class="w-9 h-9 rounded-xl bg-red-100 text-red-600 hover:bg-red-200 flex items-center justify-center transition"
                            title="Clear Board"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
                <div class="flex-1 overflow-hidden relative bg-slate-50 cursor-crosshair">
                    <canvas id="board-canvas" class="absolute inset-0 touch-none"></canvas>
                </div>
            </div>

            <!-- MEDIA WATCH PARTY VIEW -->
            <div id="view-media"
                class="view-section hidden flex-1 flex flex-col h-full bg-slate-900 rounded-b-[2rem] md:rounded-bl-none overflow-hidden">
                <div
                    class="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/80 backdrop-blur-md shrink-0">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full bg-rose-500/20 text-rose-500 flex items-center justify-center border border-rose-500/30">
                            <i class="fas fa-film text-lg"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-white text-sm">Watch Party Hub</h3>
                            <p class="text-[10px] text-emerald-500 font-bold">Frames Synced</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="url" id="media-url" placeholder="Paste .mp4 or stream URL"
                            class="px-3 py-1.5 text-xs bg-slate-800 text-white border border-slate-700 rounded-lg outline-none focus:border-blue-500 w-[200px] hidden md:block">
                        <button onclick="mediaLoadUrl()"
                            class="w-9 h-9 rounded-xl bg-blue-600 text-white hover:bg-blue-500 flex items-center justify-center transition"
                            title="Load Media"><i class="fas fa-play"></i></button>
                        <button onclick="document.getElementById('media-upload').click()"
                            class="w-9 h-9 rounded-xl bg-slate-700 text-slate-300 hover:bg-slate-600 hover:text-white flex items-center justify-center transition"
                            title="Local File"><i class="fas fa-folder-open"></i></button>
                        <input type="file" id="media-upload" class="hidden" accept="video/*"
                            onchange="mediaLoadLocal()">
                    </div>
                </div>
                <div class="flex-1 flex items-center justify-center p-4 bg-black relative w-full h-full max-h-full">
                    <video id="media-player" controls preload="metadata"
                        class="w-full max-h-full max-w-5xl rounded-xl shadow-2xl"></video>
                    <div id="media-placeholder"
                        class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none text-slate-500">
                        <i class="fas fa-film text-6xl text-slate-800 mb-4"></i>
                        <p class="font-bold">Load a video to start the watch party</p>
                    </div>
                </div>
            </div>

            <!-- TASK BOARD VIEW -->
            <div id="view-tasks"
                class="view-section hidden flex-1 flex flex-col h-full bg-white rounded-b-[2rem] md:rounded-bl-none overflow-hidden">
                <div
                    class="p-4 border-b border-slate-100 flex justify-between items-center bg-white/80 backdrop-blur-md shrink-0">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full bg-lime-50 text-lime-600 flex items-center justify-center border border-lime-100">
                            <i class="fas fa-check-square text-lg"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-800 text-sm">Task Board</h3>
                            <p class="text-[10px] text-emerald-600 font-bold">Collaborative Kanban</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-slate-50 border-b border-slate-100 shrink-0">
                    <div class="max-w-xl mx-auto flex gap-2">
                        <input type="text" id="task-input" placeholder="Add a new task..."
                            class="flex-1 bg-white border border-slate-200 rounded-xl px-4 py-2 font-bold text-sm outline-none focus:border-blue-500 transition"
                            onkeypress="if(event.key==='Enter') taskAdd()">
                        <button onclick="taskAdd()"
                            class="px-6 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700 active:scale-95 transition"><i
                                class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-4 md:p-8">
                    <div class="max-w-xl mx-auto gap-3 flex flex-col" id="task-list">
                        <!-- Tasks inject here -->
                        <div class="text-center p-8 text-slate-400 font-bold text-sm">No tasks added yet. Start
                            planning!</div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- INCOMING CALL MODAL -->
    <div id="incoming-modal"
        class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-slate-900/80 backdrop-blur-md">
        <div
            class="bg-white p-8 rounded-[2.5rem] shadow-2xl flex flex-col items-center gap-6 max-w-sm w-full mx-4 animate-float border border-white/20">
            <div class="relative">
                <div class="absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-20"></div>
                <div
                    class="w-24 h-24 bg-blue-50 border border-blue-100 rounded-full flex items-center justify-center text-blue-600 shadow-inner relative z-10">
                    <i class="fas fa-phone-alt text-4xl animate-ring"></i>
                </div>
            </div>
            <div class="text-center">
                <h3 class="text-2xl font-black text-slate-800 tracking-tight">Incoming Call</h3>
                <p class="text-slate-500 text-sm mt-1 font-medium">Secure Peer Connection Request</p>
            </div>
            <div class="flex gap-3 w-full mt-2">
                <button onclick="rejectCall()"
                    class="flex-1 py-3.5 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-red-50 hover:text-red-600 transition active:scale-95">DECLINE</button>
                <button onclick="acceptCall()"
                    class="flex-1 py-3.5 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition active:scale-95">ACCEPT</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast"
        class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3.5 rounded-full shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-[300] flex items-center gap-3 text-xs font-bold whitespace-nowrap">
        <i class="fas fa-info-circle text-blue-400 text-base"></i> <span id="toast-msg">Notification</span>
    </div>

    <script>
        // --- CORE SYSTEM ---
        const SYS = {
            peer: null, calls: new Map(), localStream: null, localScreen: null,
            editor: null, map: null, pyodide: null,
            myId: null, targetId: null, remotePeerId: null,
            isMicMuted: false, pendingCall: null,
            peers: new Map(), peerNames: new Map(), peerStats: new Map(),
            myName: null, msgHistory: new Set(),
            locationWatchId: null,
            swarms: new Map(),
            voiceRecorder: null, voiceChunks: [], isRecording: false,
            activeGame: 'rt',
            space: {
                canvas: null, ctx: null, lastUpdate: 0,
                players: new Map(), bullets: [], keys: {},
                active: false, shipId: null,
                x: 0, y: 0, a: 0, vx: 0, vy: 0,
                health: 100, score: 0, particles: []
            },
            games: {
                rt: { state: 'idle', goAt: null, myTime: null, peerTime: null, winner: null, timer: null },
                ttt: { board: Array(9).fill(''), turn: 'X', over: false, winner: null },
                rps: { state: 'idle', myPick: null, peerReady: false, peerPick: null, result: null },
                tap: { state: 'idle', score: 50, over: false },
                chess: null
            },
            browse: { enabled: false, peerEnabled: false },
            board: { activeTool: 'pen', isDrawing: false, lastX: 0, lastY: 0, ctx: null },
            media: { isSyncing: false, lastState: null },
            tasks: { items: {} }
        };
        function chessNewState() { return { board: [['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r'], ['p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'], ['', '', '', '', '', '', '', ''], ['', '', '', '', '', '', '', ''], ['', '', '', '', '', '', '', ''], ['', '', '', '', '', '', '', ''], ['P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'], ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R']], turn: 'w', selected: null, validMoves: [], over: false, winner: null, inCheck: false, castling: { wK: true, wQ: true, bK: true, bQ: true }, enPassant: null, captured: { w: [], b: [] }, promoData: null }; }
        SYS.games.chess = chessNewState();

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('peer')) {
                SYS.targetId = urlParams.get('peer');
                document.getElementById('remote-id').value = SYS.targetId;
                document.getElementById('auto-connect-msg').classList.remove('hidden');
            }
            initPeer();
            initUI();
            setTimeout(() => initEditor(), 800);
            setTimeout(() => loadPython(), 2000);
        };

        // --- NETWORK ---
        function initPeer() {
            SYS.peer = new Peer();
            SYS.peer.on('open', id => {
                SYS.myId = id;
                document.getElementById('my-id').innerText = id;
                document.getElementById('btn-copy-id').onclick = copyMyId;
                updateStatus('ONLINE', 'emerald');
                if (SYS.targetId) { showToast("Found Link. Connecting..."); connectToPeer(SYS.targetId); }
                gamesInitUI();
            });
            SYS.peer.on('connection', c => {
                SYS.peers.set(c.peer, c);
                if (!SYS.conn) { SYS.conn = c; SYS.remotePeerId = c.peer; }
                document.getElementById('remote-id').value = c.peer;
                setupDataLinkFor(c); showToast(`Peer Connected (${SYS.peers.size} linked)`);
                updatePeerCount();
            });
            SYS.peer.on('call', call => {
                SYS.pendingCall = call; SYS.remotePeerId = call.peer;
                const type = call.metadata ? call.metadata.type : 'video';
                document.getElementById('incoming-modal').classList.remove('hidden');
                showToast(`Incoming ${type.toUpperCase()} from Peer...`);
            });
            SYS.peer.on('error', err => { console.error(err); showToast("Network Error: " + err.type); });
        }
        function updatePeerCount() {
            const cnt = SYS.peers.size;
            const badge = document.getElementById('peer-count-badge');
            const secBadge = document.getElementById('security-badge');
            if (cnt > 0) { badge.classList.remove('hidden'); document.getElementById('peer-count').innerText = cnt; secBadge.classList.remove('hidden'); }
            else { badge.classList.add('hidden'); secBadge.classList.add('hidden'); }
        }
        function broadcast(data, excludeId = null) {
            // Add our info if we are the origin
            if (!data.origin) {
                data.origin = SYS.myId;
                data.senderName = getOrCreateName();
                data.msgId = Date.now() + Math.random().toString(36).substring(2, 9);
                SYS.msgHistory.add(data.msgId);
                if (SYS.msgHistory.size > 100) {
                    const first = SYS.msgHistory.values().next().value;
                    SYS.msgHistory.delete(first);
                }
            }
            SYS.peers.forEach((c, id) => {
                if (c && c.open && id !== excludeId) c.send(data);
            });
        }

        function connectToPeer(idOverride = null, silent = false) {
            const id = idOverride || document.getElementById('remote-id').value.trim();
            if (!id) return showToast("Enter Peer ID");
            if (SYS.peers.has(id)) return; // Already linked
            if (!silent) showToast("Connecting...");
            const conn = SYS.peer.connect(id);
            conn.on('open', () => {
                SYS.peers.set(id, conn);
                if (!SYS.conn) { SYS.conn = conn; SYS.remotePeerId = id; }
                setupDataLinkFor(conn);
                if (!idOverride) { // Only show toast if manual connect, not mesh discovery
                    showToast(`Connected Securely (${SYS.peers.size} peers)`);
                    document.getElementById('auto-connect-msg').classList.add('hidden');
                    switchTab('chat');
                }
                updatePeerCount();
            });
            conn.on('error', err => showToast("Connection Failed"));
        }

        function setupDataLinkFor(c) {
            updateStatus(`${SYS.peers.size} LINKED`, 'blue');
            startPingLoop();

            // 1. Send our profile
            const myName = getOrCreateName();
            c.send({ type: 'NAME', name: myName });

            // 2. Auto-Invite to video/screen if we are already in an active session
            if (SYS.localStream) {
                const call = SYS.peer.call(c.peer, SYS.localStream, { metadata: { type: 'video' } });
                handleStream(call, 'video');
            }
            if (SYS.localScreen) {
                const call = SYS.peer.call(c.peer, SYS.localScreen, { metadata: { type: 'screen' } });
                handleStream(call, 'screen');
            }

            // 3. MESH SYNC: Share our entire knowledge of the room
            // First, tell the newcomer about everyone else
            const knownPeers = Array.from(SYS.peers.keys()).filter(id => id !== c.peer);
            if (knownPeers.length > 0) {
                setTimeout(() => {
                    if (c.open) c.send({ type: 'MESH_SYNC', peers: knownPeers });
                }, 1000); // Small delay to ensure they are ready
            }

            // Second, announce the newcomer to all our existing peers
            broadcast({ type: 'MESH_SYNC', peers: [c.peer] });

            c.on('data', data => {
                // Deduplication Check
                if (data.msgId) {
                    if (SYS.msgHistory.has(data.msgId)) return;
                    SYS.msgHistory.add(data.msgId);
                    // Keep history slim (last 100 msgs)
                    if (SYS.msgHistory.size > 100) {
                        const first = SYS.msgHistory.values().next().value;
                        SYS.msgHistory.delete(first);
                    }
                }

                // RELAY LOGIC: Forward message to all other peers if we are the hub
                if (data.origin && data.origin !== SYS.myId) {
                    // Update our knowledge of the sender's name from the packet
                    if (data.senderName) SYS.peerNames.set(data.origin, data.senderName);
                    // Broadcast to others (excluding the one who sent it to us)
                    broadcast(data, c.peer);
                }

                if (data.type === 'PING') c.send({ type: 'PONG', ts: data.ts });
                else if (data.type === 'PONG') measureLatency(data.ts);
                else if (data.type === 'NAME') { SYS.peerNames.set(c.peer, data.name); showToast(`Identify: ${data.name}`); }
                else if (data.type === 'MESH_SYNC') {
                    data.peers.forEach(id => {
                        if (!SYS.peers.has(id) && id !== SYS.myId) connectToPeer(id, true);
                    });
                }
                else if (data.type === 'CHAT') addChat(data.msg, false, data.origin || c.peer);
                else if (data.type === 'CHAT_MEDIA') addChat(data.media, false, data.origin || c.peer, data.mediaType, data.fileName);
                else if (data.type === 'VOICE') addVoiceChat(data.data, false, data.dur || 0, data.origin || c.peer);
                else if (data.type === 'CODE') syncCode(data);
                else if (data.type === 'GPS') updateMapMarker(data);
                else if (data.type === 'SWARM_START') handleSwarmStart(data);
                else if (data.type === 'SWARM_CHUNK') handleSwarmChunk(data);
                else if (data.type === 'SWARM_HAVE') handleSwarmHave(data);
                else if (data.type === 'SWARM_REQ') handleSwarmReq(data, c);
                else if (data.type === 'GAME') handleGameMessage(data);
                else if (data.type === 'SPACE') handleSpaceMessage(data);
                else if (data.type === 'BROWSE_ENABLE') { SYS.browse.peerEnabled = true; const ps = document.getElementById('browse-peer-status'); ps.innerText = 'Peer: Enabled ✓'; ps.className = 'text-[10px] text-emerald-600 font-bold'; showToast('Peer enabled Browse Share'); }
                else if (data.type === 'BROWSE_DISABLE') { SYS.browse.peerEnabled = false; const ps = document.getElementById('browse-peer-status'); ps.innerText = 'Peer: Not Enabled'; ps.className = 'text-[10px] text-slate-400 font-bold'; }
                else if (data.type === 'BROWSE_LINK') browseReceiveLink(data.url);
                else if (data.type === 'PREVIEW_URL') previewReceive(data.url);
                else if (data.type === 'PREVIEW_STOP') previewStopReceive();
                else if (data.type === 'BOARD') boardApplyDraw(data);
                else if (data.type === 'BOARD_CLEAR') boardClear(false);
                else if (data.type === 'MEDIA') mediaApplySync(data);
                else if (data.type === 'TASKS') taskApplySync(data);
            });
            c.on('close', () => {
                const peerId = c.peer;
                SYS.peers.delete(peerId);
                // Remove map marker for this peer
                if (SYS.markers && SYS.markers[peerId]) {
                    if (SYS.map) SYS.map.removeLayer(SYS.markers[peerId]);
                    delete SYS.markers[peerId];
                }
                if (SYS.peers.size === 0) { updateStatus('OFFLINE', 'red'); SYS.conn = null; SYS.remotePeerId = null; }
                else { const first = SYS.peers.entries().next().value; SYS.conn = first[1]; SYS.remotePeerId = first[0]; updateStatus(`${SYS.peers.size} LINKED`, 'blue'); }
                showToast("Peer Disconnected"); gamesInitUI(); updatePeerCount();
                SYS.browse.peerEnabled = false;
                const ps = document.getElementById('browse-peer-status'); ps.innerText = 'Peer: Not Enabled'; ps.className = 'text-[10px] text-slate-400 font-bold';
            });
            gamesInitUI();
            if (SYS.browse.enabled) SYS.conn.send({ type: 'BROWSE_ENABLE' });
        }

        function gameSend(payload) {
            if (!SYS.conn || !SYS.conn.open) return showToast("Connect First");
            SYS.conn.send({ type: 'GAME', ...payload });
        }

        function handleGameMessage(d) {
            // Check if game tab needs auto-switch for seamless experience
            if (SYS.activeGame !== d.game) switchGameTab(d.game);

            // RT
            if (d.game === 'rt') {
                if (d.action === 'RESET') rtReset(false);
                else if (d.action === 'START') rtStartLocal(d.delayMs);
                else if (d.action === 'GO') rtGoLocal();
                else if (d.action === 'TAP') { SYS.games.rt.peerTime = d.ms; rtComputeWinner(); }
            }
            // TTT
            else if (d.game === 'ttt') {
                if (d.action === 'RESET') tttReset(false);
                else if (d.action === 'MOVE') tttApplyMove(d.idx, false);
            }
            // RPS (Anti Cheat)
            else if (d.game === 'rps') {
                if (d.action === 'RESET') rpsReset(false);
                else if (d.action === 'READY') {
                    SYS.games.rps.peerReady = true;
                    rpsUpdateUI();
                    if (SYS.games.rps.myPick) gameSend({ game: 'rps', action: 'REVEAL', pick: SYS.games.rps.myPick });
                }
                else if (d.action === 'REVEAL') {
                    SYS.games.rps.peerPick = d.pick;
                    if (!SYS.games.rps.myPick) {
                        // Peer revealed too early? (Shouldn't happen with strict logic)
                    } else {
                        rpsCompute();
                    }
                }
            }
            // TAP WAR
            else if (d.game === 'tap') {
                if (d.action === 'RESET') tapReset(false);
                else if (d.action === 'PULL') tapApplyPeerPull();
            }
            // CHESS
            else if (d.game === 'chess') {
                if (d.action === 'RESET') chessReset(false);
                else if (d.action === 'MOVE') chessApplyRemoteMove(d.fr, d.fc, d.tr, d.tc, d.promo);
            }
        }

        function handleSpaceMessage(d) {
            const s = SYS.space;
            if (d.action === 'MOVE') {
                s.players.set(d.origin, { x: d.x, y: d.y, a: d.a, name: d.senderName || d.origin.substring(0, 5), color: d.color, health: d.health || 100 });
            } else if (d.action === 'FIRE') {
                s.bullets.push({ x: d.x, y: d.y, vx: Math.cos(d.a) * 8, vy: Math.sin(d.a) * 8, owner: d.origin, age: 0 });
            } else if (d.action === 'HIT') {
                if (d.target === SYS.myId) {
                    s.health -= 15;
                    if (s.health <= 0) spaceLose();
                    else try { navigator.vibrate(50); } catch (e) { }
                }
                spaceSpawnParticles(d.x, d.y, d.color || 'white', 5);
            } else if (d.action === 'EXPLODE') {
                spaceSpawnParticles(d.x, d.y, d.color || 'white', 20);
                if (d.origin !== SYS.myId) showToast(`${d.senderName || 'Peer'} was destroyed!`);
            }
        }

        function gamesIsHost() { return String(SYS.myId) < String(SYS.remotePeerId); }

        // --- MULTI-GAME UI NAVIGATION ---
        function switchGameTab(gameId) {
            SYS.activeGame = gameId;
            const tabs = ['rt', 'ttt', 'rps', 'tap', 'chess'];
            tabs.forEach(t => {
                const btn = document.getElementById('tab-game-' + t);
                const area = document.getElementById('g-area-' + t);
                if (area) area.classList.add('hidden');
                if (btn) {
                    btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                    btn.classList.add('bg-slate-100', 'text-slate-500');
                }
            });
            document.getElementById('g-area-' + gameId).classList.remove('hidden');
            document.getElementById('tab-game-' + gameId).classList.remove('bg-slate-100', 'text-slate-500');
            document.getElementById('tab-game-' + gameId).classList.add('bg-blue-600', 'text-white', 'shadow-md');

            // Re-render current
            if (gameId === 'ttt') tttRender();
            if (gameId === 'rps') rpsUpdateUI();
            if (gameId === 'tap') tapUpdateUI();
            if (gameId === 'rt') rtUpdateUI();
            if (gameId === 'chess') chessRender();
            if (gameId === 'space') spaceInit();
        }

        function gamesInitUI() {
            rtUpdateUI();
            tttRender();
            rpsUpdateUI();
            tapUpdateUI();
            chessRender();
            if (SYS.activeGame === 'space') spaceInit();
        }

        // --- GAME 6: SPACE BATTLE (2D MESH) ---
        // --- GAME 6: SPACE BATTLE (ULTIMATE P2P) ---
        function spaceInit() {
            const canvas = document.getElementById('space-canvas');
            if (!canvas) return;
            const s = SYS.space;
            s.canvas = canvas; s.ctx = canvas.getContext('2d');

            const resize = () => {
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
            };
            window.addEventListener('resize', resize);
            resize();

            if (!s.loopStarted) {
                s.loopStarted = true;
                requestAnimationFrame(spaceLoop);
            }

            // Controls
            window.addEventListener('keydown', e => { if (SYS.activeGame === 'space') s.keys[e.code] = true; });
            window.addEventListener('keyup', e => { if (SYS.activeGame === 'space') s.keys[e.code] = false; });
            canvas.addEventListener('mousedown', () => { if (SYS.activeGame === 'space' && s.active) spaceFire(); });

            if (!s.color) {
                const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4'];
                s.color = colors[Math.floor(Math.random() * colors.length)];
            }
        }

        function spaceStart() {
            const s = SYS.space;
            s.active = true; s.health = 100;
            s.x = Math.random() * s.canvas.width;
            s.y = Math.random() * s.canvas.height;
            s.vx = 0; s.vy = 0; s.a = 0;
            document.getElementById('space-overlay').classList.add('opacity-0', 'pointer-events-none');
            showToast("🚀 Combat Systems Online!");
        }

        function spaceFire() {
            const s = SYS.space;
            const b = { x: s.x + Math.cos(s.a) * 15, y: s.y + Math.sin(s.a) * 15, a: s.a };
            broadcast({ type: 'SPACE', action: 'FIRE', ...b });
            s.bullets.push({ ...b, vx: Math.cos(s.a) * 10, vy: Math.sin(s.a) * 10, owner: SYS.myId, age: 0 });
            try { navigator.vibrate(10); } catch (e) { }
        }

        function spaceLose() {
            const s = SYS.space;
            s.active = false;
            broadcast({ type: 'SPACE', action: 'EXPLODE', x: s.x, y: s.y, color: s.color });
            spaceSpawnParticles(s.x, s.y, s.color, 30);
            document.getElementById('space-overlay').classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('space-overlay').querySelector('.text-white').innerText = "SHIP DESTROYED!";
            showToast("💥 You were VAPORIZED!");
        }

        function spaceSpawnParticles(x, y, color, count) {
            for (let i = 0; i < count; i++) {
                SYS.space.particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    life: 1.0, color
                });
            }
        }

        function spaceLoop(ts) {
            const s = SYS.space;
            if (!s.canvas || SYS.activeGame !== 'space') { requestAnimationFrame(spaceLoop); return; }
            const { ctx, canvas } = s;

            // Background
            ctx.fillStyle = '#020617';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Dynamic Stars
            ctx.fillStyle = '#ffffff44';
            for (let i = 0; i < 80; i++) {
                let x = (i * 137.5) % canvas.width;
                let y = (i * 241.2) % canvas.height;
                ctx.fillRect(x, y, i % 3 === 0 ? 2 : 1, i % 3 === 0 ? 2 : 1);
            }

            if (s.active) {
                // Physics: Thrust
                if (s.keys['KeyW'] || s.keys['ArrowUp']) {
                    s.vx += Math.cos(s.a) * 0.2;
                    s.vy += Math.sin(s.a) * 0.2;
                }
                // Rotation
                if (s.keys['KeyA'] || s.keys['ArrowLeft']) s.a -= 0.08;
                if (s.keys['KeyD'] || s.keys['ArrowRight']) s.a += 0.08;

                // Physics: Friction & Move
                s.vx *= 0.985; s.vy *= 0.985;
                s.x += s.vx; s.y += s.vy;

                // Bounds Wrap
                if (s.x < 0) s.x = canvas.width; if (s.x > canvas.width) s.x = 0;
                if (s.y < 0) s.y = canvas.height; if (s.y > canvas.height) s.y = 0;

                // Synchronization
                if (ts - s.lastUpdate > 45) {
                    broadcast({ type: 'SPACE', action: 'MOVE', x: Math.round(s.x), y: Math.round(s.y), a: s.a.toFixed(2), color: s.color, health: s.health });
                    s.lastUpdate = ts;
                }

                drawShip(ctx, s.x, s.y, s.a, s.color, "YOU", s.health);
            }

            // Draw Peers
            s.players.forEach((p, id) => {
                if (!SYS.peers.has(id)) { s.players.delete(id); return; }
                drawShip(ctx, p.x, p.y, parseFloat(p.a), p.color, p.name, p.health);
            });

            // Particles
            s.particles = s.particles.filter(p => {
                p.x += p.vx; p.y += p.vy; p.life -= 0.02;
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 2, 2);
                ctx.globalAlpha = 1;
                return p.life > 0;
            });

            // Bullets & Collisions
            ctx.fillStyle = '#fbbf24';
            s.bullets = s.bullets.filter(b => {
                b.x += b.vx; b.y += b.vy; b.age++;
                ctx.beginPath(); ctx.arc(b.x, b.y, 2.5, 0, Math.PI * 2); ctx.fill();

                // My bullets hitting peers
                if (b.owner === SYS.myId) {
                    s.players.forEach((p, id) => {
                        let dx = b.x - p.x, dy = b.y - p.y;
                        if (Math.sqrt(dx * dx + dy * dy) < 18) {
                            broadcast({ type: 'SPACE', action: 'HIT', target: id, x: b.x, y: b.y, color: p.color });
                            spaceSpawnParticles(b.x, b.y, '#fbbf24', 5);
                            b.age = 1000;
                        }
                    });
                }

                return b.age < 80;
            });

            document.getElementById('space-count').innerText = `LIVE: ${s.players.size + (s.active ? 1 : 0)}`;
            requestAnimationFrame(spaceLoop);
        }

        function drawShip(ctx, x, y, a, color, name, health) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(a);

            // Engine Trail if moving
            if (name === "YOU" && (SYS.space.keys['KeyW'] || SYS.space.keys['ArrowUp'])) {
                ctx.fillStyle = '#f97316';
                ctx.beginPath(); ctx.moveTo(-10, 0); ctx.lineTo(-20, 5); ctx.lineTo(-20, -5); ctx.fill();
            }

            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(15, 0); ctx.lineTo(-10, 10); ctx.lineTo(-10, -10); ctx.closePath();
            ctx.fill();
            ctx.strokeStyle = 'white'; ctx.lineWidth = 1.5; ctx.stroke();
            ctx.restore();

            // Label & Health
            ctx.fillStyle = 'white';
            ctx.font = '800 10px Inter'; ctx.textAlign = 'center';
            ctx.fillText(name.toUpperCase(), x, y + 28);

            // Health bar
            ctx.fillStyle = '#1e293b'; ctx.fillRect(x - 15, y + 33, 30, 4);
            ctx.fillStyle = health > 50 ? '#10b981' : health > 20 ? '#f59e0b' : '#ef4444';
            ctx.fillRect(x - 15, y + 33, 30 * (health / 100), 4);
        }

        // --- MESH HEALTH DASHBOARD ---
        function updateMeshStats() {
            const list = document.getElementById('peer-mesh-list');
            if (!list) return;

            // Keep "ME" card, refresh the rest
            const meCard = list.firstElementChild;
            list.innerHTML = '';
            list.appendChild(meCard);

            document.getElementById('mesh-me-name').innerText = (SYS.myName || 'YOU') + ' (HOST)';

            SYS.peers.forEach((conn, id) => {
                const stats = SYS.peerStats.get(id) || { ping: '...' };
                const name = SYS.peerNames.get(id) || id.substring(0, 5);
                const color = stats.ping < 100 ? 'bg-emerald-500' : stats.ping < 300 ? 'bg-yellow-500' : 'bg-red-500';

                // Swarm Logic: Is this peer helping us seed?
                let swarmBadge = '';
                SYS.swarms.forEach(s => {
                    if (s.peerAvailability.has(id)) {
                        swarmBadge = `<div class="mt-1 flex items-center gap-1.5 animate-pulse">
                            <i class="fas fa-microchip text-[8px] text-blue-500"></i>
                            <span class="text-[7px] font-black text-blue-500 uppercase tracking-tighter">Swarm Seeding Chunks</span>
                        </div>`;
                    }
                });

                const card = document.createElement('div');
                card.className = "bg-white border-2 border-slate-200 p-4 rounded-2xl shadow-sm flex items-center gap-4 group hover:border-blue-400 transition-all animate-slide-in";
                card.innerHTML = `
                    <div class="w-10 h-10 rounded-xl bg-slate-100 text-slate-600 flex items-center justify-center shrink-0 font-black text-lg">${name[0].toUpperCase()}</div>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs font-black text-slate-800 truncate uppercase mt-1">${name}</div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="w-1.5 h-1.5 rounded-full ${color} shadow-[0_0_8px_currentColor]"></span>
                            <span class="text-[9px] font-bold text-slate-400 font-mono tracking-tighter">${stats.ping}ms SECURE</span>
                        </div>
                        ${swarmBadge}
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // --- GAME 1: REACTION DUEL ---
        function rtSetStatus(txt) { document.getElementById('rt-status').innerText = txt; }
        function rtUpdateUI() {
            const s = SYS.games.rt, btn = document.getElementById('rt-big');
            document.getElementById('rt-me').innerText = s.myTime != null ? `${Math.round(s.myTime)} ms` : '-';
            document.getElementById('rt-peer').innerText = s.peerTime != null ? `${Math.round(s.peerTime)} ms` : '-';
            const win = document.getElementById('rt-winner');
            win.innerText = s.winner || '-';
            win.className = `text-lg font-black uppercase ${s.winner === 'You' ? 'text-emerald-400' : s.winner === 'Peer' ? 'text-red-400' : 'text-white'}`;

            const r = () => { btn.className = "w-full max-w-[400px] aspect-[4/3] rounded-[3rem] border-4 shadow-inner active:scale-95 transition-all duration-100 flex items-center justify-center select-none outline-none font-black text-4xl"; };
            if (!SYS.remotePeerId) { r(); btn.classList.add('bg-slate-50', 'border-slate-100', 'text-slate-400'); btn.innerText = 'CONNECT'; rtSetStatus('Connect to a peer to play.'); return; }
            if (s.state === 'idle') { r(); btn.classList.add('bg-blue-600', 'border-blue-700', 'text-white', 'shadow-blue-900/50'); btn.innerText = 'START DUEL'; rtSetStatus('Tap START to begin.'); }
            else if (s.state === 'waiting') { r(); btn.classList.add('bg-red-500', 'border-red-600', 'text-white', 'shadow-red-900/50'); btn.innerText = 'WAIT...'; rtSetStatus('Wait for GREEN!'); }
            else if (s.state === 'go') { r(); btn.classList.add('bg-emerald-500', 'border-emerald-600', 'text-white', 'shadow-emerald-900/50', 'text-5xl'); btn.innerText = 'TAP NOW!'; rtSetStatus('FAST!!!'); }
            else if (s.state === 'done') { r(); btn.classList.add('bg-slate-800', 'border-slate-900', 'text-white'); btn.innerText = 'PLAY AGAIN'; rtSetStatus('Round Over.'); }
        }
        function rtReset(sync) {
            const s = SYS.games.rt; if (s.timer) clearTimeout(s.timer);
            SYS.games.rt = { state: 'idle', goAt: null, myTime: null, peerTime: null, winner: null, timer: null };
            rtUpdateUI(); if (sync) gameSend({ game: 'rt', action: 'RESET' });
        }
        function rtStartLocal(delayMs) {
            const s = SYS.games.rt; if (s.timer) clearTimeout(s.timer);
            s.state = 'waiting'; s.goAt = null; s.myTime = null; s.peerTime = null; s.winner = null; rtUpdateUI();
            s.timer = setTimeout(() => { if (gamesIsHost()) gameSend({ game: 'rt', action: 'GO' }); rtGoLocal(); }, delayMs);
        }
        function rtStartRound() {
            if (!SYS.remotePeerId) return showToast('Link peer first');
            const delayMs = 1500 + Math.floor(Math.random() * 3000);
            rtStartLocal(delayMs); gameSend({ game: 'rt', action: 'START', delayMs });
            try { navigator.vibrate(30); } catch (e) { }
        }
        function rtGoLocal() {
            const s = SYS.games.rt; if (s.timer) clearTimeout(s.timer);
            s.state = 'go'; s.goAt = performance.now(); try { navigator.vibrate([100, 50, 100]); } catch (e) { } rtUpdateUI();
        }
        function rtTap() {
            haptic(10); // Added haptic feedback
            const s = SYS.games.rt; if (!SYS.remotePeerId) return showToast('Link peer first');
            try { navigator.vibrate(20); } catch (e) { }
            if (s.state === 'idle' || s.state === 'done') return rtStartRound();
            if (s.state === 'waiting') { showToast('Too early!'); try { navigator.vibrate([200]); } catch (e) { } return; }
            if (s.state !== 'go') return;
            s.myTime = performance.now() - s.goAt; s.state = 'done';
            gameSend({ game: 'rt', action: 'TAP', ms: s.myTime }); rtComputeWinner();
        }
        function rtComputeWinner() {
            const s = SYS.games.rt; if (s.myTime == null || s.peerTime == null) return rtUpdateUI();
            if (Math.abs(s.myTime - s.peerTime) < 1) s.winner = 'Draw';
            else if (s.myTime < s.peerTime) { s.winner = 'You'; try { navigator.vibrate([50, 50, 50, 50, 150]); } catch (e) { } }
            else { s.winner = 'Peer'; try { navigator.vibrate([300]); } catch (e) { } }
            s.state = 'done'; rtUpdateUI();
        }

        // --- GAME 2: ZERO KATTA (Tic Tac Toe) ---
        function tttStatus(txt, alert = false) {
            const e = document.getElementById('ttt-status'); e.innerText = txt;
            e.className = alert ? "flex-1 mx-2 flex items-center justify-center text-xs font-black text-red-500 uppercase tracking-widest text-center bg-red-50 rounded-xl px-2" : "flex-1 mx-2 flex items-center justify-center text-xs font-black text-slate-500 uppercase tracking-widest text-center bg-slate-50 rounded-xl px-2";
        }
        function tttRender() {
            const s = SYS.games.ttt;
            const mySym = gamesIsHost() ? 'X' : 'O';
            const peerSym = mySym === 'X' ? 'O' : 'X';
            document.getElementById('ttt-my-symbol').innerText = mySym;
            document.getElementById('ttt-my-symbol').className = mySym === 'X' ? 'text-xl font-black text-blue-600' : 'text-xl font-black text-red-600';
            document.getElementById('ttt-peer-symbol').innerText = peerSym;
            document.getElementById('ttt-peer-symbol').className = peerSym === 'X' ? 'text-xl font-black text-blue-600' : 'text-xl font-black text-red-600';

            for (let i = 0; i < 9; i++) {
                const b = document.getElementById('ttt-' + i);
                b.innerText = s.board[i];
                b.className = `ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none ${s.board[i] === 'X' ? 'text-blue-500' : s.board[i] === 'O' ? 'text-red-500' : ''}`;
            }
            if (!SYS.remotePeerId) return tttStatus('Connect to Play');
            if (s.over) {
                if (s.winner === 'D') tttStatus('Draw! Reset to play.');
                else if (s.winner === mySym) tttStatus('You Won! 😎', true);
                else tttStatus('Peer Won! 💀', true);
            } else {
                tttStatus(s.turn === mySym ? 'Your Turn' : "Peer's Turn");
            }
        }
        function tttCheckWin(b) {
            const lines = [[0, 1, 2], [3, 4, 5], [6, 7, 8], [0, 3, 6], [1, 4, 7], [2, 5, 8], [0, 4, 8], [2, 4, 6]];
            for (const [x, y, z] of lines) if (b[x] && b[x] === b[y] && b[x] === b[z]) return b[x];
            return b.every(c => c) ? 'D' : null;
        }
        function tttApplyMove(idx, isMe) {
            const s = SYS.games.ttt; if (s.over || s.board[idx]) return;
            s.board[idx] = s.turn;
            const w = tttCheckWin(s.board);
            if (w) { s.over = true; s.winner = w; try { navigator.vibrate([100, 100, 100]); } catch (e) { } }
            else s.turn = s.turn === 'X' ? 'O' : 'X';
            tttRender();
        }
        function tttClick(idx) {
            haptic(10); // Added haptic feedback
            if (!SYS.remotePeerId) return showToast('Connect First');
            const s = SYS.games.ttt, mySym = gamesIsHost() ? 'X' : 'O';
            if (s.over || s.board[idx] || s.turn !== mySym) return;
            try { navigator.vibrate(20); } catch (e) { }
            tttApplyMove(idx, true); gameSend({ game: 'ttt', action: 'MOVE', idx });
        }
        function tttReset(sync) {
            SYS.games.ttt = { board: Array(9).fill(''), turn: 'X', over: false, winner: null };
            tttRender(); if (sync) gameSend({ game: 'ttt', action: 'RESET' });
        }

        // --- GAME 3: STONE PAPER SCISSOR (Blind Pick) ---
        function rpsStatus(txt) { document.getElementById('rps-status').innerText = txt; }
        function rpsUpdateUI() {
            const s = SYS.games.rps;
            const iconMap = { 'rock': 'fa-hand-rock', 'paper': 'fa-hand-paper', 'scissors': 'fa-hand-scissors' };
            const meEl = document.getElementById('rps-me'), peerEl = document.getElementById('rps-peer'), resEl = document.getElementById('rps-result');

            if (!SYS.remotePeerId) return rpsStatus('Waiting to connect...');

            // Me
            if (s.myPick) meEl.innerHTML = `<i class="fas ${iconMap[s.myPick]} text-blue-500"></i>`;
            else meEl.innerHTML = `<i class="fas fa-question text-slate-300"></i>`;

            // Peer
            if (s.result) peerEl.innerHTML = `<i class="fas ${iconMap[s.peerPick]} text-red-500"></i>`;
            else if (s.peerReady) peerEl.innerHTML = `<i class="fas fa-check-circle text-emerald-500"></i>`; // Hidden pick
            else peerEl.innerHTML = `<i class="fas fa-question text-slate-300"></i>`;

            // State
            if (s.state === 'idle') { rpsStatus('Pick your move!'); resEl.classList.add('opacity-0'); }
            else if (s.state === 'waiting') rpsStatus('Waiting for peer...');
            else if (s.state === 'done') {
                rpsStatus('Round Complete');
                resEl.classList.remove('opacity-0');
                if (s.result === 'Draw') { resEl.innerText = 'DRAW'; resEl.className = 'mt-6 w-full max-w-[400px] bg-slate-400 rounded-2xl p-4 text-center text-lg font-black text-white uppercase transition-opacity'; }
                else if (s.result === 'Win') { resEl.innerText = 'YOU WIN!'; resEl.className = 'mt-6 w-full max-w-[400px] bg-emerald-500 rounded-2xl p-4 text-center text-lg font-black text-white uppercase transition-opacity shadow-lg shadow-emerald-200'; try { navigator.vibrate([50, 50, 50, 150]); } catch (e) { } }
                else { resEl.innerText = 'PEER WINS'; resEl.className = 'mt-6 w-full max-w-[400px] bg-red-500 rounded-2xl p-4 text-center text-lg font-black text-white uppercase transition-opacity shadow-lg shadow-red-200'; try { navigator.vibrate([200]); } catch (e) { } }
            }
        }
        function rpsPick(pick) {
            haptic(10); // Added haptic feedback
            const s = SYS.games.rps;
            if (!SYS.remotePeerId) return showToast('Connect First');
            if (s.state === 'done') return showToast('Reset round first');
            if (s.myPick) return; // Already picked

            try { navigator.vibrate(20); } catch (e) { }
            s.myPick = pick;
            s.state = 'waiting';
            gameSend({ game: 'rps', action: 'READY' });
            rpsUpdateUI();

            // Auto-reveal if peer is already ready
            if (s.peerReady) {
                gameSend({ game: 'rps', action: 'REVEAL', pick: pick });
                if (s.peerPick) rpsCompute(); // If they somehow revealed early
            }
        }
        function rpsCompute() {
            const s = SYS.games.rps;
            if (!s.myPick || !s.peerPick) return;
            const a = s.myPick, b = s.peerPick;
            if (a === b) s.result = 'Draw';
            else if ((a === 'rock' && b === 'scissors') || (a === 'paper' && b === 'rock') || (a === 'scissors' && b === 'paper')) s.result = 'Win';
            else s.result = 'Lose';
            s.state = 'done';
            rpsUpdateUI();
        }
        function rpsReset(sync) {
            SYS.games.rps = { state: 'idle', myPick: null, peerReady: false, peerPick: null, result: null };
            rpsUpdateUI(); if (sync) gameSend({ game: 'rps', action: 'RESET' });
        }

        // --- GAME 4: TAP WAR ---
        function tapStatus(txt) { document.getElementById('tap-status').innerText = txt; }
        function tapUpdateUI() {
            const s = SYS.games.tap, bar = document.getElementById('tap-bar'), scoreEl = document.getElementById('tap-my-score'), btn = document.getElementById('tap-btn');
            if (!SYS.remotePeerId) return tapStatus('Connect to Play');

            bar.style.width = s.score + '%';
            scoreEl.innerText = s.score;

            if (s.over) {
                btn.classList.add('opacity-50', 'pointer-events-none');
                if (s.score >= 100) tapStatus('YOU DOMINATED! 💪');
                else tapStatus('YOU LOST. GET FASTER. 💀');
            } else {
                btn.classList.remove('opacity-50', 'pointer-events-none');
                tapStatus('PULL THE ROPE!');
            }
        }
        function tapClick() {
            haptic(10); // Added haptic feedback
            const s = SYS.games.tap;
            if (!SYS.remotePeerId || s.over) return;
            s.score += 2; // Pull force
            if (s.score >= 100) { s.score = 100; s.over = true; try { navigator.vibrate([100, 50, 100, 50, 200]); } catch (e) { } }
            else try { navigator.vibrate(10); } catch (e) { }
            tapUpdateUI();
            gameSend({ game: 'tap', action: 'PULL' });
        }
        function tapApplyPeerPull() {
            const s = SYS.games.tap;
            if (s.over) return;
            s.score -= 2; // Peer pulls
            if (s.score <= 0) { s.score = 0; s.over = true; try { navigator.vibrate([300]); } catch (e) { } }
            tapUpdateUI();
        }
        function tapReset(sync) {
            SYS.games.tap = { state: 'idle', score: 50, over: false };
            tapUpdateUI(); if (sync) gameSend({ game: 'tap', action: 'RESET' });
        }

        // --- GAME 5: CHESS ---
        const PU = { 'K': '♚', 'Q': '♛', 'R': '♜', 'B': '♝', 'N': '♞', 'P': '♟', 'k': '♚', 'q': '♛', 'r': '♜', 'b': '♝', 'n': '♞', 'p': '♟' };
        function cColor(p) { if (!p) return null; return p === p.toUpperCase() ? 'w' : 'b'; }
        function cOn(r, c) { return r >= 0 && r < 8 && c >= 0 && c < 8; }
        function cIsAttacked(bd, r, c, by) {
            for (let rr = 0; rr < 8; rr++)for (let cc = 0; cc < 8; cc++) {
                let p = bd[rr][cc]; if (!p || cColor(p) !== by) continue;
                let t = p.toUpperCase(), dr = r - rr, dc = c - cc;
                if (t === 'P') { let dir = by === 'w' ? -1 : 1; if (rr + dir === r && Math.abs(dc) === 1) return true; }
                else if (t === 'N') { if ((Math.abs(dr) === 2 && Math.abs(dc) === 1) || (Math.abs(dr) === 1 && Math.abs(dc) === 2)) return true; }
                else if (t === 'K') { if (Math.abs(dr) <= 1 && Math.abs(dc) <= 1 && (dr || dc)) return true; }
                else if (t === 'B' || t === 'Q') {
                    if (Math.abs(dr) === Math.abs(dc) && dr !== 0) {
                        let sr = dr > 0 ? 1 : -1, sc = dc > 0 ? 1 : -1, nr = rr + sr, nc = cc + sc, ok = true;
                        while (nr !== r || nc !== c) { if (bd[nr][nc]) { ok = false; break; } nr += sr; nc += sc; }
                        if (ok) return true;
                    }
                }
                if (t === 'R' || t === 'Q') {
                    if ((dr === 0 || dc === 0) && (dr || dc)) {
                        let sr = dr === 0 ? 0 : (dr > 0 ? 1 : -1), sc = dc === 0 ? 0 : (dc > 0 ? 1 : -1), nr = rr + sr, nc = cc + sc, ok = true;
                        while (nr !== r || nc !== c) { if (bd[nr][nc]) { ok = false; break; } nr += sr; nc += sc; }
                        if (ok) return true;
                    }
                }
            }
            return false;
        }
        function cFindKing(bd, col) { let k = col === 'w' ? 'K' : 'k'; for (let r = 0; r < 8; r++)for (let c = 0; c < 8; c++)if (bd[r][c] === k) return [r, c]; return null; }
        function cInCheck(bd, col) { let [kr, kc] = cFindKing(bd, col); return cIsAttacked(bd, kr, kc, col === 'w' ? 'b' : 'w'); }
        function cPseudo(bd, r, c, cs) {
            let p = bd[r][c]; if (!p) return []; let col = cColor(p), t = p.toUpperCase(), mv = [];
            let add = (tr, tc) => { if (cOn(tr, tc)) { let tp = bd[tr][tc]; if (!tp || cColor(tp) !== col) mv.push([tr, tc]); } };
            if (t === 'P') {
                let dir = col === 'w' ? -1 : 1, sr = col === 'w' ? 6 : 1;
                if (cOn(r + dir, c) && !bd[r + dir][c]) { mv.push([r + dir, c]); if (r === sr && !bd[r + 2 * dir][c]) mv.push([r + 2 * dir, c]); }
                for (let dc of [-1, 1]) if (cOn(r + dir, c + dc)) {
                    if (bd[r + dir][c + dc] && cColor(bd[r + dir][c + dc]) !== col) mv.push([r + dir, c + dc]);
                    if (cs.enPassant && cs.enPassant[0] === r + dir && cs.enPassant[1] === c + dc) mv.push([r + dir, c + dc]);
                }
            }
            if (t === 'N') { for (let [dr, dc] of [[-2, -1], [-2, 1], [-1, -2], [-1, 2], [1, -2], [1, 2], [2, -1], [2, 1]]) add(r + dr, c + dc); }
            if (t === 'B' || t === 'Q') { for (let [dr, dc] of [[-1, -1], [-1, 1], [1, -1], [1, 1]]) { let nr = r + dr, nc = c + dc; while (cOn(nr, nc)) { if (!bd[nr][nc]) mv.push([nr, nc]); else { if (cColor(bd[nr][nc]) !== col) mv.push([nr, nc]); break; } nr += dr; nc += dc; } } }
            if (t === 'R' || t === 'Q') { for (let [dr, dc] of [[-1, 0], [1, 0], [0, -1], [0, 1]]) { let nr = r + dr, nc = c + dc; while (cOn(nr, nc)) { if (!bd[nr][nc]) mv.push([nr, nc]); else { if (cColor(bd[nr][nc]) !== col) mv.push([nr, nc]); break; } nr += dr; nc += dc; } } }
            if (t === 'K') {
                for (let [dr, dc] of [[-1, -1], [-1, 0], [-1, 1], [0, -1], [0, 1], [1, -1], [1, 0], [1, 1]]) add(r + dr, c + dc);
                let en = col === 'w' ? 'b' : 'w';
                if (col === 'w') {
                    if (cs.castling.wK && bd[7][5] === '' && bd[7][6] === '' && bd[7][7] === 'R' && !cIsAttacked(bd, 7, 4, en) && !cIsAttacked(bd, 7, 5, en) && !cIsAttacked(bd, 7, 6, en)) mv.push([7, 6]);
                    if (cs.castling.wQ && bd[7][3] === '' && bd[7][2] === '' && bd[7][1] === '' && bd[7][0] === 'R' && !cIsAttacked(bd, 7, 4, en) && !cIsAttacked(bd, 7, 3, en) && !cIsAttacked(bd, 7, 2, en)) mv.push([7, 2]);
                } else {
                    if (cs.castling.bK && bd[0][5] === '' && bd[0][6] === '' && bd[0][7] === 'r' && !cIsAttacked(bd, 0, 4, en) && !cIsAttacked(bd, 0, 5, en) && !cIsAttacked(bd, 0, 6, en)) mv.push([0, 6]);
                    if (cs.castling.bQ && bd[0][3] === '' && bd[0][2] === '' && bd[0][1] === '' && bd[0][0] === 'r' && !cIsAttacked(bd, 0, 4, en) && !cIsAttacked(bd, 0, 3, en) && !cIsAttacked(bd, 0, 2, en)) mv.push([0, 2]);
                }
            }
            return mv;
        }
        function cLegal(bd, r, c, cs) {
            let p = bd[r][c]; if (!p) return []; let col = cColor(p), mvs = cPseudo(bd, r, c, cs), legal = [];
            for (let [tr, tc] of mvs) {
                let nb = bd.map(rw => [...rw]), cap = nb[tr][tc];
                nb[tr][tc] = nb[r][c]; nb[r][c] = '';
                if (p.toUpperCase() === 'P' && cs.enPassant && tr === cs.enPassant[0] && tc === cs.enPassant[1]) nb[r][tc] = '';
                if (p.toUpperCase() === 'K' && Math.abs(c - tc) === 2) { if (tc === 6) { nb[r][5] = nb[r][7]; nb[r][7] = ''; } if (tc === 2) { nb[r][3] = nb[r][0]; nb[r][0] = ''; } }
                if (!cInCheck(nb, col)) legal.push([tr, tc]);
            }
            return legal;
        }
        function cHasLegal(bd, col, cs) { for (let r = 0; r < 8; r++)for (let c = 0; c < 8; c++) { if (bd[r][c] && cColor(bd[r][c]) === col && cLegal(bd, r, c, cs).length > 0) return true; } return false; }
        function chessDoMove(fr, fc, tr, tc, promo) {
            let s = SYS.games.chess, bd = s.board, p = bd[fr][fc], col = cColor(p);
            let cap = bd[tr][tc];
            if (p.toUpperCase() === 'P' && s.enPassant && tr === s.enPassant[0] && tc === s.enPassant[1]) { cap = bd[fr][tc]; bd[fr][tc] = ''; }
            if (cap) s.captured[cColor(cap)].push(cap);
            bd[tr][tc] = p; bd[fr][fc] = '';
            if (p.toUpperCase() === 'K' && Math.abs(fc - tc) === 2) { if (tc === 6) { bd[tr][5] = bd[tr][7]; bd[tr][7] = ''; } if (tc === 2) { bd[tr][3] = bd[tr][0]; bd[tr][0] = ''; } }
            s.enPassant = null;
            if (p.toUpperCase() === 'P' && Math.abs(fr - tr) === 2) s.enPassant = [(fr + tr) / 2, fc];
            if (p === 'K') { s.castling.wK = false; s.castling.wQ = false; } if (p === 'k') { s.castling.bK = false; s.castling.bQ = false; }
            if (fr === 7 && fc === 0) s.castling.wQ = false; if (fr === 7 && fc === 7) s.castling.wK = false;
            if (fr === 0 && fc === 0) s.castling.bQ = false; if (fr === 0 && fc === 7) s.castling.bK = false;
            if (p.toUpperCase() === 'P' && (tr === 0 || tr === 7)) { let pp = promo || 'Q'; bd[tr][tc] = col === 'w' ? pp : pp.toLowerCase(); }
            s.turn = s.turn === 'w' ? 'b' : 'w';
            let opp = s.turn;
            s.inCheck = cInCheck(bd, opp);
            if (!cHasLegal(bd, opp, s)) { s.over = true; s.winner = s.inCheck ? (opp === 'w' ? 'Black' : 'White') : 'Draw'; }
        }
        function chessMyColor() { return gamesIsHost() ? 'w' : 'b'; }
        function chessRender() {
            let s = SYS.games.chess, bd = s.board, el = document.getElementById('chess-board');
            el.innerHTML = ''; let myCol = chessMyColor(), flip = myCol === 'b';
            for (let ri = 0; ri < 8; ri++) {
                for (let ci = 0; ci < 8; ci++) {
                    let r = flip ? 7 - ri : ri, c = flip ? 7 - ci : ci;
                    let sq = document.createElement('div'), light = (r + c) % 2 === 0;
                    sq.className = `chess-sq ${light ? 'chess-sq-light' : 'chess-sq-dark'}`;
                    let p = bd[r][c];
                    if (p) sq.innerHTML = `<span class="chess-piece-${cColor(p)}">${PU[p]}</span>`;
                    if (s.selected && s.selected[0] === r && s.selected[1] === c) sq.classList.add('chess-sq-selected');
                    if (s.validMoves.some(m => m[0] === r && m[1] === c)) { if (p && cColor(p) !== myCol) sq.classList.add('chess-sq-capture'); else sq.classList.add('chess-sq-valid'); }
                    if (s.inCheck && p && p.toUpperCase() === 'K' && cColor(p) === s.turn) sq.classList.add('chess-sq-check');
                    sq.onclick = () => chessClick(r, c);
                    el.appendChild(sq);
                }
            }
            let stEl = document.getElementById('chess-status');
            if (!SYS.remotePeerId) { stEl.innerText = (s.turn === 'w' ? 'White' : 'Black') + ' to move (Practice Mode)'; stEl.className = 'flex-1 mx-2 flex items-center justify-center text-xs font-black text-blue-600 uppercase tracking-widest text-center bg-blue-50 rounded-xl px-2'; }
            else if (s.over) { stEl.innerText = s.winner === 'Draw' ? 'Stalemate!' : s.winner + ' Wins! Checkmate!'; stEl.className = 'flex-1 mx-2 flex items-center justify-center text-xs font-black text-red-600 uppercase tracking-widest text-center bg-red-50 rounded-xl px-2'; }
            else { let isMyTurn = s.turn === myCol; stEl.innerText = isMyTurn ? 'Your Turn' + (s.inCheck ? ' (CHECK!)' : '') : "Opponent's Turn" + (s.inCheck ? ' (CHECK!)' : ''); stEl.className = 'flex-1 mx-2 flex items-center justify-center text-xs font-black uppercase tracking-widest text-center rounded-xl px-2 ' + (isMyTurn ? 'text-blue-600 bg-blue-50' : 'text-slate-500 bg-slate-50 shadow-inner'); }
            document.getElementById('chess-captured-w').innerHTML = s.captured.w.map(x => `<span class="chess-piece-w">${PU[x]}</span>`).join('');
            document.getElementById('chess-captured-b').innerHTML = s.captured.b.map(x => `<span class="chess-piece-b">${PU[x]}</span>`).join('');
        }
        function chessClick(r, c) {
            haptic(10); // Added haptic feedback
            let s = SYS.games.chess, myCol = chessMyColor();
            // Allow solo play if not connected for testing/practice
            const isSolo = !SYS.remotePeerId;
            const currentTurn = s.turn;

            if (s.over || (!isSolo && currentTurn !== myCol)) return;

            if (s.selected) {
                if (s.validMoves.some(m => m[0] === r && m[1] === c)) {
                    let p = s.board[s.selected[0]][s.selected[1]];
                    if (p.toUpperCase() === 'P' && (r === 0 || r === 7)) {
                        s.promoData = { fr: s.selected[0], fc: s.selected[1], tr: r, tc: c };
                        chessShowPromo();
                        return;
                    }
                    chessExecMove(s.selected[0], s.selected[1], r, c, null);
                } else {
                    s.selected = null;
                    s.validMoves = [];
                    if (s.board[r][c] && cColor(s.board[r][c]) === currentTurn) {
                        s.selected = [r, c];
                        s.validMoves = cLegal(s.board, r, c, s);
                    }
                    chessRender();
                }
            } else {
                if (s.board[r][c] && cColor(s.board[r][c]) === currentTurn) {
                    s.selected = [r, c];
                    s.validMoves = cLegal(s.board, r, c, s);
                    try { navigator.vibrate(15); } catch (e) { }
                }
                chessRender();
            }
        }
        function chessShowPromo() {
            let d = SYS.games.chess.promoData, col = chessMyColor(), modal = document.getElementById('chess-promo-modal'), ch = document.getElementById('chess-promo-choices');
            ch.innerHTML = '';['Q', 'R', 'B', 'N'].forEach(t => {
                let btn = document.createElement('button');
                btn.className = 'w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center text-4xl hover:bg-blue-100 active:scale-95 transition chess-piece-' + (col === 'w' ? 'w' : 'b');
                btn.innerHTML = PU[col === 'w' ? t : t.toLowerCase()];
                btn.onclick = () => { modal.classList.add('hidden'); chessExecMove(d.fr, d.fc, d.tr, d.tc, t); };
                ch.appendChild(btn);
            });
            modal.classList.remove('hidden');
        }
        function chessExecMove(fr, fc, tr, tc, promo) {
            let s = SYS.games.chess; s.selected = null; s.validMoves = [];
            chessDoMove(fr, fc, tr, tc, promo);
            gameSend({ game: 'chess', action: 'MOVE', fr, fc, tr, tc, promo });
            try { navigator.vibrate(20); } catch (e) { }
            chessRender();
        }
        function chessApplyRemoteMove(fr, fc, tr, tc, promo) {
            chessDoMove(fr, fc, tr, tc, promo);
            try { navigator.vibrate([30, 30, 30]); } catch (e) { }
            chessRender();
        }
        function chessReset(sync) {
            SYS.games.chess = chessNewState();
            chessRender(); if (sync) gameSend({ game: 'chess', action: 'RESET' });
        }

        // --- VOICE RECORDING (Secure P2P) ---
        let voiceRecordStart = 0;
        let voiceTimerInterval = null;
        async function startVoiceRec() {
            if (SYS.isRecording) return;
            try {
                let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                SYS.voiceRecorder = new MediaRecorder(stream); SYS.voiceChunks = []; SYS.isRecording = true;
                voiceRecordStart = Date.now();
                SYS.voiceRecorder.ondataavailable = e => SYS.voiceChunks.push(e.data);
                SYS.voiceRecorder.onstop = () => {
                    const duration = Math.round((Date.now() - voiceRecordStart) / 1000);
                    if (voiceTimerInterval) { clearInterval(voiceTimerInterval); voiceTimerInterval = null; }
                    let blob = new Blob(SYS.voiceChunks, { type: 'audio/webm' });
                    let reader = new FileReader();
                    reader.onload = () => { broadcast({ type: 'VOICE', data: reader.result, dur: duration }); addVoiceChat(reader.result, true, duration); };
                    reader.readAsDataURL(blob);
                    stream.getTracks().forEach(t => t.stop()); SYS.isRecording = false;
                    const vb = document.getElementById('voice-btn');
                    vb.classList.remove('voice-recording', 'bg-red-500', 'text-white');
                    vb.classList.add('bg-slate-200', 'text-slate-600');
                    vb.innerHTML = '<i class="fas fa-microphone"></i>';
                };
                SYS.voiceRecorder.start();
                const vb = document.getElementById('voice-btn');
                vb.classList.remove('bg-slate-200', 'text-slate-600');
                vb.classList.add('voice-recording', 'bg-red-500', 'text-white');
                // Show live timer on button
                voiceTimerInterval = setInterval(() => {
                    const elapsed = Math.round((Date.now() - voiceRecordStart) / 1000);
                    vb.innerHTML = `<span class="text-[10px] font-mono font-bold">${elapsed}s</span>`;
                }, 500);
                showToast('🎙️ Recording... Release to Send (Secure)');
            } catch (e) { showToast('Mic Error: ' + e.message); }
        }
        function stopVoiceRec() {
            if (SYS.voiceRecorder && SYS.voiceRecorder.state === 'recording') { SYS.voiceRecorder.stop(); }
        }
        function addVoiceChat(dataUrl, isMe, duration = 0, senderId = null) {
            let box = document.getElementById('chat-container'), d = document.createElement('div');
            d.className = `flex ${isMe ? 'justify-end' : 'justify-start'} animate-[fadeIn_0.2s]`;
            const durText = duration > 0 ? `${duration}s` : '';
            const pName = senderId ? (SYS.peerNames.get(senderId) || senderId.substring(0, 5)) : 'ME';
            const senderLabel = isMe ? 'YOU' : pName;
            d.innerHTML = `<div class="max-w-[85%] md:max-w-[70%] px-3 py-2 rounded-2xl shadow-sm ${isMe ? 'bg-blue-600 rounded-tr-sm' : 'bg-white border border-slate-200 rounded-tl-sm'}">
                <div class="text-[9px] font-black tracking-widest mb-1 ${isMe ? 'text-blue-200' : 'text-slate-400'} uppercase">${senderLabel}</div>
                <div class="flex items-center gap-2">
                    <i class="fas fa-microphone ${isMe ? 'text-blue-200' : 'text-blue-500'} text-xs"></i>
                    <audio controls src="${dataUrl}" class="h-8" style="max-width:200px;"></audio>
                </div>
                <div class="flex items-center justify-between gap-3 mt-1">
                    <div class="flex items-center gap-1.5">
                        <span class="secure-badge-voice inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[8px] text-white font-bold">
                            <i class="fas fa-shield-halved"></i> E2E
                        </span>
                        <span class="text-[10px] ${isMe ? 'text-blue-200' : 'text-slate-400'}">Voice ${durText}</span>
                    </div>
                </div>
            </div>`;
            box.appendChild(d); box.scrollTop = box.scrollHeight;
            if (!isMe && document.getElementById('view-chat').classList.contains('hidden')) showToast('New Secure Voice Message 🎙️🔒');
        }
        function saveAllFiles() {
            const links = document.querySelectorAll('#transfer-list a[download]');
            if (links.length === 0) return showToast("No files to save");
            links.forEach((a, i) => {
                setTimeout(() => a.click(), i * 300); // Small delay to prevent browser blocking
            });
            showToast(`Saving ${links.length} files...`);
        }

        function acceptCall() {
            document.getElementById('incoming-modal').classList.add('hidden');
            if (!SYS.pendingCall) return;
            const peerId = SYS.pendingCall.peer;
            const type = (SYS.pendingCall.metadata && SYS.pendingCall.metadata.type) ? SYS.pendingCall.metadata.type : 'video';

            // Answer with our current video stream if it exists, otherwise an empty stream
            // This allows us to see the caller's stream without being forced to start our own
            const responseStream = SYS.localStream || SYS.localScreen || new MediaStream();

            SYS.pendingCall.answer(responseStream);
            handleStream(SYS.pendingCall, type);
            switchTab('video');
            showToast(`Connected to ${type.toUpperCase()} from Peer`);
        }

        async function startCall(type) {
            if (SYS.peers.size === 0) return showToast("No Peers Linked");

            // Feature support check
            if (type === 'screen' && (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia)) {
                return showToast("Screen sharing NOT supported on this browser/device");
            }

            try {
                let stream;
                if (type === 'screen') {
                    if (SYS.localScreen) return showToast("Already sharing screen");
                    // Simplified constraints for max compatibility
                    stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    SYS.localScreen = stream;
                    stream.getVideoTracks()[0].onended = () => endSpecificCall('screen');
                } else {
                    if (SYS.localStream) return showToast("Camera already active");
                    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    SYS.localStream = stream;
                }

                // Call all peers with the new stream
                SYS.peers.forEach((conn, id) => {
                    const call = SYS.peer.call(id, stream, { metadata: { type: type } });
                    handleStream(call, type);
                });

                switchTab('video');
                renderLocalPreview(stream, type);
                showToast(`${type.toUpperCase()} Started!`);
            } catch (e) {
                console.error(e);
                showToast(`${type.toUpperCase()} Error: ` + (e.name === 'NotAllowedError' ? "Permission Denied" : e.message));
            }
        }

        function renderLocalPreview(stream, type) {
            let containerId = `local-container-${type}`;
            let container = document.getElementById(containerId);
            if (!container) {
                container = createVideoContainer(containerId, `YOU (${type.toUpperCase()})`, true);
                document.getElementById('video-grid').appendChild(container);
            }
            const vid = container.querySelector('video');
            vid.srcObject = stream;
            vid.muted = true;
            vid.play().catch(e => console.log("Local Preview Autoplay Blocked", e));
            updateVideoGridLayout();
        }

        function handleStream(call, type) {
            const peerId = call.peer;
            const callKey = `${peerId}-${type}`;
            SYS.calls.set(callKey, call);
            document.getElementById('call-placeholder').classList.add('hidden');

            call.on('stream', remoteStream => {
                const containerId = `video-container-${callKey}`;
                let vidContainer = document.getElementById(containerId);
                if (!vidContainer) {
                    const name = (SYS.peerNames.get(peerId) || peerId.substring(0, 5)).toUpperCase();
                    vidContainer = createVideoContainer(containerId, `${name} (${type.toUpperCase()})`);
                    document.getElementById('video-grid').appendChild(vidContainer);
                    updateVideoGridLayout();
                }
                const vid = vidContainer.querySelector('video');
                vid.srcObject = remoteStream;
                vid.play().catch(e => console.log("Auto-play blocked", e));
            });

            call.on('close', () => removePeerVideo(callKey));
            call.on('error', () => removePeerVideo(callKey));
        }

        function createVideoContainer(id, label, isLocal = false) {
            const div = document.createElement('div');
            div.id = id;
            div.className = "relative bg-black rounded-2xl overflow-hidden border-2 border-white/10 shadow-lg group transition-all duration-500 animate-float h-full";
            div.innerHTML = `
                <div class="video-wrapper w-full h-full overflow-hidden flex items-center justify-center">
                    <video autoplay playsinline class="w-full h-full object-contain transition-transform duration-200" style="transform: scale(1)"></video>
                </div>
                <!-- Controls Overlay -->
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-black/40 opacity-0 group-hover:opacity-100 transition-opacity z-10 p-4 flex flex-col justify-between pointer-events-none">
                    <div class="flex justify-between items-start pointer-events-auto">
                        <div class="px-2 py-1 bg-blue-600 rounded text-[9px] font-black text-white tracking-widest uppercase shadow-lg">
                            ${label}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="toggleVideoFS('${id}')" class="w-8 h-8 rounded-lg bg-white/10 hover:bg-white/20 text-white backdrop-blur flex items-center justify-center transition" title="Fullscreen">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex flex-col gap-3 pointer-events-auto">
                        <div class="flex items-center justify-center gap-4 bg-black/40 backdrop-blur-md rounded-2xl p-3 border border-white/10">
                            <button onclick="adjustZoom('${id}', -0.2)" class="text-white hover:text-blue-400 transition"><i class="fas fa-minus-circle"></i></button>
                            <input type="range" min="1" max="5" step="0.1" value="1" oninput="setZoom('${id}', this.value)" class="w-24 accent-blue-500 h-1 bg-white/20 rounded-full appearance-none">
                            <button onclick="adjustZoom('${id}', 0.2)" class="text-white hover:text-blue-400 transition"><i class="fas fa-plus-circle"></i></button>
                            <button onclick="setZoom('${id}', 1)" class="text-[9px] font-bold text-white/60 hover:text-white transition uppercase">Reset</button>
                        </div>
                    </div>
                </div>
            `;
            return div;
        }

        function adjustZoom(id, delta) {
            const vid = document.querySelector(`#${id} video`);
            const input = document.querySelector(`#${id} input[type="range"]`);
            let val = parseFloat(input.value) + delta;
            val = Math.max(1, Math.min(5, val));
            setZoom(id, val);
        }

        function setZoom(id, val) {
            const vid = document.querySelector(`#${id} video`);
            const input = document.querySelector(`#${id} input[type="range"]`);
            input.value = val;
            vid.style.transform = `scale(${val})`;
        }

        function toggleVideoFS(id) {
            const el = document.getElementById(id);
            if (!document.fullscreenElement) {
                if (el.requestFullscreen) el.requestFullscreen();
                else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        function removePeerVideo(callKey) {
            const container = document.getElementById(`video-container-${callKey}`);
            if (container) container.remove();
            SYS.calls.delete(callKey);
            updateVideoGridLayout();
            if (SYS.calls.size === 0 && !SYS.localStream && !SYS.localScreen) {
                document.getElementById('call-placeholder').classList.remove('hidden');
            }
        }

        function updateVideoGridLayout() {
            const grid = document.getElementById('video-grid');
            const count = grid.children.length;
            grid.className = "w-full h-full grid gap-4 p-4";
            if (count === 1) grid.classList.add("grid-cols-1", "grid-rows-1");
            else if (count === 2) grid.classList.add("grid-cols-1", "md:grid-cols-2", "grid-rows-2", "md:grid-rows-1");
            else if (count <= 4) grid.classList.add("grid-cols-2", "grid-rows-2");
            else grid.classList.add("grid-cols-3", "grid-rows-2");
        }

        function endSpecificCall(type) {
            const stream = (type === 'screen' ? SYS.localScreen : SYS.localStream);
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                if (type === 'screen') SYS.localScreen = null;
                else SYS.localStream = null;
            }
            document.getElementById(`local-container-${type}`)?.remove();

            // Close specific calls
            SYS.calls.forEach((call, key) => {
                if (key.endsWith(`-${type}`)) {
                    call.close();
                    removePeerVideo(key);
                }
            });
            updateVideoGridLayout();
        }

        function endCall() {
            endSpecificCall('video');
            endSpecificCall('screen');
            SYS.calls.clear();
            document.getElementById('video-grid').innerHTML = '';
            document.getElementById('call-placeholder').classList.remove('hidden');
            updateVideoGridLayout();
        }
        function rejectCall() { document.getElementById('incoming-modal').classList.add('hidden'); if (SYS.pendingCall) SYS.pendingCall.close(); SYS.pendingCall = null; }
        function toggleMic() {
            if (SYS.localStream) {
                const track = SYS.localStream.getAudioTracks()[0];
                if (track) {
                    track.enabled = !track.enabled; SYS.isMicMuted = !track.enabled;
                    const btn = document.getElementById('btn-mic');
                    if (SYS.isMicMuted) { btn.classList.add('bg-red-500'); btn.classList.remove('bg-slate-700'); btn.innerHTML = '<i class="fas fa-microphone-slash text-lg"></i>'; }
                    else { btn.classList.remove('bg-red-500'); btn.classList.add('bg-slate-700'); btn.innerHTML = '<i class="fas fa-microphone text-lg"></i>'; }
                }
            }
        }

        // --- UTILS ---
        function copyMyLink() {
            if (!SYS.myId) return showToast("Bhai pehle ID toh banne de!");
            const baseUrl = window.location.origin + window.location.pathname;
            const shareableUrl = `${baseUrl}?peer=${SYS.myId}`;
            if (navigator.share) { navigator.share({ title: 'Mitanshu P2P Enterprise', text: 'Join my secure P2P network session:', url: shareableUrl }).catch(err => { fallbackCopyTextToClipboard(shareableUrl); }); }
            else { fallbackCopyTextToClipboard(shareableUrl); }
        }
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea"); textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.opacity = "0";
            document.body.appendChild(textArea); textArea.focus(); textArea.select(); textArea.setSelectionRange(0, 99999);
            try { const successful = document.execCommand('copy'); if (successful) showToast("Link Copied! Bhejde dosto ko."); else throw new Error('Copy command failed'); }
            catch (err) { window.prompt("Copy this link manually:", text); }
            document.body.removeChild(textArea);
        }
        function showToast(msg) {
            const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            try { if (navigator.vibrate) navigator.vibrate(30); } catch (e) { }
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }
        function updateStatus(txt, color) {
            const el = document.getElementById('connection-status');
            const colors = { emerald: 'text-emerald-600 bg-emerald-50 border-emerald-100', red: 'text-red-600 bg-red-50 border-red-100', blue: 'text-blue-600 bg-blue-50 border-blue-100' };
            el.className = `flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold font-mono transition-all ${colors[color]}`;
            el.innerHTML = `<span class="w-2 h-2 rounded-full bg-${color}-500 animate-pulse"></span> ${txt}`;
        }

        // --- NAVIGATION ---
        function switchTab(id) {
            const views = ['dashboard', 'chat', 'video', 'map', 'files', 'code', 'games', 'browse', 'board', 'media', 'tasks'];
            views.forEach(v => { const el = document.getElementById('view-' + v); if (el) el.classList.add('hidden'); });
            const targetView = document.getElementById('view-' + id); if (targetView) targetView.classList.remove('hidden');
            views.forEach(v => {
                const btn = document.getElementById('nav-' + v);
                if (btn) { btn.classList.remove('bg-blue-600', 'text-white', 'shadow-lg'); btn.classList.add('text-slate-400', 'hover:bg-slate-100'); }
            });
            const activeBtn = document.getElementById('nav-' + id);
            if (activeBtn) { activeBtn.classList.remove('text-slate-400', 'hover:bg-slate-100'); activeBtn.classList.add('bg-blue-600', 'text-white', 'shadow-lg'); }
            if (id === 'code' && SYS.editor) setTimeout(() => SYS.editor.resize(), 100);
            if (id === 'map' && SYS.map) setTimeout(() => SYS.map.invalidateSize(), 300);
            if (id === 'games') setTimeout(() => gamesInitUI(), 50);
            if (id === 'board') setTimeout(() => window.dispatchEvent(new Event('resize')), 50);
            toggleMobileNav(false);
        }
        function toggleMobileNav(open) {
            const el = document.getElementById('mobile-nav'); if (!el) return;
            if (open) el.classList.remove('hidden'); else el.classList.add('hidden');
        }

        // --- EXTRA LOGIC ---
        function startPingLoop() { setInterval(() => { if (SYS.conn && SYS.conn.open) SYS.conn.send({ type: 'PING', ts: Date.now() }); }, 5000); }
        function measureLatency(startTs) {
            const lat = Math.round((Date.now() - startTs) / 2);
            document.getElementById('ping-indicator').innerText = lat + 'ms';
            document.getElementById('ping-indicator').classList.remove('hidden');
            document.getElementById('ping-mobile').innerText = lat + 'ms';

            // Update Mesh Stats if we can identify the peer from context (usually SYS.conn)
            if (SYS.remotePeerId) {
                SYS.peerStats.set(SYS.remotePeerId, { ping: lat });
                updateMeshStats();
            }
        }
        function sendMsg() {
            haptic(15); // Added haptic feedback
            const inp = document.getElementById('chat-input');
            const msg = inp.value.trim();
            if (!msg || SYS.peers.size === 0) return;
            broadcast({ type: 'CHAT', msg: msg });
            addChat(msg, true);
            inp.value = '';
            inp.focus(); // Added focus for speed optimization
        }

        async function sendMediaMsg() {
            haptic(15); // Added haptic feedback
            const file = document.getElementById('chat-file-input').files[0];
            if (!file || SYS.peers.size === 0) return;
            if (file.size > 2.5 * 1024 * 1024) return showToast("File too large (Max 2.5MB)");
            const reader = new FileReader();
            reader.onload = () => {
                const type = file.type.startsWith('image/') ? 'IMG' : (file.type.startsWith('video/') ? 'VID' : 'FILE');
                broadcast({ type: 'CHAT_MEDIA', media: reader.result, mediaType: type, fileName: file.name });
                addChat(reader.result, true, null, type, file.name);
            };
            reader.readAsDataURL(file);
        }

        function addChat(msg, isMe, senderId = null, mediaType = null, fileName = null) {
            const box = document.getElementById('chat-container'); const d = document.createElement('div');
            d.className = `flex ${isMe ? 'justify-end' : 'justify-start'} animate-[fadeIn_0.2s]`;
            const pName = senderId ? (SYS.peerNames.get(senderId) || senderId.substring(0, 5)) : 'ME';
            const senderLabel = isMe ? 'YOU' : pName;

            let content = '';
            if (mediaType === 'IMG') content = `<img src="${msg}" class="rounded-lg max-w-full h-auto cursor-pointer border border-slate-200" onclick="window.open('${msg}')">`;
            else if (mediaType === 'VID') content = `<video src="${msg}" controls class="rounded-lg max-w-full"></video>`;
            else if (mediaType === 'FILE') content = `<a href="${msg}" download="${fileName}" class="flex items-center gap-2 p-2 bg-slate-100 rounded-lg text-blue-600 font-bold text-xs"><i class="fas fa-file"></i> ${fileName}</a>`;
            else {
                // Link detection regex
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                content = msg.replace(urlRegex, (url) => `<a href="${url}" target="_blank" class="underline decoration-2 underline-offset-2 hover:text-blue-300 font-bold">${url}</a>`);
            }

            d.innerHTML = `<div class="max-w-[85%] md:max-w-[70%] px-4 py-2.5 rounded-2xl text-sm shadow-sm ${isMe ? 'bg-blue-600 text-white rounded-tr-sm' : 'bg-white border border-slate-200 text-slate-700 rounded-tl-sm'}">
                <div class="text-[9px] font-black tracking-widest mb-1 ${isMe ? 'text-blue-200' : 'text-slate-400'} uppercase">${senderLabel}</div>
                <div class="break-words">${content}</div>
            </div>`;
            box.appendChild(d); box.scrollTop = box.scrollHeight;
            if (!isMe && document.getElementById('view-chat').classList.contains('hidden')) showToast(`Message from ${senderLabel}`);
        }


        // --- UX ENHANCEMENTS ---
        function haptic(ms = 10) { if (navigator.vibrate) navigator.vibrate(ms); }
        function copyMyId() {
            navigator.clipboard.writeText(SYS.myId).then(() => {
                haptic(30);
                showToast("Peer ID Copied! 📋");
            });
        }
        function getOrCreateName() {
            if (SYS.myName) return SYS.myName;
            let name = document.getElementById('user-name').value.trim();
            if (!name) {
                const adj = ['Swift', 'Elite', 'Brave', 'Neon', 'Secure', 'Quantum'];
                const n = ['Peer', 'Admin', 'Cipher', 'Vortex', 'Falcon', 'Ghost'];
                name = adj[Math.floor(Math.random() * adj.length)] + ' ' + n[Math.floor(Math.random() * n.length)];
                document.getElementById('user-name').value = name;
            }
            SYS.myName = name;
            return name;
        }
        function broadcastLocation() {
            if (!navigator.geolocation) return showToast("❌ GPS Not Supported");
            if (typeof L === 'undefined') return showToast("⏳ Map Engine Loading...");

            if (SYS.locationWatchId) {
                navigator.geolocation.clearWatch(SYS.locationWatchId);
                SYS.locationWatchId = null;
                showToast('🛑 Tracking Stopped');
                return;
            }

            showToast('📡 Seeking Satellite Signal...');

            SYS.locationWatchId = navigator.geolocation.watchPosition(p => {
                const { latitude: lat, longitude: lng } = p.coords;

                if (!SYS.map) {
                    SYS.map = L.map('map').setView([lat, lng], 15);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                        maxZoom: 19,
                        attribution: '&copy; OpenStreetMap'
                    }).addTo(SYS.map);
                    // Force resize after init
                    setTimeout(() => SYS.map.invalidateSize(), 500);
                } else {
                    SYS.map.setView([lat, lng], 15);
                }

                if (!SYS.markers) SYS.markers = {};
                if (SYS.markers.me) SYS.map.removeLayer(SYS.markers.me);

                const myName = getOrCreateName();
                const myIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="relative">
                            <div style='background-color:#3b82f6; width:16px; height:16px; border-radius:50%; box-shadow:0 0 10px #3b82f6; border:2px solid white;'></div>
                            <div class="absolute -top-6 left-1/2 -translate-x-1/2 bg-blue-600 text-white text-[8px] px-1.5 py-0.5 rounded font-black whitespace-nowrap shadow-sm uppercase">YOU (${myName})</div>
                          </div>`,
                    iconSize: [16, 16]
                });

                SYS.markers.me = L.marker([lat, lng], { icon: myIcon }).addTo(SYS.map).bindPopup("YOU ARE HERE").openPopup();

                broadcast({ type: 'GPS', lat: lat, lng: lng });
                console.log('[GPS] Broadcast success:', lat, lng);
            }, (err) => {
                showToast("⚠️ GPS Error: " + err.message);
                console.error('[GPS] Error:', err);
                if (SYS.locationWatchId) {
                    navigator.geolocation.clearWatch(SYS.locationWatchId);
                    SYS.locationWatchId = null;
                }
            }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });

            showToast('📡 Live Location Tracking Active');
        }
        function updateMapMarker(d) {
            const peerId = d.origin;
            if (!peerId) return;

            if (!SYS.map) {
                SYS.map = L.map('map').setView([d.lat, d.lng], 15);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(SYS.map);
            }

            if (!SYS.markers) SYS.markers = {};

            // Remove existing marker for this peer if any
            if (SYS.markers[peerId]) SYS.map.removeLayer(SYS.markers[peerId]);

            const pName = d.senderName || SYS.peerNames.get(peerId) || peerId.substring(0, 5);
            const peerIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="relative">
                        <div style='background-color:#ef4444; width:16px; height:16px; border-radius:50%; box-shadow:0 0 10px #ef4444; border:2px solid white;'></div>
                        <div class="absolute -top-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[8px] px-1.5 py-0.5 rounded font-black whitespace-nowrap shadow-sm border border-slate-700 uppercase">${pName}</div>
                      </div>`,
                iconSize: [16, 16]
            });

            SYS.markers[peerId] = L.marker([d.lat, d.lng], { icon: peerIcon }).addTo(SYS.map).bindPopup(pName.toUpperCase()).openPopup();
            // Optional: Auto-pan to new location if it's the only peer or for better tracking
            // SYS.map.setView([d.lat, d.lng], 15); 
            showToast(`Location Synced: ${pName}`);
        }

        // --- SWARM ENGINE (Decentralized BitTorrent) ---
        async function initiateSwarm(file) {
            if (SYS.peers.size === 0) return showToast("Connect First");
            const fileId = 'swarm-' + Math.random().toString(36).substr(2, 9);
            const buf = await file.arrayBuffer();
            // Faster throughput: Increased chunk size to 64KB for multi-peer efficiency
            const chunkSz = 65536;
            const totalChunks = Math.ceil(buf.byteLength / chunkSz);

            const chunks = [];
            for (let i = 0; i < totalChunks; i++) {
                chunks.push(buf.slice(i * chunkSz, (i + 1) * chunkSz));
            }

            SYS.swarms.set(fileId, {
                name: file.name,
                size: file.size,
                mime: file.type,
                total: totalChunks,
                chunks: chunks,
                owned: new Set(chunks.map((_, i) => i)),
                peerAvailability: new Map(),
                requested: new Set()
            });

            broadcast({ type: 'SWARM_START', fileId, name: file.name, size: file.size, mime: file.type, total: totalChunks });
            addToLog(file.name, 'out');
            updateProgress(0, `Seeding: ${file.name}`);

            const peers = Array.from(SYS.peers.keys());
            for (let i = 0; i < totalChunks; i++) {
                // Round-Robin Distribution: A sends chunk i only to one peer
                const targetPeerId = peers[i % peers.length];
                const targetConn = SYS.peers.get(targetPeerId);
                if (targetConn && targetConn.open) {
                    targetConn.send({ type: 'SWARM_CHUNK', fileId, index: i, data: chunks[i], total: totalChunks, origin: SYS.myId });
                }
                if (i % 100 === 0) {
                    await new Promise(r => setTimeout(r, 1));
                    updateProgress((i / totalChunks) * 100, `Distributing: ${file.name}`);
                }
            }
            updateProgress(100, `Swarm Active: ${file.name}`);
            showToast("🚀 Swarm initialized. Peers are seeding!");
        }

        function handleSwarmStart(d) {
            if (SYS.swarms.has(d.fileId)) return;
            SYS.swarms.set(d.fileId, {
                name: d.name, size: d.size, mime: d.mime, total: d.total,
                chunks: new Array(d.total), owned: new Set(),
                peerAvailability: new Map(), requested: new Set()
            });
            updateProgress(0, `Joining Swarm: ${d.name}`);
            showToast(`🧲 Swarm: ${d.name}`);
        }

        function handleSwarmChunk(d) {
            let s = SYS.swarms.get(d.fileId);
            if (!s || s.owned.has(d.index)) return;

            s.chunks[d.index] = d.data;
            s.owned.add(d.index);

            // Critical Swarm Logic: Tell others we have this so THEY can pull from US
            broadcast({ type: 'SWARM_HAVE', fileId: d.fileId, index: d.index });

            const pct = (s.owned.size / s.total) * 100;
            updateProgress(pct, `Swarm: ${s.name}`);

            if (s.owned.size === s.total) {
                const blob = new Blob(s.chunks, { type: s.mime });
                const url = URL.createObjectURL(blob);
                addToLog(s.name, 'in', url);
                updateProgress(100, `Complete: ${s.name}`);
                showToast(`✅ Swarm Finished: ${s.name}`);
                try { navigator.vibrate([100, 50, 100]); } catch (e) { }
            } else {
                findNextChunks(d.fileId);
            }
        }

        function handleSwarmHave(d) {
            let s = SYS.swarms.get(d.fileId);
            if (!s) return;

            if (!s.peerAvailability.has(d.origin)) s.peerAvailability.set(d.origin, new Set());
            s.peerAvailability.get(d.origin).add(d.index);

            // If we need this chunk, request it
            if (!s.owned.has(d.index) && !s.requested.has(d.index)) {
                requestChunk(d.fileId, d.index, d.origin);
            }
        }

        function requestChunk(fileId, index, peerId) {
            let s = SYS.swarms.get(fileId);
            if (!s || s.owned.has(index) || s.requested.has(index)) return;

            const conn = SYS.peers.get(peerId);
            if (conn && conn.open) {
                s.requested.add(index);
                conn.send({ type: 'SWARM_REQ', fileId, index });
                // Timeout to retry if peer doesn't respond
                setTimeout(() => {
                    if (s.requested.has(index) && !s.owned.has(index)) {
                        s.requested.delete(index);
                        findNextChunks(fileId);
                    }
                }, 5000);
            }
        }

        function handleSwarmReq(d, conn) {
            let s = SYS.swarms.get(d.fileId);
            if (!s || !s.owned.has(d.index)) return;
            conn.send({
                type: 'SWARM_CHUNK', fileId: d.fileId, index: d.index,
                data: s.chunks[d.index], total: s.total, origin: SYS.myId
            });
        }

        function findNextChunks(fileId) {
            let s = SYS.swarms.get(fileId);
            if (!s) return;
            s.peerAvailability.forEach((indices, peerId) => {
                indices.forEach(idx => {
                    if (!s.owned.has(idx) && !s.requested.has(idx)) {
                        requestChunk(fileId, idx, peerId);
                    }
                });
            });
        }

        document.getElementById('file-input').onchange = async (e) => {
            for (let f of e.target.files) await initiateSwarm(f);
        };
        document.getElementById('folder-input').onchange = async (e) => {
            for (let f of e.target.files) await initiateSwarm(f);
        };
        function updateProgress(pct, txt) { document.getElementById('current-percent').innerText = Math.round(pct) + '%'; document.getElementById('current-file-name').innerText = txt; document.getElementById('main-progress').style.width = pct + '%'; }
        function addToLog(name, type, url = null) {
            const list = document.getElementById('transfer-list'), d = document.createElement('div');
            d.className = "flex items-center gap-3 p-3 rounded-xl bg-slate-50 border border-slate-100 text-sm text-slate-700 font-medium";
            if (url) document.getElementById('btn-save-all').classList.remove('hidden');
            d.innerHTML = `<div class="w-8 h-8 rounded-full flex items-center justify-center ${type === 'out' ? 'bg-blue-100 text-blue-600' : 'bg-emerald-100 text-emerald-600'}"><i class="fas ${type === 'out' ? 'fa-arrow-up' : 'fa-arrow-down'}"></i></div><span class="flex-1 truncate">${name}</span>${url ? `<a href="${url}" download="${name}" class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700 shadow-md">SAVE</a>` : '<span class="text-slate-400 text-xs font-bold">SENT</span>'}`;
            list.prepend(d);
        }

        function initEditor() { SYS.editor = ace.edit("editor"); SYS.editor.setTheme("ace/theme/chrome"); SYS.editor.session.setMode("ace/mode/python"); SYS.editor.setOptions({ fontSize: "14px", fontFamily: "JetBrains Mono", showPrintMargin: false, wrap: true }); SYS.editor.on('change', () => { if (SYS.peers.size > 0 && !SYS.remoteEdit) broadcast({ type: 'CODE', val: SYS.editor.getValue(), lang: document.getElementById('lang-select').value }); }); }
        function syncCode(d) { SYS.remoteEdit = true; if (document.getElementById('lang-select').value !== d.lang) { document.getElementById('lang-select').value = d.lang; changeLang(); } SYS.editor.setValue(d.val, 1); SYS.remoteEdit = false; }
        function changeLang() { SYS.editor.session.setMode("ace/mode/" + document.getElementById('lang-select').value); }
        async function loadPython() { try { SYS.pyodide = await loadPyodide(); } catch (e) { } }
        async function runCode() {
            const lang = document.getElementById('lang-select').value, code = SYS.editor.getValue(), out = document.getElementById('output-text'), frame = document.getElementById('html-frame');
            if (lang === 'html') { out.style.display = 'none'; frame.style.display = 'block'; frame.srcdoc = code; }
            else {
                frame.style.display = 'none'; out.style.display = 'block'; out.innerText = "Executing Engine...";
                if (lang === 'python' && SYS.pyodide) { try { SYS.pyodide.runPython(`import sys; from io import StringIO; sys.stdout = StringIO()`); await SYS.pyodide.runPythonAsync(code); out.innerText = SYS.pyodide.runPython("sys.stdout.getvalue()"); } catch (e) { out.innerText = e; } }
                else if (lang === 'sql') { try { out.innerText = JSON.stringify(alasql(code), null, 2); } catch (e) { out.innerText = e; } }
            }
        }
        // --- BROWSE SHARE ---
        function browseToggle() {
            const enabled = document.getElementById('browse-toggle').checked;
            SYS.browse.enabled = enabled;
            if (SYS.peers.size > 0) broadcast({ type: enabled ? 'BROWSE_ENABLE' : 'BROWSE_DISABLE' });
            showToast(enabled ? 'Link Sharing Enabled' : 'Link Sharing Disabled');
        }
        function browseSendLink() {
            if (!SYS.browse.enabled) return showToast('Enable Browse Share first');
            if (!SYS.browse.peerEnabled) showToast("Broadcasting link to all peers...");
            if (SYS.peers.size === 0) return showToast('Connect to a peer first');
            const url = document.getElementById('browse-link-input').value.trim();
            if (!url) return showToast('Enter a URL');
            broadcast({ type: 'BROWSE_LINK', url: url });
            browseAddLog(url, 'out');
            document.getElementById('browse-link-input').value = '';
            showToast('Link sent to room!');
        }
        function browseReceiveLink(url) {
            browseAddLog(url, 'in');
            if (!SYS.browse.enabled) return showToast('Received a link but Browse Share is disabled');
            switchTab('browse');
            setTimeout(() => {
                if (confirm('Peer wants to share this link:\n\n' + url + '\n\nOpen in new tab?')) {
                    window.open(url, '_blank');
                }
            }, 200);
        }
        function browseAddLog(url, type) {
            const log = document.getElementById('browse-log');
            const placeholder = log.querySelector('p');
            if (placeholder) log.innerHTML = '';
            const d = document.createElement('div');
            d.className = 'flex items-center gap-3 p-3 rounded-xl bg-slate-50 border border-slate-100 text-sm text-slate-700 font-medium';
            const icon = type === 'out' ? 'fa-arrow-up' : 'fa-arrow-down';
            const color = type === 'out' ? 'bg-blue-100 text-blue-600' : 'bg-emerald-100 text-emerald-600';
            const label = type === 'out' ? 'SENT' : 'RECEIVED';
            d.innerHTML = `<div class="w-8 h-8 rounded-full flex items-center justify-center ${color}"><i class="fas ${icon}"></i></div><a href="${url}" target="_blank" class="flex-1 truncate text-blue-600 hover:underline font-mono text-xs">${url}</a><span class="text-slate-400 text-xs font-bold">${label}</span>`;
            log.prepend(d);
        }
        // --- SHARED PREVIEW ---
        function previewLoad() {
            const url = document.getElementById('preview-url-input').value.trim();
            if (!url) return showToast('Enter a URL');
            document.getElementById('preview-iframe').src = url;
            document.getElementById('preview-container').classList.remove('hidden');
            document.getElementById('preview-placeholder').classList.add('hidden');
            if (SYS.peers.size > 0) broadcast({ type: 'PREVIEW_URL', url: url });
            showToast('Preview loaded');
        }
        function previewReceive(url) {
            document.getElementById('preview-url-input').value = url;
            document.getElementById('preview-iframe').src = url;
            document.getElementById('preview-container').classList.remove('hidden');
            document.getElementById('preview-placeholder').classList.add('hidden');
            if (!document.getElementById('view-browse').classList.contains('hidden')) return;
            showToast('Peer started a Shared Preview');
        }
        function previewStop() {
            document.getElementById('preview-iframe').src = '';
            document.getElementById('preview-container').classList.add('hidden');
            document.getElementById('preview-placeholder').classList.remove('hidden');
            document.getElementById('preview-url-input').value = '';
            if (SYS.peers.size > 0) broadcast({ type: 'PREVIEW_STOP' });
        }
        function previewStopReceive() {
            document.getElementById('preview-iframe').src = '';
            document.getElementById('preview-container').classList.add('hidden');
            document.getElementById('preview-placeholder').classList.remove('hidden');
            document.getElementById('preview-url-input').value = '';
        }

        // --- FULLSCREEN TOGGLE ---
        function toggleFullscreen(elementId) {
            const el = document.getElementById(elementId);
            if (!el) return;
            // Try native fullscreen API first
            if (!document.fullscreenElement) {
                if (el.requestFullscreen) {
                    el.requestFullscreen().then(() => {
                        if (elementId === 'view-code' && SYS.editor) setTimeout(() => SYS.editor.resize(), 300);
                    }).catch(e => {
                        // Fallback to CSS fullscreen
                        el.classList.toggle('fullscreen-active');
                        updateFullscreenBtn(elementId, el.classList.contains('fullscreen-active'));
                        if (elementId === 'view-code' && SYS.editor) setTimeout(() => SYS.editor.resize(), 300);
                    });
                } else if (el.webkitRequestFullscreen) {
                    el.webkitRequestFullscreen();
                } else {
                    el.classList.toggle('fullscreen-active');
                    updateFullscreenBtn(elementId, el.classList.contains('fullscreen-active'));
                    if (elementId === 'view-code' && SYS.editor) setTimeout(() => SYS.editor.resize(), 300);
                }
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                if (elementId === 'view-code' && SYS.editor) setTimeout(() => SYS.editor.resize(), 300);
            }
        }
        function updateFullscreenBtn(elementId, isFs) {
            let btnId = elementId === 'view-video' ? 'btn-video-fs' : (elementId === 'view-code' ? 'btn-code-fs' : null);
            if (btnId) {
                const btn = document.getElementById(btnId);
                if (btn) btn.innerHTML = isFs ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>';
            }
        }
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                document.querySelectorAll('.fullscreen-active').forEach(el => el.classList.remove('fullscreen-active'));
                updateFullscreenBtn('view-video', false);
                updateFullscreenBtn('view-code', false);
                if (SYS.editor) setTimeout(() => SYS.editor.resize(), 100);
            }
        });
        // ESC key to exit CSS fullscreen
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                const hadFs = document.querySelectorAll('.fullscreen-active').length > 0;
                document.querySelectorAll('.fullscreen-active').forEach(el => el.classList.remove('fullscreen-active'));
                updateFullscreenBtn('view-video', false);
                updateFullscreenBtn('view-code', false);
                if (hadFs && SYS.editor) setTimeout(() => SYS.editor.resize(), 100);
            }
        });

        // --- SWITCH CAMERA ---
        let currentCameraIndex = 0;
        let availableCameras = [];
        async function switchCamera() {
            if (!SYS.localStream) return showToast('Start a video call first');
            const currentVideoTrack = SYS.localStream.getVideoTracks()[0];
            if (!currentVideoTrack) return showToast('No active video track');
            // Check if this is a screen share (screen shares cannot switch)
            if (currentVideoTrack.label && currentVideoTrack.label.toLowerCase().includes('screen')) return showToast('Cannot switch during screen share');
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                availableCameras = devices.filter(d => d.kind === 'videoinput');
                if (availableCameras.length < 2) return showToast('Only one camera detected');
                currentCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
                const newCam = availableCameras[currentCameraIndex];
                const newStream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: { exact: newCam.deviceId } },
                    audio: true
                });
                // Replace video track
                const newVideoTrack = newStream.getVideoTracks()[0];
                const sender = SYS.call && SYS.call.peerConnection ?
                    SYS.call.peerConnection.getSenders().find(s => s.track && s.track.kind === 'video') : null;
                if (sender) await sender.replaceTrack(newVideoTrack);
                // Update local stream
                const oldTrack = SYS.localStream.getVideoTracks()[0];
                SYS.localStream.removeTrack(oldTrack);
                oldTrack.stop();
                SYS.localStream.addTrack(newVideoTrack);
                document.getElementById('local-video').srcObject = SYS.localStream;
                // Flash the button for feedback
                const btn = document.getElementById('btn-switch-cam');
                btn.classList.add('bg-emerald-500'); btn.classList.remove('bg-slate-700');
                setTimeout(() => { btn.classList.remove('bg-emerald-500'); btn.classList.add('bg-slate-700'); }, 800);
                showToast(`Camera: ${newCam.label || ('Camera ' + (currentCameraIndex + 1))}`);
                try { navigator.vibrate(30); } catch (e) { }
            } catch (e) { showToast('Camera switch failed: ' + e.message); console.error(e); }
        }

        // --- 1. WHITEBOARD LOGIC ---
        function boardInit() {
            const canvas = document.getElementById('board-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            SYS.board.ctx = ctx;

            const resize = () => {
                const parent = canvas.parentElement;
                const imgData = ctx.getImageData(0, 0, canvas.width || 1, canvas.height || 1);
                canvas.width = parent.clientWidth;
                canvas.height = parent.clientHeight;
                if (imgData.width > 1 && imgData.height > 1) ctx.putImageData(imgData, 0, 0);
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
            };
            window.addEventListener('resize', resize);
            setTimeout(resize, 100);

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            const startDraw = (e) => {
                SYS.board.isDrawing = true;
                const pos = getPos(e);
                SYS.board.lastX = pos.x; SYS.board.lastY = pos.y;
            };

            const draw = (e) => {
                if (!SYS.board.isDrawing) return;
                const pos = getPos(e);
                const color = SYS.board.activeTool === 'eraser' ? '#f8fafc' : document.getElementById('board-color').value;
                const size = SYS.board.activeTool === 'eraser' ? 30 : 4;

                boardDrawLine(SYS.board.lastX, SYS.board.lastY, pos.x, pos.y, color, size, true);

                SYS.board.lastX = pos.x; SYS.board.lastY = pos.y;
            };

            const stopDraw = () => { SYS.board.isDrawing = false; };

            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            window.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('touchstart', startDraw, { passive: true });
            canvas.addEventListener('touchmove', draw, { passive: true });
            window.addEventListener('touchend', stopDraw);
        }

        function boardSetTool(tool) {
            SYS.board.activeTool = tool;
            document.getElementById('btn-board-pen').classList.remove('bg-blue-100', 'text-blue-600');
            document.getElementById('btn-board-pen').classList.add('bg-slate-100', 'text-slate-600');
            document.getElementById('btn-board-eraser').classList.remove('bg-blue-100', 'text-blue-600');
            document.getElementById('btn-board-eraser').classList.add('bg-slate-100', 'text-slate-600');
            if (tool === 'pen') {
                document.getElementById('btn-board-pen').classList.add('bg-blue-100', 'text-blue-600');
                document.getElementById('btn-board-pen').classList.remove('bg-slate-100', 'text-slate-600');
            } else {
                document.getElementById('btn-board-eraser').classList.add('bg-blue-100', 'text-blue-600');
                document.getElementById('btn-board-eraser').classList.remove('bg-slate-100', 'text-slate-600');
            }
        }

        function boardDrawLine(x0, y0, x1, y1, color, size, sync) {
            const ctx = SYS.board.ctx;
            if (!ctx) return;
            ctx.beginPath();
            ctx.moveTo(x0, y0);
            ctx.lineTo(x1, y1);
            ctx.strokeStyle = color;
            ctx.lineWidth = size;
            ctx.stroke();
            if (sync && SYS.peers.size > 0) {
                broadcast({ type: 'BOARD', x0: Math.round(x0), y0: Math.round(y0), x1: Math.round(x1), y1: Math.round(y1), c: color, s: size });
            }
        }

        function boardApplyDraw(d) {
            boardDrawLine(d.x0, d.y0, d.x1, d.y1, d.c, d.s, false);
        }

        function boardClear(sync) {
            const canvas = document.getElementById('board-canvas');
            const ctx = SYS.board.ctx;
            if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (sync && SYS.peers.size > 0) broadcast({ type: 'BOARD_CLEAR' });
        }

        // --- 2. MEDIA WATCH PARTY LOGIC ---
        function mediaInit() {
            const p = document.getElementById('media-player');
            if (!p) return;

            p.addEventListener('play', () => mediaSync('PLAY', p.currentTime));
            p.addEventListener('pause', () => mediaSync('PAUSE', p.currentTime));
            p.addEventListener('seeked', () => mediaSync('SEEK', p.currentTime));
        }

        function mediaLoadUrl() {
            const url = document.getElementById('media-url').value.trim();
            if (!url) return showToast('Enter media URL');
            mediaSetSource(url, true);
        }

        function mediaLoadLocal() {
            const file = document.getElementById('media-upload').files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            mediaSetSource(url, false);
            showToast('Local file loaded. Cannot sync file itself, only playback.');
        }

        function mediaSetSource(url, sync) {
            const p = document.getElementById('media-player');
            document.getElementById('media-placeholder').classList.add('hidden');

            let yt = document.getElementById('media-yt');
            const isYtUrl = url.includes('youtube.com/watch') || url.includes('youtu.be/');

            if (isYtUrl) {
                if (!yt) {
                    yt = document.createElement('iframe');
                    yt.id = 'media-yt';
                    yt.className = 'w-full h-full max-w-5xl rounded-xl shadow-2xl';
                    yt.setAttribute('allowfullscreen', 'true');
                    yt.setAttribute('allow', 'autoplay; encrypted-media');
                    p.parentNode.appendChild(yt);
                }

                let videoId = '';
                if (url.includes('youtu.be/')) videoId = url.split('.be/')[1].split(/[?#]/)[0];
                else if (url.includes('v=')) videoId = url.split('v=')[1].split('&')[0];

                yt.classList.remove('hidden');
                p.classList.add('hidden');
                p.pause();
                yt.src = 'https://www.youtube.com/embed/' + videoId + '?autoplay=1';
            } else {
                if (yt) yt.classList.add('hidden');
                p.classList.remove('hidden');
                p.src = url;
            }

            if (sync && SYS.peers.size > 0) broadcast({ type: 'MEDIA', action: 'LOAD', url: url });
        }

        function mediaSync(action, time) {
            if (SYS.media.isSyncing) return;
            if (SYS.peers.size > 0) broadcast({ type: 'MEDIA', action: action, time: time });
        }

        function mediaApplySync(d) {
            const p = document.getElementById('media-player');
            const yt = document.getElementById('media-yt');
            SYS.media.isSyncing = true;
            if (d.action === 'LOAD') {
                mediaSetSource(d.url, false);
            } else if (d.action === 'PLAY') {
                if (!yt || yt.classList.contains('hidden')) {
                    if (Math.abs(p.currentTime - d.time) > 1.0) p.currentTime = d.time;
                    p.play().catch(e => console.log(e));
                }
            } else if (d.action === 'PAUSE') {
                if (!yt || yt.classList.contains('hidden')) {
                    p.pause();
                    p.currentTime = d.time;
                }
            } else if (d.action === 'SEEK') {
                if (!yt || yt.classList.contains('hidden')) {
                    p.currentTime = d.time;
                }
            }
            setTimeout(() => { SYS.media.isSyncing = false; }, 200);
        }

        // --- 3. TASKS COLLABORATIVE BOARD LOGIC ---
        function taskRender() {
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            const items = Object.values(SYS.tasks.items);
            if (items.length === 0) {
                list.innerHTML = '<div class="text-center p-8 text-slate-400 font-bold text-sm">No tasks added yet. Start planning!</div>';
                return;
            }

            items.sort((a, b) => b.ts - a.ts).forEach(t => {
                const el = document.createElement('div');
                el.className = `flex items-center justify-between p-4 bg-white rounded-2xl border border-slate-200 shadow-sm transition hover:shadow-md ${t.done ? 'opacity-60' : ''}`;
                el.innerHTML = `
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <button onclick="taskToggle('${t.id}')" class="w-6 h-6 rounded border flex items-center justify-center transition shrink-0 ${t.done ? 'bg-emerald-500 border-emerald-600 text-white' : 'bg-slate-50 border-slate-300 text-transparent hover:border-emerald-400'}">
                            <i class="fas fa-check text-xs"></i>
                        </button>
                        <span class="font-bold text-sm truncate ${t.done ? 'text-slate-400 line-through' : 'text-slate-800'}">${t.text}</span>
                    </div>
                    <button onclick="taskDel('${t.id}')" class="w-8 h-8 rounded-lg text-slate-400 hover:text-red-500 hover:bg-red-50 transition shrink-0 ml-3">
                        <i class="fas fa-trash-alt text-xs"></i>
                    </button>
                `;
                list.appendChild(el);
            });
        }

        function taskAdd() {
            const inp = document.getElementById('task-input');
            const txt = inp.value.trim();
            if (!txt) return;
            const id = 'tsk_' + Date.now() + Math.random().toString(36).substr(2, 5);
            const task = { id: id, text: txt, done: false, ts: Date.now() };
            SYS.tasks.items[id] = task;
            inp.value = '';
            taskRender();
            if (SYS.peers.size > 0) broadcast({ type: 'TASKS', action: 'ADD', task: task });
        }

        function taskToggle(id) {
            if (!SYS.tasks.items[id]) return;
            SYS.tasks.items[id].done = !SYS.tasks.items[id].done;
            taskRender();
            if (SYS.peers.size > 0) broadcast({ type: 'TASKS', action: 'TOGGLE', id: id, done: SYS.tasks.items[id].done });
        }

        function taskDel(id) {
            if (!SYS.tasks.items[id]) return;
            delete SYS.tasks.items[id];
            taskRender();
            if (SYS.peers.size > 0) broadcast({ type: 'TASKS', action: 'DEL', id: id });
        }

        function taskApplySync(d) {
            if (d.action === 'ADD') SYS.tasks.items[d.task.id] = d.task;
            else if (d.action === 'TOGGLE' && SYS.tasks.items[d.id]) SYS.tasks.items[d.id].done = d.done;
            else if (d.action === 'DEL' && SYS.tasks.items[d.id]) delete SYS.tasks.items[d.id];
            taskRender();
        }

        function initUI() {
            boardInit();
            mediaInit();
            taskRender();

            const drop = document.body;
            drop.addEventListener('dragover', e => e.preventDefault());
            drop.addEventListener('drop', e => { e.preventDefault(); switchTab('files'); });

            // Register Service Worker for High Performance
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(reg => console.log('[SW] Registered'))
                        .catch(err => console.log('[SW] Error', err));
                });
            }
        }
    </script>
</body>

</html>