<!DOCTYPE html>
<html lang="en">
<head>
    <!-- 
      MITANSHU P2P ENGINE - ENTERPRISE SUITE v13.3 (Gaming Hub Edition)
      Architect: Mitanshu Bhasin (Cyber Hygiene Practitioner & Python Elite)
      Status: Stable | Shareable Links | Multi-Game P2P Sync | Anti-Cheat Logic
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#f8fafc">
    <title>MITANSHU P2P | Enterprise</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alasql@4"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        corp: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', 600: '#475569', 500: '#64748b', accent: '#2563eb' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    animation: { 
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'ring': 'ring 2s infinite ease-in-out',
                        'float': 'float 3s ease-in-out infinite',
                        'slide-in': 'slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1)'
                    },
                    keyframes: {
                        ring: {
                            '0%, 100%': { transform: 'rotate(0deg)' },
                            '10%, 30%, 50%, 70%, 90%': { transform: 'rotate(-10deg)' },
                            '20%, 40%, 60%, 80%': { transform: 'rotate(10deg)' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        slideIn: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap');
        
        body { 
            background: #f8fafc; 
            color: #1e293b; 
            font-family: 'Inter', sans-serif; 
            height: 100dvh; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
        }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        @media (min-width: 768px) {
            .glass-panel {
                background: rgba(255, 255, 255, 0.85);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.05);
            }
        }

        .view-section { transition: opacity 0.2s ease-in-out; }
        .btn-active { @apply bg-blue-600 text-white shadow-lg shadow-blue-200; }
        .btn-inactive { @apply text-slate-400 hover:bg-slate-100; }
        
        .ttt-cell { transition: all 0.2s; }
        .ttt-cell:active { transform: scale(0.95); }
    </style>
</head>
<body class="flex flex-col md:flex-row bg-slate-50 relative">
    
    <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-blue-100/50 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none z-0"></div>

    <div class="relative z-10 w-full h-full flex flex-col md:flex-row p-2 md:p-4 gap-3 max-w-[1920px] mx-auto">
        
        <!-- MOBILE HEADER -->
        <div class="md:hidden flex justify-between items-center px-2 py-2 bg-white rounded-2xl shadow-sm border border-slate-200 shrink-0">
            <div class="flex items-center gap-3">
                <button onclick="toggleMobileNav(true)" class="w-10 h-10 rounded-xl bg-slate-50 border border-slate-200 text-slate-700 flex items-center justify-center shadow-sm active:scale-95 transition-transform">
                    <i class="fas fa-bars text-lg"></i>
                </button>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold shadow-md text-sm">M</div>
                    <span class="font-black text-slate-800 text-sm tracking-tight">MITANSHU <span class="text-blue-600">P2P</span></span>
                </div>
            </div>
            <div id="ping-mobile" class="text-[10px] font-mono text-slate-400 font-bold px-2"></div>
        </div>

        <!-- SIDEBAR -->
        <nav class="glass-panel hidden md:flex w-20 h-full rounded-2xl flex-col items-center justify-between p-2 z-30 shrink-0 shadow-none overflow-visible">
            <div class="flex flex-col items-center gap-4 mt-2">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-200 hover:scale-105 transition cursor-pointer" onclick="switchTab('dashboard')">
                    <span class="font-black text-white">M</span>
                </div>
            </div>

            <div class="flex flex-col gap-2 w-full justify-center px-0">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-active min-w-[50px]" title="Dashboard"><i class="fas fa-home text-lg"></i></button>
                <button onclick="switchTab('chat')" id="nav-chat" class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-inactive min-w-[50px]" title="Secure Chat"><i class="fas fa-comment-alt text-lg"></i></button>
                <button onclick="switchTab('video')" id="nav-video" class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-inactive min-w-[50px]" title="Video/Screen"><i class="fas fa-video text-lg"></i></button>
                <button onclick="switchTab('map')" id="nav-map" class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-inactive min-w-[50px]" title="Live GPS Map"><i class="fas fa-map-marked-alt text-lg"></i></button>
                <button onclick="switchTab('files')" id="nav-files" class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-inactive min-w-[50px]" title="File Transfer"><i class="fas fa-folder-open text-lg"></i></button>
                <button onclick="switchTab('code')" id="nav-code" class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-inactive min-w-[50px]" title="Code Studio"><i class="fas fa-code text-lg"></i></button>
                <button onclick="switchTab('games')" id="nav-games" class="p-3 rounded-xl transition flex flex-col items-center gap-1 group btn-inactive min-w-[50px]" title="Gaming Hub"><i class="fas fa-gamepad text-lg"></i></button>
            </div>

            <div class="flex flex-col items-center gap-4 mb-2">
                 <div id="ping-indicator" class="text-[9px] font-mono text-slate-400 font-bold hidden">0ms</div>
            </div>
        </nav>

        <!-- MOBILE NAV DRAWER -->
        <div id="mobile-nav" class="fixed inset-0 z-[150] hidden">
            <div onclick="toggleMobileNav(false)" class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm w-full h-full transition-opacity"></div>
            <div class="absolute top-0 left-0 h-full w-[280px] bg-white shadow-2xl border-r border-slate-200 p-5 flex flex-col animate-slide-in">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black shadow-md text-lg">M</div>
                        <div>
                            <div class="text-sm font-black text-slate-800 tracking-tight">MITANSHU P2P</div>
                            <div class="text-[10px] font-mono text-slate-400 uppercase font-bold">Main Menu</div>
                        </div>
                    </div>
                    <button onclick="toggleMobileNav(false)" class="w-9 h-9 rounded-xl bg-slate-50 border border-slate-200 text-slate-700 flex items-center justify-center active:bg-slate-200 transition">
                        <i class="fas fa-xmark"></i>
                    </button>
                </div>

                <div class="flex flex-col gap-3 overflow-y-auto pb-4">
                    <button onclick="switchTab('dashboard')" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i class="fas fa-home w-6 text-center text-slate-400 text-lg"></i> Dashboard</button>
                    <button onclick="switchTab('chat')" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i class="fas fa-comment-alt w-6 text-center text-slate-400 text-lg"></i> Secure Chat</button>
                    <button onclick="switchTab('video')" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i class="fas fa-video w-6 text-center text-slate-400 text-lg"></i> Video & Screen</button>
                    <button onclick="switchTab('map')" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i class="fas fa-map-marked-alt w-6 text-center text-slate-400 text-lg"></i> Live GPS</button>
                    <button onclick="switchTab('files')" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i class="fas fa-folder-open w-6 text-center text-slate-400 text-lg"></i> Transfer Files</button>
                    <button onclick="switchTab('code')" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-white border border-slate-100 hover:border-slate-200 text-slate-700 font-bold text-sm active:scale-95 transition"><i class="fas fa-code w-6 text-center text-slate-400 text-lg"></i> Code Studio</button>
                    <button onclick="switchTab('games')" class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl bg-blue-50 border border-blue-200 text-blue-700 font-bold text-sm active:scale-95 transition"><i class="fas fa-gamepad w-6 text-center text-blue-600 text-lg"></i> Gaming Hub</button>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <main class="flex-1 h-full relative overflow-hidden rounded-[2rem] glass-panel flex flex-col shadow-sm md:shadow-xl shrink-1">
            
            <header class="hidden md:flex px-6 py-4 border-b border-slate-100 justify-between items-center bg-white/50 backdrop-blur-sm z-20 relative">
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-800 flex items-center gap-2">
                        MITANSHU <span class="text-blue-600">P2P</span> ENTERPRISE
                        <span class="px-2 py-0.5 rounded text-[10px] bg-blue-100 text-blue-700 border border-blue-200 uppercase font-mono tracking-wide">v13.3 Gaming</span>
                    </h1>
                    <p class="text-[10px] text-slate-500 font-mono tracking-wider mt-0.5 uppercase">Architect: Mitanshu Bhasin | Status: <span id="sys-status">Ready</span></p>
                </div>
                <div class="flex items-center gap-3">
                    <div id="connection-status" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-50 border border-red-100 text-red-600 text-xs font-bold font-mono transition-all">
                        <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> OFFLINE
                    </div>
                </div>
            </header>

            <!-- DASHBOARD, CHAT, VIDEO, MAP, FILES, CODE remain unchanged structurally -->
            <div id="view-dashboard" class="view-section flex-1 p-4 md:p-8 overflow-y-auto bg-white/60">
                <div class="max-w-5xl mx-auto flex flex-col gap-6 md:gap-8 h-full">
                    <div class="flex flex-col md:flex-row gap-6 md:gap-8 items-center justify-between mt-2 md:mt-4">
                        <div class="space-y-4 md:w-1/2 text-center md:text-left animate-[fadeIn_0.5s]">
                            <h2 class="text-4xl md:text-6xl font-black italic text-slate-800 tracking-tighter leading-none">
                                ENGINEERING <br><span class="text-blue-600">EXCELLENCE</span>
                            </h2>
                            <p class="text-slate-500 text-sm md:text-lg font-medium leading-relaxed max-w-sm mx-auto md:mx-0">
                                Direct Peer-to-Peer Encrypted Suite. Multi-Gaming Hub Integrated.
                            </p>
                            <div id="auto-connect-msg" class="hidden text-sm text-blue-600 font-bold bg-blue-50 p-2 rounded-lg border border-blue-200 inline-block animate-pulse mt-2">
                                <i class="fas fa-link mr-1"></i> Joining Shared Link...
                            </div>
                        </div>
                        
                        <div class="bg-white border border-slate-200 p-5 md:p-6 rounded-[2rem] shadow-xl shadow-slate-200/50 w-full md:w-1/2 space-y-5 relative overflow-hidden group">
                            <div class="absolute -top-4 -right-4 p-4 opacity-5 group-hover:opacity-10 transition pointer-events-none"><i class="fas fa-network-wired text-9xl text-blue-600"></i></div>
                            <div class="relative z-10">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">My Digital Identity</label>
                                <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4 flex flex-col gap-3">
                                    <div id="my-id" class="font-mono text-sm md:text-base text-blue-700 font-bold select-all truncate text-center bg-white p-2 rounded-xl border border-blue-100 shadow-inner">
                                        <i class="fas fa-circle-notch fa-spin mr-2 text-slate-400"></i> Initializing...
                                    </div>
                                    <button onclick="copyMyLink()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold transition flex items-center justify-center gap-2 shadow-lg shadow-blue-200 active:scale-95">
                                        <i class="fas fa-share-square"></i> Share Link to Connect
                                    </button>
                                </div>
                            </div>
                            <div class="relative z-10">
                                <div class="flex items-center gap-4 my-2">
                                    <div class="h-px bg-slate-200 flex-1"></div>
                                    <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">OR</span>
                                    <div class="h-px bg-slate-200 flex-1"></div>
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" id="remote-id" placeholder="Paste Peer ID Here" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl p-3 font-mono text-sm outline-none focus:border-blue-500 focus:bg-white transition shadow-inner">
                                    <button onclick="connectToPeer()" class="px-6 bg-slate-800 text-white rounded-xl font-bold text-sm hover:bg-slate-900 transition shadow-lg active:scale-95">LINK</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 md:gap-4 pb-6 mt-4">
                        <div onclick="switchTab('chat')" class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-blue-400 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col items-center text-center">
                            <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center mb-2 shadow-sm"><i class="fas fa-comment-alt text-lg"></i></div>
                            <h4 class="font-bold text-slate-800 text-xs md:text-sm">Secure Chat</h4>
                        </div>
                        <div onclick="switchTab('video')" class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-purple-400 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col items-center text-center">
                            <div class="w-12 h-12 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center mb-2 shadow-sm"><i class="fas fa-video text-lg"></i></div>
                            <h4 class="font-bold text-slate-800 text-xs md:text-sm">Video Call</h4>
                        </div>
                        <div onclick="switchTab('map')" class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-emerald-400 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col items-center text-center">
                            <div class="w-12 h-12 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center mb-2 shadow-sm"><i class="fas fa-map-marked-alt text-lg"></i></div>
                            <h4 class="font-bold text-slate-800 text-xs md:text-sm">Live GPS Map</h4>
                        </div>
                        <div onclick="switchTab('files')" class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-orange-400 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col items-center text-center">
                            <div class="w-12 h-12 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center mb-2 shadow-sm"><i class="fas fa-folder-open text-lg"></i></div>
                            <h4 class="font-bold text-slate-800 text-xs md:text-sm">File Transfer</h4>
                        </div>
                        <div onclick="switchTab('code')" class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-indigo-400 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col items-center text-center">
                            <div class="w-12 h-12 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center mb-2 shadow-sm"><i class="fas fa-code text-lg"></i></div>
                            <h4 class="font-bold text-slate-800 text-xs md:text-sm">Code Studio</h4>
                        </div>
                        <div onclick="switchTab('games')" class="bg-white p-4 rounded-2xl border border-slate-200 hover:border-yellow-400 hover:shadow-lg hover:-translate-y-1 transition cursor-pointer flex flex-col items-center text-center">
                            <div class="w-12 h-12 rounded-full bg-yellow-50 text-yellow-600 flex items-center justify-center mb-2 shadow-sm"><i class="fas fa-gamepad text-lg"></i></div>
                            <h4 class="font-bold text-slate-800 text-xs md:text-sm">P2P Games</h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHAT VIEW -->
            <div id="view-chat" class="view-section hidden flex-1 flex flex-col h-full bg-white relative">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white/80 backdrop-blur-md z-10 shrink-0">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center border border-blue-100"><i class="fas fa-lock text-lg"></i></div>
                        <div>
                            <h3 class="font-bold text-slate-800 text-sm">Encrypted Channel</h3>
                            <p class="text-[10px] text-emerald-600 font-bold flex items-center gap-1.5"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span> End-to-End Secure</p>
                        </div>
                    </div>
                    <button onclick="document.getElementById('chat-container').innerHTML=''" class="w-8 h-8 rounded-full text-slate-400 hover:bg-red-50 hover:text-red-500 transition flex items-center justify-center"><i class="fas fa-trash-alt"></i></button>
                </div>
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/50"></div>
                <div class="p-3 md:p-4 border-t border-slate-200 bg-white shrink-0">
                    <div class="flex gap-2 bg-slate-50 p-1.5 rounded-2xl border border-slate-200 focus-within:border-blue-400 focus-within:shadow-md transition">
                        <input type="text" id="chat-input" placeholder="Type a secure message..." class="flex-1 px-3 py-2 text-sm outline-none bg-transparent" onkeypress="if(event.key==='Enter') sendMsg()">
                        <button onclick="sendMsg()" class="bg-blue-600 text-white w-10 h-10 rounded-xl shadow-md hover:bg-blue-700 active:scale-95 transition flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <!-- VIDEO VIEW -->
            <div id="view-video" class="view-section hidden flex-1 flex flex-col h-full bg-slate-900 relative overflow-hidden rounded-b-[2rem] md:rounded-bl-none">
                <div class="absolute inset-0 flex items-center justify-center bg-slate-900">
                    <video id="remote-video" autoplay playsinline class="w-full h-full object-contain"></video>
                    <div class="absolute top-4 right-4 w-28 md:w-48 aspect-video bg-black rounded-xl overflow-hidden border-2 border-white/20 shadow-2xl z-20">
                        <video id="local-video" autoplay playsinline muted class="w-full h-full object-cover opacity-90"></video>
                    </div>
                    <div id="call-placeholder" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none text-slate-500">
                        <div class="w-24 h-24 md:w-32 md:h-32 rounded-full bg-white/5 border border-white/10 flex items-center justify-center mb-6 animate-pulse"><i class="fas fa-video text-4xl md:text-5xl text-blue-500"></i></div>
                        <h3 class="text-lg md:text-xl font-bold text-white tracking-tight">Video Uplink Ready</h3>
                    </div>
                </div>
                <div class="absolute bottom-6 md:bottom-8 left-1/2 -translate-x-1/2 z-30 bg-slate-800/90 backdrop-blur border border-white/10 rounded-full p-2.5 flex gap-3 shadow-2xl">
                     <button onclick="startCall('video')" class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-blue-600 text-white hover:bg-blue-500 active:scale-95 transition flex items-center justify-center shadow-lg"><i class="fas fa-video text-lg"></i></button>
                     <button onclick="startCall('screen')" class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-purple-600 text-white hover:bg-purple-500 active:scale-95 transition flex items-center justify-center shadow-lg"><i class="fas fa-desktop text-lg"></i></button>
                     <button onclick="toggleMic()" id="btn-mic" class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-slate-700 text-white hover:bg-slate-600 active:scale-95 transition flex items-center justify-center"><i class="fas fa-microphone text-lg"></i></button>
                     <button onclick="endCall()" class="w-12 h-12 md:w-14 md:h-14 rounded-full bg-red-600 text-white hover:bg-red-500 active:scale-95 transition flex items-center justify-center shadow-lg"><i class="fas fa-phone-slash text-lg"></i></button>
                </div>
            </div>

            <!-- MAP VIEW -->
            <div id="view-map" class="view-section hidden flex-1 flex flex-col h-full relative bg-slate-100 rounded-b-[2rem] md:rounded-bl-none overflow-hidden">
                <div id="map" class="absolute inset-0 z-0"></div>
                <div class="absolute top-4 left-4 z-[1000] bg-white/95 backdrop-blur px-4 py-3 rounded-2xl shadow-xl border border-white flex flex-col gap-2">
                    <button onclick="broadcastLocation()" class="px-5 py-2.5 bg-blue-600 text-white text-xs font-bold rounded-xl hover:bg-blue-700 active:scale-95 transition flex items-center gap-2"><i class="fas fa-location-arrow"></i> Broadcast Live GPS</button>
                </div>
            </div>

            <!-- FILES VIEW -->
            <div id="view-files" class="view-section hidden flex-1 p-4 md:p-6 overflow-y-auto bg-slate-50/50">
                <div class="flex flex-col h-full gap-4 max-w-4xl mx-auto">
                    <div onclick="document.getElementById('file-input').click()" class="border-2 border-dashed border-blue-300 rounded-[2rem] p-8 md:p-12 flex flex-col items-center justify-center bg-blue-50/50 hover:bg-blue-50 transition cursor-pointer group shrink-0">
                        <input type="file" id="file-input" multiple class="hidden">
                        <div class="w-16 h-16 bg-blue-600 text-white rounded-2xl flex items-center justify-center mb-4 group-hover:scale-110 group-active:scale-95 transition shadow-lg"><i class="fas fa-cloud-upload-alt text-2xl"></i></div>
                        <h3 class="font-black text-slate-800 text-lg">Tap to Upload Files</h3>
                    </div>
                    <div class="flex-1 bg-white border border-slate-200 rounded-[2rem] p-5 md:p-6 flex flex-col shadow-xl min-h-[300px]">
                        <div class="flex justify-between items-center pb-4 border-b border-slate-100">
                            <span class="text-xs font-black text-slate-400 uppercase tracking-widest">Transfer Activity</span>
                            <button onclick="document.getElementById('transfer-list').innerHTML=''" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:text-red-500 hover:bg-red-50 transition flex items-center justify-center"><i class="fas fa-trash"></i></button>
                        </div>
                        <div id="transfer-list" class="flex-1 overflow-y-auto space-y-2 py-3"></div>
                        <div class="pt-4 border-t border-slate-100 mt-auto">
                             <div class="flex justify-between text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2"><span id="current-file-name" class="truncate max-w-[70%]">System Idle</span><span id="current-percent" class="text-blue-600">0%</span></div>
                             <div class="h-2 w-full bg-slate-100 rounded-full overflow-hidden shadow-inner"><div id="main-progress" class="h-full bg-blue-600 w-0 transition-all duration-300 ease-out"></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CODE VIEW -->
            <div id="view-code" class="view-section hidden flex-1 flex flex-col h-full bg-white rounded-b-[2rem] md:rounded-bl-none overflow-hidden">
                <div id="code-container" class="flex-1 flex flex-col relative bg-white h-full">
                    <div class="h-14 bg-white border-b border-slate-200 flex items-center justify-between px-4 shrink-0 shadow-sm z-10">
                        <div class="flex items-center gap-3">
                            <select id="lang-select" onchange="changeLang()" class="bg-slate-50 text-slate-800 text-sm font-bold border border-slate-200 rounded-xl px-3 py-2 outline-none">
                                <option value="python">Python</option><option value="html">HTML</option><option value="sql">SQL</option>
                            </select>
                        </div>
                        <button onclick="runCode()" class="px-5 py-2 bg-slate-800 text-white text-xs font-bold rounded-xl hover:bg-slate-900 active:scale-95 transition shadow-lg flex items-center gap-2"><i class="fas fa-play"></i> RUN</button>
                    </div>
                    <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
                        <div id="editor" class="flex-1 text-sm md:w-3/5 border-b md:border-b-0 md:border-r border-slate-200">print("Hello Mitanshu!")</div>
                        <div class="h-2/5 md:h-full md:w-2/5 bg-slate-900 flex flex-col text-white">
                            <div class="bg-slate-800 px-4 py-2 text-[10px] font-black text-slate-400 uppercase tracking-widest border-b border-slate-700 flex justify-between items-center shrink-0"><span>Console</span><button onclick="document.getElementById('output-text').innerText=''" class="hover:text-red-400 transition"><i class="fas fa-ban"></i></button></div>
                            <div class="relative flex-1 overflow-hidden">
                                <div id="output-text" class="absolute inset-0 p-4 font-mono text-sm text-green-400 overflow-auto whitespace-pre-wrap"></div>
                                <iframe id="html-frame" class="absolute inset-0 w-full h-full bg-white hidden border-none"></iframe>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW 7: MULTI-GAME HUB -->
            <div id="view-games" class="view-section hidden flex-1 flex flex-col h-full bg-slate-50 rounded-b-[2rem] md:rounded-bl-none overflow-hidden">
                
                <!-- Game Tabs (Horizontal Scrollable) -->
                <div class="bg-white border-b border-slate-200 shrink-0">
                    <div class="flex overflow-x-auto gap-2 px-4 py-3 no-scrollbar snap-x items-center">
                        <button onclick="switchGameTab('rt')" id="tab-game-rt" class="snap-start shrink-0 px-4 py-2 rounded-xl text-sm font-black transition-all bg-blue-600 text-white shadow-md">Reaction Duel</button>
                        <button onclick="switchGameTab('ttt')" id="tab-game-ttt" class="snap-start shrink-0 px-4 py-2 rounded-xl text-sm font-black transition-all bg-slate-100 text-slate-500 hover:bg-slate-200">Zero Katta</button>
                        <button onclick="switchGameTab('rps')" id="tab-game-rps" class="snap-start shrink-0 px-4 py-2 rounded-xl text-sm font-black transition-all bg-slate-100 text-slate-500 hover:bg-slate-200">Stone Paper Scissor</button>
                        <button onclick="switchGameTab('tap')" id="tab-game-tap" class="snap-start shrink-0 px-4 py-2 rounded-xl text-sm font-black transition-all bg-slate-100 text-slate-500 hover:bg-slate-200">Tap War</button>
                    </div>
                </div>

                <div class="flex-1 p-4 md:p-8 overflow-y-auto">
                    <div class="max-w-xl mx-auto flex flex-col h-full gap-4">
                        
                        <!-- REACTION DUEL -->
                        <div id="g-area-rt" class="game-area flex flex-col gap-6 w-full pb-10">
                            <div class="text-center md:text-left">
                                <h2 class="text-3xl font-black tracking-tight text-slate-800 flex items-center justify-center md:justify-start gap-2"><i class="fas fa-bolt text-yellow-500"></i> Reaction Duel</h2>
                                <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mt-1">Real-time Reflex Testing</p>
                            </div>
                            <div class="bg-white border border-slate-200 rounded-[2rem] shadow-xl p-6 flex flex-col items-center w-full">
                                <div id="rt-status" class="mb-6 inline-block px-4 py-2 bg-slate-100 rounded-full text-xs font-black text-slate-500 uppercase tracking-widest">Connect to a peer</div>
                                <button id="rt-big" onclick="rtTap()" class="w-full max-w-[400px] aspect-[4/3] rounded-[3rem] border-4 border-slate-100 bg-slate-50 text-slate-400 font-black text-4xl shadow-inner active:scale-95 transition-all duration-100 flex items-center justify-center select-none outline-none">CONNECT</button>
                                <div class="w-full max-w-[400px] mt-8 grid grid-cols-2 gap-4">
                                    <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100 text-center"><div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Your Time</div><div id="rt-me" class="text-xl font-black text-blue-600 font-mono">-</div></div>
                                    <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100 text-center"><div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Peer Time</div><div id="rt-peer" class="text-xl font-black text-red-500 font-mono">-</div></div>
                                </div>
                                <div class="w-full max-w-[400px] mt-4 bg-slate-800 rounded-2xl p-4 text-center"><div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Result</div><div id="rt-winner" class="text-lg font-black text-white uppercase">-</div></div>
                            </div>
                        </div>

                        <!-- ZERO KATTA (Tic Tac Toe) -->
                        <div id="g-area-ttt" class="game-area hidden flex flex-col gap-6 w-full pb-10">
                            <div class="text-center md:text-left flex justify-between items-center">
                                <div>
                                    <h2 class="text-3xl font-black tracking-tight text-slate-800 flex items-center justify-center md:justify-start gap-2"><i class="fas fa-times text-blue-500"></i> Zero Katta</h2>
                                    <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mt-1">Classic Tic Tac Toe</p>
                                </div>
                                <button onclick="tttReset(true)" class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 active:scale-95 transition flex items-center justify-center"><i class="fas fa-rotate-right"></i></button>
                            </div>
                            <div class="bg-white border border-slate-200 rounded-[2rem] shadow-xl p-6 flex flex-col items-center w-full">
                                <div class="flex justify-between w-full max-w-[360px] mb-6">
                                    <div class="bg-blue-50 px-4 py-2 rounded-xl text-center"><div class="text-[10px] font-black text-blue-400 uppercase tracking-widest">You</div><div id="ttt-my-symbol" class="text-xl font-black text-blue-600">-</div></div>
                                    <div id="ttt-status" class="flex-1 mx-2 flex items-center justify-center text-xs font-black text-slate-500 uppercase tracking-widest text-center bg-slate-50 rounded-xl px-2">Connect to Peer</div>
                                    <div class="bg-red-50 px-4 py-2 rounded-xl text-center"><div class="text-[10px] font-black text-red-400 uppercase tracking-widest">Peer</div><div id="ttt-peer-symbol" class="text-xl font-black text-red-600">-</div></div>
                                </div>
                                <div class="grid grid-cols-3 gap-3 w-full max-w-[360px] aspect-square bg-slate-200 p-3 rounded-[2rem]">
                                    <button onclick="tttClick(0)" id="ttt-0" class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                    <button onclick="tttClick(1)" id="ttt-1" class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                    <button onclick="tttClick(2)" id="ttt-2" class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                    <button onclick="tttClick(3)" id="ttt-3" class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                    <button onclick="tttClick(4)" id="ttt-4" class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                    <button onclick="tttClick(5)" id="ttt-5" class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                    <button onclick="tttClick(6)" id="ttt-6" class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                    <button onclick="tttClick(7)" id="ttt-7" class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                    <button onclick="tttClick(8)" id="ttt-8" class="ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none"></button>
                                </div>
                            </div>
                        </div>

                        <!-- STONE PAPER SCISSOR (Anti-Cheat) -->
                        <div id="g-area-rps" class="game-area hidden flex flex-col gap-6 w-full pb-10">
                            <div class="text-center md:text-left flex justify-between items-center">
                                <div>
                                    <h2 class="text-3xl font-black tracking-tight text-slate-800 flex items-center justify-center md:justify-start gap-2"><i class="fas fa-hand-rock text-slate-600"></i> RPS Duel</h2>
                                    <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mt-1">Blind Pick Anti-Cheat</p>
                                </div>
                                <button onclick="rpsReset(true)" class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 active:scale-95 transition flex items-center justify-center"><i class="fas fa-rotate-right"></i></button>
                            </div>
                            <div class="bg-white border border-slate-200 rounded-[2rem] shadow-xl p-6 flex flex-col items-center w-full">
                                <div id="rps-status" class="mb-6 inline-block px-4 py-2 bg-slate-100 rounded-full text-xs font-black text-slate-500 uppercase tracking-widest text-center">Waiting to connect...</div>
                                
                                <div class="flex justify-between w-full max-w-[400px] mb-8 gap-4">
                                    <div class="flex-1 bg-slate-50 border border-slate-100 rounded-2xl p-4 text-center">
                                        <div class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-2">You</div>
                                        <div id="rps-me" class="text-4xl"><i class="fas fa-question text-slate-300"></i></div>
                                    </div>
                                    <div class="flex-1 bg-slate-50 border border-slate-100 rounded-2xl p-4 text-center">
                                        <div class="text-[10px] font-black text-red-400 uppercase tracking-widest mb-2">Peer</div>
                                        <div id="rps-peer" class="text-4xl"><i class="fas fa-question text-slate-300"></i></div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-3 gap-3 w-full max-w-[400px]">
                                    <button onclick="rpsPick('rock')" class="aspect-square bg-white border-2 border-slate-200 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-slate-50 hover:border-blue-400 active:scale-95 transition group">
                                        <i class="fas fa-hand-rock text-3xl text-slate-600 group-hover:text-blue-500 transition"></i><span class="text-xs font-black text-slate-500">STONE</span>
                                    </button>
                                    <button onclick="rpsPick('paper')" class="aspect-square bg-white border-2 border-slate-200 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-slate-50 hover:border-blue-400 active:scale-95 transition group">
                                        <i class="fas fa-hand-paper text-3xl text-slate-600 group-hover:text-blue-500 transition"></i><span class="text-xs font-black text-slate-500">PAPER</span>
                                    </button>
                                    <button onclick="rpsPick('scissors')" class="aspect-square bg-white border-2 border-slate-200 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-slate-50 hover:border-blue-400 active:scale-95 transition group">
                                        <i class="fas fa-hand-scissors text-3xl text-slate-600 group-hover:text-blue-500 transition"></i><span class="text-xs font-black text-slate-500">SCISSOR</span>
                                    </button>
                                </div>
                                <div id="rps-result" class="mt-6 w-full max-w-[400px] bg-slate-800 rounded-2xl p-4 text-center text-lg font-black text-white uppercase opacity-0 transition-opacity">WINNER</div>
                            </div>
                        </div>

                        <!-- TAP WAR -->
                        <div id="g-area-tap" class="game-area hidden flex flex-col gap-6 w-full pb-10">
                            <div class="text-center md:text-left flex justify-between items-center">
                                <div>
                                    <h2 class="text-3xl font-black tracking-tight text-slate-800 flex items-center justify-center md:justify-start gap-2"><i class="fas fa-fire text-orange-500"></i> Tap War</h2>
                                    <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mt-1">Mash to Pull The Rope</p>
                                </div>
                                <button onclick="tapReset(true)" class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 active:scale-95 transition flex items-center justify-center"><i class="fas fa-rotate-right"></i></button>
                            </div>
                            <div class="bg-white border border-slate-200 rounded-[2rem] shadow-xl p-6 flex flex-col items-center w-full">
                                <div id="tap-status" class="mb-4 inline-block px-4 py-2 bg-slate-100 rounded-full text-xs font-black text-slate-500 uppercase tracking-widest text-center">Connect to Play</div>
                                
                                <div class="w-full max-w-[400px] bg-slate-100 h-12 rounded-full overflow-hidden relative border border-slate-200 shadow-inner my-4">
                                    <div class="absolute inset-y-0 left-1/2 w-1 bg-slate-800 z-10 -translate-x-1/2"></div>
                                    <div id="tap-bar" class="h-full bg-gradient-to-r from-blue-500 to-blue-400 transition-all duration-100 ease-out" style="width: 50%;"></div>
                                </div>
                                
                                <div class="flex justify-between w-full max-w-[400px] mb-8 px-2">
                                    <span class="text-xs font-black text-blue-600 uppercase">You (<span id="tap-my-score">50</span>%)</span>
                                    <span class="text-xs font-black text-red-500 uppercase">Peer</span>
                                </div>

                                <button onclick="tapClick()" id="tap-btn" class="w-full max-w-[400px] aspect-[2/1] rounded-[2rem] border-b-[8px] border-blue-700 bg-blue-500 text-white font-black text-4xl shadow-xl active:border-b-0 active:translate-y-[8px] transition-all flex flex-col items-center justify-center select-none outline-none group">
                                    <i class="fas fa-hand-pointer mb-2 text-blue-200 group-active:scale-90 transition"></i>
                                    MASH TAP!
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- INCOMING CALL MODAL -->
    <div id="incoming-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-slate-900/80 backdrop-blur-md">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl flex flex-col items-center gap-6 max-w-sm w-full mx-4 animate-float border border-white/20">
            <div class="relative">
                <div class="absolute inset-0 bg-blue-400 rounded-full animate-ping opacity-20"></div>
                <div class="w-24 h-24 bg-blue-50 border border-blue-100 rounded-full flex items-center justify-center text-blue-600 shadow-inner relative z-10">
                    <i class="fas fa-phone-alt text-4xl animate-ring"></i>
                </div>
            </div>
            <div class="text-center">
                <h3 class="text-2xl font-black text-slate-800 tracking-tight">Incoming Call</h3>
                <p class="text-slate-500 text-sm mt-1 font-medium">Secure Peer Connection Request</p>
            </div>
            <div class="flex gap-3 w-full mt-2">
                <button onclick="rejectCall()" class="flex-1 py-3.5 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-red-50 hover:text-red-600 transition active:scale-95">DECLINE</button>
                <button onclick="acceptCall()" class="flex-1 py-3.5 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition active:scale-95">ACCEPT</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3.5 rounded-full shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-[300] flex items-center gap-3 text-xs font-bold whitespace-nowrap">
        <i class="fas fa-info-circle text-blue-400 text-base"></i> <span id="toast-msg">Notification</span>
    </div>

    <script>
        // --- CORE SYSTEM ---
        const SYS = {
            peer: null, conn: null, call: null, localStream: null,
            editor: null, map: null, pyodide: null,
            myId: null, targetId: null, remotePeerId: null, 
            isMicMuted: false, pendingCall: null,
            // GAMING HUB STATE
            activeGame: 'rt',
            games: {
                rt: { state: 'idle', goAt: null, myTime: null, peerTime: null, winner: null, timer: null },
                ttt: { board: Array(9).fill(''), turn: 'X', over: false, winner: null },
                rps: { state: 'idle', myPick: null, peerReady: false, peerPick: null, result: null },
                tap: { state: 'idle', score: 50, over: false }
            }
        };

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('peer')) {
                SYS.targetId = urlParams.get('peer');
                document.getElementById('remote-id').value = SYS.targetId;
                document.getElementById('auto-connect-msg').classList.remove('hidden');
            }
            initPeer();
            initUI();
            setTimeout(() => initEditor(), 800);
            setTimeout(() => loadPython(), 2000);
        };

        // --- NETWORK ---
        function initPeer() {
            SYS.peer = new Peer();
            SYS.peer.on('open', id => {
                SYS.myId = id;
                document.getElementById('my-id').innerText = id;
                updateStatus('ONLINE', 'emerald');
                if(SYS.targetId) { showToast("Found Link. Connecting..."); connectToPeer(SYS.targetId); }
                gamesInitUI();
            });
            SYS.peer.on('connection', c => {
                SYS.conn = c; SYS.remotePeerId = c.peer; 
                document.getElementById('remote-id').value = c.peer; 
                setupDataLink(); showToast("Peer Connected Successfully");
            });
            SYS.peer.on('call', call => {
                SYS.pendingCall = call; SYS.remotePeerId = call.peer; 
                document.getElementById('incoming-modal').classList.remove('hidden');
            });
            SYS.peer.on('error', err => { console.error(err); showToast("Network Error: " + err.type); });
        }

        function connectToPeer(idOverride = null) {
            const id = idOverride || document.getElementById('remote-id').value.trim();
            if(!id) return showToast("Enter Peer ID");
            if(SYS.conn) SYS.conn.close(); 
            showToast("Connecting...");
            const conn = SYS.peer.connect(id);
            conn.on('open', () => {
                SYS.conn = conn; SYS.remotePeerId = id; setupDataLink();
                showToast("Connected Securely");
                document.getElementById('auto-connect-msg').classList.add('hidden');
                switchTab('chat'); 
            });
            conn.on('error', err => showToast("Connection Failed"));
        }

        function setupDataLink() {
            updateStatus('LINKED', 'blue');
            startPingLoop();
            SYS.conn.on('data', data => {
                if(data.type === 'PING') SYS.conn.send({type: 'PONG', ts: data.ts});
                else if(data.type === 'PONG') measureLatency(data.ts);
                else if(data.type === 'CHAT') addChat(data.msg, false);
                else if(data.type === 'CODE') syncCode(data);
                else if(data.type === 'GPS') updateMapMarker(data);
                else if(data.type === 'FILE_CHUNK') receiveChunk(data);
                else if(data.type === 'FILE_START') startFileReceive(data);
                else if(data.type === 'FILE_END') finishFileReceive();
                else if(data.type === 'GAME') handleGameMessage(data);
            });
            SYS.conn.on('close', () => {
                updateStatus('OFFLINE', 'red'); showToast("Peer Disconnected");
                SYS.remotePeerId = null; gamesInitUI(); 
            });
            gamesInitUI(); 
        }

        function gameSend(payload) {
            if(!SYS.conn || !SYS.conn.open) return showToast("Connect First");
            SYS.conn.send({type:'GAME', ...payload});
        }

        function handleGameMessage(d) {
            // Check if game tab needs auto-switch for seamless experience
            if(SYS.activeGame !== d.game) switchGameTab(d.game);

            // RT
            if(d.game === 'rt') {
                if(d.action === 'RESET') rtReset(false);
                else if(d.action === 'START') rtStartLocal(d.delayMs);
                else if(d.action === 'GO') rtGoLocal();
                else if(d.action === 'TAP') { SYS.games.rt.peerTime = d.ms; rtComputeWinner(); }
            }
            // TTT
            else if(d.game === 'ttt') {
                if(d.action === 'RESET') tttReset(false);
                else if(d.action === 'MOVE') tttApplyMove(d.idx, false);
            }
            // RPS (Anti Cheat)
            else if(d.game === 'rps') {
                if(d.action === 'RESET') rpsReset(false);
                else if(d.action === 'READY') {
                    SYS.games.rps.peerReady = true;
                    rpsUpdateUI();
                    if(SYS.games.rps.myPick) gameSend({game:'rps', action:'REVEAL', pick: SYS.games.rps.myPick});
                }
                else if(d.action === 'REVEAL') {
                    SYS.games.rps.peerPick = d.pick;
                    if(!SYS.games.rps.myPick) {
                        // Peer revealed too early? (Shouldn't happen with strict logic)
                    } else {
                        rpsCompute();
                    }
                }
            }
            // TAP WAR
            else if(d.game === 'tap') {
                if(d.action === 'RESET') tapReset(false);
                else if(d.action === 'PULL') tapApplyPeerPull();
            }
        }

        function gamesIsHost() { return String(SYS.myId) < String(SYS.remotePeerId); }

        // --- MULTI-GAME UI NAVIGATION ---
        function switchGameTab(gameId) {
            SYS.activeGame = gameId;
            const tabs = ['rt', 'ttt', 'rps', 'tap'];
            tabs.forEach(t => {
                const btn = document.getElementById('tab-game-' + t);
                const area = document.getElementById('g-area-' + t);
                if(area) area.classList.add('hidden');
                if(btn) {
                    btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                    btn.classList.add('bg-slate-100', 'text-slate-500');
                }
            });
            document.getElementById('g-area-' + gameId).classList.remove('hidden');
            document.getElementById('tab-game-' + gameId).classList.remove('bg-slate-100', 'text-slate-500');
            document.getElementById('tab-game-' + gameId).classList.add('bg-blue-600', 'text-white', 'shadow-md');
            
            // Re-render current
            if(gameId==='ttt') tttRender();
            if(gameId==='rps') rpsUpdateUI();
            if(gameId==='tap') tapUpdateUI();
            if(gameId==='rt') rtUpdateUI();
        }

        function gamesInitUI() {
            rtUpdateUI();
            tttRender();
            rpsUpdateUI();
            tapUpdateUI();
        }

        // --- GAME 1: REACTION DUEL ---
        function rtSetStatus(txt) { document.getElementById('rt-status').innerText = txt; }
        function rtUpdateUI() {
            const s = SYS.games.rt, btn = document.getElementById('rt-big');
            document.getElementById('rt-me').innerText = s.myTime != null ? `${Math.round(s.myTime)} ms` : '-';
            document.getElementById('rt-peer').innerText = s.peerTime != null ? `${Math.round(s.peerTime)} ms` : '-';
            const win = document.getElementById('rt-winner');
            win.innerText = s.winner || '-';
            win.className = `text-lg font-black uppercase ${s.winner==='You'?'text-emerald-400':s.winner==='Peer'?'text-red-400':'text-white'}`;
            
            const r = () => { btn.className = "w-full max-w-[400px] aspect-[4/3] rounded-[3rem] border-4 shadow-inner active:scale-95 transition-all duration-100 flex items-center justify-center select-none outline-none font-black text-4xl"; };
            if(!SYS.remotePeerId) { r(); btn.classList.add('bg-slate-50','border-slate-100','text-slate-400'); btn.innerText='CONNECT'; rtSetStatus('Connect to a peer to play.'); return; }
            if(s.state === 'idle') { r(); btn.classList.add('bg-blue-600','border-blue-700','text-white','shadow-blue-900/50'); btn.innerText='START DUEL'; rtSetStatus('Tap START to begin.'); }
            else if(s.state === 'waiting') { r(); btn.classList.add('bg-red-500','border-red-600','text-white','shadow-red-900/50'); btn.innerText='WAIT...'; rtSetStatus('Wait for GREEN!'); }
            else if(s.state === 'go') { r(); btn.classList.add('bg-emerald-500','border-emerald-600','text-white','shadow-emerald-900/50','text-5xl'); btn.innerText='TAP NOW!'; rtSetStatus('FAST!!!'); }
            else if(s.state === 'done') { r(); btn.classList.add('bg-slate-800','border-slate-900','text-white'); btn.innerText='PLAY AGAIN'; rtSetStatus('Round Over.'); }
        }
        function rtReset(sync) {
            const s = SYS.games.rt; if(s.timer) clearTimeout(s.timer);
            SYS.games.rt = { state: 'idle', goAt: null, myTime: null, peerTime: null, winner: null, timer: null };
            rtUpdateUI(); if(sync) gameSend({game:'rt', action:'RESET'});
        }
        function rtStartLocal(delayMs) {
            const s = SYS.games.rt; if(s.timer) clearTimeout(s.timer);
            s.state = 'waiting'; s.goAt=null; s.myTime=null; s.peerTime=null; s.winner=null; rtUpdateUI();
            s.timer = setTimeout(() => { if(gamesIsHost()) gameSend({game:'rt', action:'GO'}); rtGoLocal(); }, delayMs);
        }
        function rtStartRound() {
            if(!SYS.remotePeerId) return showToast('Link peer first');
            const delayMs = 1500 + Math.floor(Math.random() * 3000);
            rtStartLocal(delayMs); gameSend({game:'rt', action:'START', delayMs});
            try{navigator.vibrate(30);}catch(e){}
        }
        function rtGoLocal() {
            const s = SYS.games.rt; if(s.timer) clearTimeout(s.timer);
            s.state = 'go'; s.goAt = performance.now(); try{navigator.vibrate([100,50,100]);}catch(e){} rtUpdateUI();
        }
        function rtTap() {
            const s = SYS.games.rt; if(!SYS.remotePeerId) return showToast('Link peer first');
            try{navigator.vibrate(20);}catch(e){}
            if(s.state === 'idle' || s.state === 'done') return rtStartRound();
            if(s.state === 'waiting') { showToast('Too early!'); try{navigator.vibrate([200]);}catch(e){} return; }
            if(s.state !== 'go') return;
            s.myTime = performance.now() - s.goAt; s.state = 'done';
            gameSend({game:'rt', action:'TAP', ms: s.myTime}); rtComputeWinner();
        }
        function rtComputeWinner() {
            const s = SYS.games.rt; if(s.myTime == null || s.peerTime == null) return rtUpdateUI();
            if(Math.abs(s.myTime - s.peerTime) < 1) s.winner = 'Draw';
            else if(s.myTime < s.peerTime) { s.winner = 'You'; try{navigator.vibrate([50,50,50,50,150]);}catch(e){} }
            else { s.winner = 'Peer'; try{navigator.vibrate([300]);}catch(e){} }
            s.state = 'done'; rtUpdateUI();
        }

        // --- GAME 2: ZERO KATTA (Tic Tac Toe) ---
        function tttStatus(txt, alert=false) { 
            const e = document.getElementById('ttt-status'); e.innerText = txt; 
            e.className = alert ? "flex-1 mx-2 flex items-center justify-center text-xs font-black text-red-500 uppercase tracking-widest text-center bg-red-50 rounded-xl px-2" : "flex-1 mx-2 flex items-center justify-center text-xs font-black text-slate-500 uppercase tracking-widest text-center bg-slate-50 rounded-xl px-2";
        }
        function tttRender() {
            const s = SYS.games.ttt;
            const mySym = gamesIsHost() ? 'X' : 'O';
            const peerSym = mySym === 'X' ? 'O' : 'X';
            document.getElementById('ttt-my-symbol').innerText = mySym;
            document.getElementById('ttt-my-symbol').className = mySym==='X'?'text-xl font-black text-blue-600':'text-xl font-black text-red-600';
            document.getElementById('ttt-peer-symbol').innerText = peerSym;
            document.getElementById('ttt-peer-symbol').className = peerSym==='X'?'text-xl font-black text-blue-600':'text-xl font-black text-red-600';

            for(let i=0;i<9;i++) {
                const b = document.getElementById('ttt-'+i);
                b.innerText = s.board[i];
                b.className = `ttt-cell bg-white rounded-2xl text-5xl font-black flex items-center justify-center shadow-sm select-none ${s.board[i]==='X'?'text-blue-500':s.board[i]==='O'?'text-red-500':''}`;
            }
            if(!SYS.remotePeerId) return tttStatus('Connect to Play');
            if(s.over) {
                if(s.winner === 'D') tttStatus('Draw! Reset to play.');
                else if(s.winner === mySym) tttStatus('You Won! ', true);
                else tttStatus('Peer Won! ', true);
            } else {
                tttStatus(s.turn === mySym ? 'Your Turn' : "Peer's Turn");
            }
        }
        function tttCheckWin(b) {
            const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for(const [x,y,z] of lines) if(b[x] && b[x]===b[y] && b[x]===b[z]) return b[x];
            return b.every(c=>c) ? 'D' : null;
        }
        function tttApplyMove(idx, isMe) {
            const s = SYS.games.ttt; if(s.over || s.board[idx]) return;
            s.board[idx] = s.turn;
            const w = tttCheckWin(s.board);
            if(w) { s.over=true; s.winner=w; try{navigator.vibrate([100,100,100]);}catch(e){} }
            else s.turn = s.turn==='X'?'O':'X';
            tttRender();
        }
        function tttClick(idx) {
            if(!SYS.remotePeerId) return showToast('Connect First');
            const s = SYS.games.ttt, mySym = gamesIsHost() ? 'X' : 'O';
            if(s.over || s.board[idx] || s.turn !== mySym) return;
            try{navigator.vibrate(20);}catch(e){}
            tttApplyMove(idx, true); gameSend({game:'ttt', action:'MOVE', idx});
        }
        function tttReset(sync) {
            SYS.games.ttt = { board: Array(9).fill(''), turn: 'X', over: false, winner: null };
            tttRender(); if(sync) gameSend({game:'ttt', action:'RESET'});
        }

        // --- GAME 3: STONE PAPER SCISSOR (Blind Pick) ---
        function rpsStatus(txt) { document.getElementById('rps-status').innerText = txt; }
        function rpsUpdateUI() {
            const s = SYS.games.rps;
            const iconMap = { 'rock': 'fa-hand-rock', 'paper': 'fa-hand-paper', 'scissors': 'fa-hand-scissors' };
            const meEl = document.getElementById('rps-me'), peerEl = document.getElementById('rps-peer'), resEl = document.getElementById('rps-result');
            
            if(!SYS.remotePeerId) return rpsStatus('Waiting to connect...');
            
            // Me
            if(s.myPick) meEl.innerHTML = `<i class="fas ${iconMap[s.myPick]} text-blue-500"></i>`;
            else meEl.innerHTML = `<i class="fas fa-question text-slate-300"></i>`;
            
            // Peer
            if(s.result) peerEl.innerHTML = `<i class="fas ${iconMap[s.peerPick]} text-red-500"></i>`;
            else if(s.peerReady) peerEl.innerHTML = `<i class="fas fa-check-circle text-emerald-500"></i>`; // Hidden pick
            else peerEl.innerHTML = `<i class="fas fa-question text-slate-300"></i>`;
            
            // State
            if(s.state === 'idle') { rpsStatus('Pick your move!'); resEl.classList.add('opacity-0'); }
            else if(s.state === 'waiting') rpsStatus('Waiting for peer...');
            else if(s.state === 'done') {
                rpsStatus('Round Complete');
                resEl.classList.remove('opacity-0');
                if(s.result === 'Draw') { resEl.innerText = 'DRAW'; resEl.className = 'mt-6 w-full max-w-[400px] bg-slate-400 rounded-2xl p-4 text-center text-lg font-black text-white uppercase transition-opacity'; }
                else if(s.result === 'Win') { resEl.innerText = 'YOU WIN!'; resEl.className = 'mt-6 w-full max-w-[400px] bg-emerald-500 rounded-2xl p-4 text-center text-lg font-black text-white uppercase transition-opacity shadow-lg shadow-emerald-200'; try{navigator.vibrate([50,50,50,150]);}catch(e){} }
                else { resEl.innerText = 'PEER WINS'; resEl.className = 'mt-6 w-full max-w-[400px] bg-red-500 rounded-2xl p-4 text-center text-lg font-black text-white uppercase transition-opacity shadow-lg shadow-red-200'; try{navigator.vibrate([200]);}catch(e){} }
            }
        }
        function rpsPick(pick) {
            const s = SYS.games.rps;
            if(!SYS.remotePeerId) return showToast('Connect First');
            if(s.state === 'done') return showToast('Reset round first');
            if(s.myPick) return; // Already picked
            
            try{navigator.vibrate(20);}catch(e){}
            s.myPick = pick;
            s.state = 'waiting';
            gameSend({game:'rps', action:'READY'});
            rpsUpdateUI();

            // Auto-reveal if peer is already ready
            if(s.peerReady) {
                gameSend({game:'rps', action:'REVEAL', pick: pick});
                if(s.peerPick) rpsCompute(); // If they somehow revealed early
            }
        }
        function rpsCompute() {
            const s = SYS.games.rps;
            if(!s.myPick || !s.peerPick) return;
            const a = s.myPick, b = s.peerPick;
            if(a === b) s.result = 'Draw';
            else if((a==='rock' && b==='scissors') || (a==='paper' && b==='rock') || (a==='scissors' && b==='paper')) s.result = 'Win';
            else s.result = 'Lose';
            s.state = 'done';
            rpsUpdateUI();
        }
        function rpsReset(sync) {
            SYS.games.rps = { state: 'idle', myPick: null, peerReady: false, peerPick: null, result: null };
            rpsUpdateUI(); if(sync) gameSend({game:'rps', action:'RESET'});
        }

        // --- GAME 4: TAP WAR ---
        function tapStatus(txt) { document.getElementById('tap-status').innerText = txt; }
        function tapUpdateUI() {
            const s = SYS.games.tap, bar = document.getElementById('tap-bar'), scoreEl = document.getElementById('tap-my-score'), btn = document.getElementById('tap-btn');
            if(!SYS.remotePeerId) return tapStatus('Connect to Play');
            
            bar.style.width = s.score + '%';
            scoreEl.innerText = s.score;
            
            if(s.over) {
                btn.classList.add('opacity-50', 'pointer-events-none');
                if(s.score >= 100) tapStatus('YOU DOMINATED! ');
                else tapStatus('YOU LOST. GET FASTER. ');
            } else {
                btn.classList.remove('opacity-50', 'pointer-events-none');
                tapStatus('PULL THE ROPE!');
            }
        }
        function tapClick() {
            const s = SYS.games.tap;
            if(!SYS.remotePeerId || s.over) return;
            s.score += 2; // Pull force
            if(s.score >= 100) { s.score = 100; s.over = true; try{navigator.vibrate([100,50,100,50,200]);}catch(e){} }
            else try{navigator.vibrate(10);}catch(e){}
            tapUpdateUI();
            gameSend({game:'tap', action:'PULL'});
        }
        function tapApplyPeerPull() {
            const s = SYS.games.tap;
            if(s.over) return;
            s.score -= 2; // Peer pulls
            if(s.score <= 0) { s.score = 0; s.over = true; try{navigator.vibrate([300]);}catch(e){} }
            tapUpdateUI();
        }
        function tapReset(sync) {
            SYS.games.tap = { state: 'idle', score: 50, over: false };
            tapUpdateUI(); if(sync) gameSend({game:'tap', action:'RESET'});
        }


        // --- CALLS & MEDIA ---
        function acceptCall() {
            document.getElementById('incoming-modal').classList.add('hidden');
            if(!SYS.pendingCall) return;
            navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(stream => {
                SYS.localStream = stream; document.getElementById('local-video').srcObject = stream;
                SYS.pendingCall.answer(stream); handleStream(SYS.pendingCall); switchTab('video');
            }).catch(e => { showToast("Mic/Cam Error: " + e.message); console.error(e); });
        }
        async function startCall(type) {
            const target = SYS.remotePeerId || document.getElementById('remote-id').value;
            if(!target) return showToast("No Peer Linked");
            try {
                let s;
                if(type === 'screen') s = await navigator.mediaDevices.getDisplayMedia({video: { cursor: "always" }, audio: true});
                else s = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                SYS.localStream = s; document.getElementById('local-video').srcObject = s;
                const call = SYS.peer.call(target, s); handleStream(call); switchTab('video');
                if(type === 'screen') s.getVideoTracks()[0].onended = () => { endCall(); showToast("Screen Share Ended"); };
            } catch(e) { console.error(e); showToast("Media Error: " + e.message); }
        }
        function handleStream(call) {
            SYS.call = call; document.getElementById('call-placeholder').classList.add('hidden');
            call.on('stream', remoteStream => {
                const vid = document.getElementById('remote-video');
                vid.srcObject = remoteStream; vid.play().catch(e => console.log("Auto-play blocked", e));
            });
            call.on('close', endCall); call.on('error', e => showToast("Call Error"));
        }
        function endCall() {
            if(SYS.call) SYS.call.close();
            if(SYS.localStream) SYS.localStream.getTracks().forEach(t=>t.stop());
            document.getElementById('remote-video').srcObject=null; document.getElementById('local-video').srcObject=null;
            document.getElementById('call-placeholder').classList.remove('hidden');
        }
        function rejectCall() { document.getElementById('incoming-modal').classList.add('hidden'); if(SYS.pendingCall) SYS.pendingCall.close(); SYS.pendingCall = null; }
        function toggleMic() {
            if(SYS.localStream) {
                const track = SYS.localStream.getAudioTracks()[0];
                if(track) { 
                    track.enabled = !track.enabled; SYS.isMicMuted = !track.enabled; 
                    const btn = document.getElementById('btn-mic');
                    if(SYS.isMicMuted) { btn.classList.add('bg-red-500'); btn.classList.remove('bg-slate-700'); btn.innerHTML = '<i class="fas fa-microphone-slash text-lg"></i>'; }
                    else { btn.classList.remove('bg-red-500'); btn.classList.add('bg-slate-700'); btn.innerHTML = '<i class="fas fa-microphone text-lg"></i>'; }
                }
            }
        }

        // --- UTILS ---
        function copyMyLink() {
            if (!SYS.myId) return showToast("Bhai pehle ID toh banne de!");
            const baseUrl = window.location.origin + window.location.pathname;
            const shareableUrl = `${baseUrl}?peer=${SYS.myId}`;
            if (navigator.share) { navigator.share({ title: 'Mitanshu P2P Enterprise', text: 'Join my secure P2P network session:', url: shareableUrl }).catch(err => { fallbackCopyTextToClipboard(shareableUrl); }); }
            else { fallbackCopyTextToClipboard(shareableUrl); }
        }
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea"); textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.opacity = "0";
            document.body.appendChild(textArea); textArea.focus(); textArea.select(); textArea.setSelectionRange(0, 99999);
            try { const successful = document.execCommand('copy'); if(successful) showToast("Link Copied! Bhejde dosto ko."); else throw new Error('Copy command failed'); }
            catch (err) { window.prompt("Copy this link manually:", text); }
            document.body.removeChild(textArea);
        }
        function showToast(msg) {
            const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            try { if(navigator.vibrate) navigator.vibrate(30); } catch(e){}
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }
        function updateStatus(txt, color) {
            const el = document.getElementById('connection-status');
            const colors = { emerald: 'text-emerald-600 bg-emerald-50 border-emerald-100', red: 'text-red-600 bg-red-50 border-red-100', blue: 'text-blue-600 bg-blue-50 border-blue-100' };
            el.className = `flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold font-mono transition-all ${colors[color]}`;
            el.innerHTML = `<span class="w-2 h-2 rounded-full bg-${color}-500 animate-pulse"></span> ${txt}`;
        }

        // --- NAVIGATION ---
        function switchTab(id) {
            const views = ['dashboard', 'chat', 'video', 'map', 'files', 'code', 'games'];
            views.forEach(v => { const el = document.getElementById('view-' + v); if(el) el.classList.add('hidden'); });
            const targetView = document.getElementById('view-' + id); if(targetView) targetView.classList.remove('hidden');
            views.forEach(v => {
                const btn = document.getElementById('nav-' + v);
                if(btn) { btn.classList.remove('bg-blue-600', 'text-white', 'shadow-lg'); btn.classList.add('text-slate-400', 'hover:bg-slate-100'); }
            });
            const activeBtn = document.getElementById('nav-' + id);
            if(activeBtn) { activeBtn.classList.remove('text-slate-400', 'hover:bg-slate-100'); activeBtn.classList.add('bg-blue-600', 'text-white', 'shadow-lg'); }
            if(id === 'code' && SYS.editor) setTimeout(() => SYS.editor.resize(), 100);
            if(id === 'map' && SYS.map) setTimeout(() => SYS.map.invalidateSize(), 300);
            if(id === 'games') setTimeout(() => gamesInitUI(), 50);
            toggleMobileNav(false);
        }
        function toggleMobileNav(open) {
            const el = document.getElementById('mobile-nav'); if(!el) return;
            if(open) el.classList.remove('hidden'); else el.classList.add('hidden');
        }

        // --- EXTRA LOGIC ---
        function startPingLoop() { setInterval(() => { if(SYS.conn && SYS.conn.open) SYS.conn.send({type: 'PING', ts: Date.now()}); }, 5000); }
        function measureLatency(startTs) { const lat = Math.round((Date.now() - startTs) / 2); document.getElementById('ping-indicator').innerText = lat + 'ms'; document.getElementById('ping-indicator').classList.remove('hidden'); document.getElementById('ping-mobile').innerText = lat + 'ms'; }
        function sendMsg() { const inp = document.getElementById('chat-input'); const msg = inp.value.trim(); if(!msg || !SYS.conn) return; SYS.conn.send({type:'CHAT', msg:msg}); addChat(msg, true); inp.value = ''; }
        function addChat(msg, isMe) {
            const box = document.getElementById('chat-container'); const d = document.createElement('div');
            d.className = `flex ${isMe ? 'justify-end' : 'justify-start'} animate-[fadeIn_0.2s]`;
            d.innerHTML = `<div class="max-w-[85%] md:max-w-[70%] px-4 py-2.5 rounded-2xl text-sm shadow-sm ${isMe ? 'bg-blue-600 text-white rounded-tr-sm' : 'bg-white border border-slate-200 text-slate-700 rounded-tl-sm'}">${msg}</div>`;
            box.appendChild(d); box.scrollTop = box.scrollHeight;
            if(!isMe && document.getElementById('view-chat').classList.contains('hidden')) showToast("New Secure Message");
        }
        function broadcastLocation() {
            if(!navigator.geolocation) return showToast("No GPS Support");
            navigator.geolocation.getCurrentPosition(p => {
                const {latitude:lat, longitude:lng} = p.coords;
                if(!SYS.map) { SYS.map = L.map('map').setView([lat, lng], 15); L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {maxZoom: 19}).addTo(SYS.map); } 
                else { SYS.map.setView([lat, lng], 15); }
                if(SYS.markers && SYS.markers.me) SYS.map.removeLayer(SYS.markers.me);
                SYS.markers = { me: L.marker([lat,lng]).addTo(SYS.map).bindPopup("ME").openPopup() };
                if(SYS.conn) SYS.conn.send({type:'GPS', lat:lat, lng:lng}); showToast("Location Broadcasted!");
            });
        }
        function updateMapMarker(d) {
            if(!SYS.map) { SYS.map = L.map('map').setView([d.lat, d.lng], 15); L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {maxZoom: 19}).addTo(SYS.map); }
            if(SYS.markers && SYS.markers.peer) SYS.map.removeLayer(SYS.markers.peer);
            const peerIcon = L.divIcon({ className: 'custom-div-icon', html: "<div style='background-color:#ef4444; width:16px; height:16px; border-radius:50%; box-shadow:0 0 10px #ef4444; border:2px solid white;'></div>", iconSize: [16, 16] });
            SYS.markers.peer = L.marker([d.lat,d.lng], {icon: peerIcon}).addTo(SYS.map).bindPopup("PEER").openPopup();
            SYS.map.setView([d.lat, d.lng], 15); showToast("Peer Location Synced");
        }

        let fBuffer=[], fMeta=null;
        document.getElementById('file-input').onchange = async (e) => {
            if(!SYS.conn) return showToast("Connect First");
            for(let f of e.target.files) {
                SYS.conn.send({type:'FILE_START', name:f.name, mime:f.type, size:f.size});
                const buf = await f.arrayBuffer(); const chunkSz = 16384; 
                for(let i=0; i<buf.byteLength; i+=chunkSz) {
                    SYS.conn.send({type:'FILE_CHUNK', data:buf.slice(i, i+chunkSz)});
                    if(i%100===0) await new Promise(r=>setTimeout(r,1)); updateProgress((i/buf.byteLength)*100, f.name);
                }
                SYS.conn.send({type:'FILE_END'}); addToLog(f.name, 'out');
            }
        };
        function startFileReceive(m) { fBuffer=[]; fMeta=m; updateProgress(0, m.name); }
        function receiveChunk(d) { fBuffer.push(d.data); updateProgress(50, fMeta.name); }
        function finishFileReceive() {
            const blob = new Blob(fBuffer, {type:fMeta.mime}); const url = URL.createObjectURL(blob);
            addToLog(fMeta.name, 'in', url); updateProgress(100, "Transfer Complete"); fBuffer=[]; try{navigator.vibrate([100,50,100]);}catch(e){}
        }
        function updateProgress(pct, txt) { document.getElementById('current-percent').innerText = Math.round(pct)+'%'; document.getElementById('current-file-name').innerText = txt; document.getElementById('main-progress').style.width = pct+'%'; }
        function addToLog(name, type, url=null) {
            const list = document.getElementById('transfer-list'), d = document.createElement('div');
            d.className = "flex items-center gap-3 p-3 rounded-xl bg-slate-50 border border-slate-100 text-sm text-slate-700 font-medium";
            d.innerHTML = `<div class="w-8 h-8 rounded-full flex items-center justify-center ${type==='out' ? 'bg-blue-100 text-blue-600' : 'bg-emerald-100 text-emerald-600'}"><i class="fas ${type==='out' ? 'fa-arrow-up' : 'fa-arrow-down'}"></i></div><span class="flex-1 truncate">${name}</span>${url ? `<a href="${url}" download="${name}" class="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700 shadow-md">SAVE</a>` : '<span class="text-slate-400 text-xs font-bold">SENT</span>'}`;
            list.prepend(d);
        }
        
        function initEditor() { SYS.editor = ace.edit("editor"); SYS.editor.setTheme("ace/theme/chrome"); SYS.editor.session.setMode("ace/mode/python"); SYS.editor.setOptions({fontSize: "14px", fontFamily: "JetBrains Mono", showPrintMargin: false, wrap: true}); SYS.editor.on('change', () => { if(SYS.conn && !SYS.remoteEdit) SYS.conn.send({type:'CODE', val:SYS.editor.getValue(), lang:document.getElementById('lang-select').value}); }); }
        function syncCode(d) { SYS.remoteEdit=true; if(document.getElementById('lang-select').value!==d.lang) { document.getElementById('lang-select').value=d.lang; changeLang(); } SYS.editor.setValue(d.val, 1); SYS.remoteEdit=false; }
        function changeLang() { SYS.editor.session.setMode("ace/mode/"+document.getElementById('lang-select').value); }
        async function loadPython() { try{ SYS.pyodide = await loadPyodide(); }catch(e){} }
        async function runCode() {
            const lang = document.getElementById('lang-select').value, code = SYS.editor.getValue(), out = document.getElementById('output-text'), frame = document.getElementById('html-frame');
            if(lang==='html') { out.style.display='none'; frame.style.display='block'; frame.srcdoc=code; }
            else {
                frame.style.display='none'; out.style.display='block'; out.innerText="Executing Engine...";
                if(lang==='python' && SYS.pyodide) { try { SYS.pyodide.runPython(`import sys; from io import StringIO; sys.stdout = StringIO()`); await SYS.pyodide.runPythonAsync(code); out.innerText = SYS.pyodide.runPython("sys.stdout.getvalue()"); } catch(e) { out.innerText = e; } } 
                else if(lang==='sql') { try { out.innerText = JSON.stringify(alasql(code), null, 2); } catch(e) { out.innerText=e; } }
            }
        }
        function initUI() { const drop = document.body; drop.addEventListener('dragover', e=>e.preventDefault()); drop.addEventListener('drop', e=>{ e.preventDefault(); switchTab('files'); }); }
    </script>
</body>
</html>